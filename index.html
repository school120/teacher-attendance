<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
<title>Guard Booth Attendance Kiosk</title>

<style>
/* --- simplified clean styles (fast rendering) --- */
html,body{margin:0;padding:0;height:100%;background:#f5f5f7;font-family:system-ui;}
body.dark{background:#0b1020;color:#fff;}
.wrap{max-width:960px;margin:auto;padding:20px;}
h1{text-align:center;font-size:32px;margin:0 0 6px;}
.muted{color:#666;text-align:center;}
.segment{display:flex;gap:10px;margin:16px 0;}
.segment button{flex:1;padding:22px;font-size:38px;border-radius:14px;border:2px solid #ccc;font-weight:700;cursor:pointer;}
.segment button.active#actIn{background:#16a34a;color:#fff;border-color:#16a34a;}
.segment button.active#actOut{background:#dc2626;color:#fff;border-color:#dc2626;}
.card{border:1px solid #ddd;border-radius:12px;padding:14px;margin-bottom:16px;background:#fff;}
input{width:100%;padding:18px;font-size:22px;border-radius:10px;border:1.5px solid #999;}
.list{max-height:420px;overflow:auto;margin-top:12px;display:grid;gap:10px;}
.row{display:flex;justify-content:space-between;align-items:center;padding:14px;border:1px solid #ccc;border-radius:10px;background:#fafafa;}
.name{font-size:20px;font-weight:700;}
.actionBtn{padding:12px 18px;font-size:18px;border-radius:10px;border:none;background:#2563eb;color:#fff;font-weight:700;cursor:pointer;}
.badges{position:absolute;top:14px;right:14px;display:flex;gap:8px;}
.badge{padding:6px 10px;border-radius:10px;border:1px solid #ccc;background:#fff;font-weight:700;font-size:12px;}
#rosterStatus.badge{cursor:default;}
.toast{position:fixed;left:50%;bottom:30px;transform:translateX(-50%) translateY(20px);opacity:0;padding:18px 24px;background:#fff;border:1px solid #ccc;border-radius:14px;box-shadow:0 8px 20px rgba(0,0,0,.15);font-size:20px;font-weight:800;transition:.25s;z-index:999;}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}
.toast.ok{color:#0a7a44;}
.toast.err{color:#b60000;}
</style>
</head>

<body>
<div class="wrap">

<div class="badges">
  <div id="netBadge" class="badge">Online</div>
  <div id="rosterStatus" class="badge">‚è≥ Roster‚Ä¶</div>
  <button id="themeBtn" class="badge">üåô</button>
</div>

<h1>Guard Booth Attendance Kiosk</h1>
<p class="muted">Select IN/OUT ‚Üí swipe card or search name</p>

<div class="segment">
  <button id="actIn" class="active">IN</button>
  <button id="actOut">OUT</button>
</div>

<div class="card">
  <h2>Cougar Card</h2>
  <input id="pin" type="password" placeholder="Tap or swipe‚Ä¶">
</div>

<div class="card">
  <h2>Lookup by Name</h2>
  <input id="q" type="search" placeholder="Search students or faculty‚Ä¶">
  <div id="results" class="list"></div>
</div>

<div id="toast" class="toast"></div>

</div>

<script>
/***********************************************************
 * CONFIG
 ***********************************************************/
const ENDPOINT = "https://script.google.com/macros/s/AKfycbzF4Hy0W2ZBbB6dOPRcT3PIKsEZekW2HtHuPAAp99jwUpasH7Iq1mMYCtQ35WEPfkiQQw/exec";
const VC_BASE  = "https://checkin.veracross.com/frisch/kiosk/entrance?legacy=";

let faculty = [];
let students = [];
let bootstrapReady = false;

/***********************************************************
 * DOM
 ***********************************************************/
const pinEl = document.getElementById("pin");
const qEl   = document.getElementById("q");
const listEl= document.getElementById("results");
const toastEl=document.getElementById("toast");
const netBadge=document.getElementById("netBadge");
const rosterStatus=document.getElementById("rosterStatus");
const actIn=document.getElementById("actIn");
const actOut=document.getElementById("actOut");

/***********************************************************
 * THEME
 ***********************************************************/
document.getElementById("themeBtn").onclick = () => {
  document.body.classList.toggle("dark");
  localStorage.setItem("dark", document.body.classList.contains("dark"));
};
if (localStorage.getItem("dark")==="true") document.body.classList.add("dark");

/***********************************************************
 * NETWORK BADGE
 ***********************************************************/
function updateNet() {
  const on = navigator.onLine;
  netBadge.textContent = on ? "Online" : "Offline";
  netBadge.style.background = on ? "#fff" : "#ffd5d5";
  netBadge.style.color = on ? "#000" : "#900";
}
window.addEventListener("online", updateNet);
window.addEventListener("offline", updateNet);
updateNet();

/***********************************************************
 * TOAST
 ***********************************************************/
function toast(msg, ok=true){
  toastEl.textContent = msg;
  toastEl.classList.toggle("ok", ok);
  toastEl.classList.toggle("err", !ok);
  toastEl.classList.add("show");
  setTimeout(()=>toastEl.classList.remove("show"),2000);
}

/***********************************************************
 * ACTION (IN/OUT)
 ***********************************************************/
function isIn(){ return actIn.classList.contains("active"); }
actIn.onclick = ()=>{ actIn.classList.add("active"); actOut.classList.remove("active"); };
actOut.onclick= ()=>{ actOut.classList.add("active"); actIn.classList.remove("active"); };

/***********************************************************
 * BOOTSTRAP ‚Äî download lists ONCE
 ***********************************************************/
async function bootstrap(){
  rosterStatus.textContent = "‚è≥ Roster‚Ä¶";

  try{
    const r = await fetch(ENDPOINT + "?action=bootstrap");
    const data = await r.json();

    faculty = data.faculty || [];
    students= data.students|| [];

    bootstrapReady = true;
    rosterStatus.textContent = "‚ö° Ready";
    rosterStatus.title = "Roster loaded " + new Date().toLocaleString();

  }catch(e){
    rosterStatus.textContent = "‚ùå Fail";
    rosterStatus.title = "Roster failed to load";
  }
}
bootstrap();

/***********************************************************
 * LOCAL SEARCH (super fast)
 ***********************************************************/
function normalize(s){ return s.toLowerCase().normalize('NFKD').replace(/[\u0300-\u036f]/g,''); }

function searchLocal(q){
  const nq = normalize(q);

  const fac = faculty.filter(f=>{
    const name = normalize(f.firstName+" "+f.lastName);
    return name.includes(nq);
  });

  const stu = students.filter(s=>{
    const name = normalize(s.firstName+" "+s.lastName);
    return name.includes(nq);
  });

  return {fac, stu};
}

function renderResults(q){
  listEl.innerHTML = "";
  if (!q) return;

  const {fac, stu} = searchLocal(q);

  if (fac.length){
    listEl.appendChild(section("FACULTY"));
    fac.forEach(f=>{
      listEl.appendChild(row(`${f.firstName} ${f.lastName}`, ()=>submitFaculty(f)));
    });
  }

  if (stu.length){
    listEl.appendChild(section("STUDENTS"));
    stu.forEach(s=>{
      listEl.appendChild(row(`${s.firstName} ${s.lastName}`, ()=>submitStudent(s)));
    });
  }

  if (!fac.length && !stu.length){
    listEl.innerHTML = "<div class='muted'>No matches</div>";
  }
}

function section(t){
  const d=document.createElement("div");
  d.textContent=t;
  d.style.fontSize="12px";
  d.style.fontWeight="900";
  d.style.marginTop="10px";
  return d;
}
function row(label,click){
  const r=document.createElement("div");
  r.className="row";
  const n=document.createElement("div");
  n.className="name";
  n.textContent=label;
  const b=document.createElement("button");
  b.className="actionBtn";
  b.textContent="Submit";
  b.onclick=click;
  r.appendChild(n); r.appendChild(b);
  return r;
}

qEl.addEventListener("input", ()=>renderResults(qEl.value.trim()));

/***********************************************************
 * SUBMIT HANDLERS
 ***********************************************************/
async function submitStudent(rec){
  const actingIn = isIn();
  const legacy = rec.legacyId;

  if (actingIn){
    // open veracross immediately
    window.open(VC_BASE + encodeURIComponent(legacy), "_blank", "width=480,height=820");
    toast(rec.firstName+" sent to VC", true);
    sendToBackend("in",{pin:legacy}); // background log
  } else {
    toast(rec.firstName+" Out", true);
    sendToBackend("out",{pin:legacy});
  }
}

async function submitFaculty(f){
  if (isIn()){
    toast(`${f.firstName} IN`,true);
    sendToBackend("in",{personId:f.personId});
  } else {
    toast(`${f.firstName} OUT`,true);
    sendToBackend("out",{personId:f.personId});
  }
}

/***********************************************************
 * CARD SWIPE
 ***********************************************************/
pinEl.addEventListener("input", ()=>{
  const d = pinEl.value.replace(/\D+/g,"");
  if (d.length>=10){
    const ten=d.slice(-10);
    pinEl.value="";
    processPin(ten);
  }
});

function processPin(pin){
  const stu = students.find(s=>s.legacyId===pin);
  const fac = faculty.find(f=>f.pin===pin); // optional if stored
  if (stu) return submitStudent(stu);
  if (fac) return submitFaculty(fac);

  toast("Unknown card",false);
  sendToBackend("error",{type:"unknown",details:"Unknown PIN",raw:{pin}});
}

/***********************************************************
 * BACKEND SEND + QUEUE
 ***********************************************************/
async function sendToBackend(action, params={}){
  const body = new URLSearchParams({action,...params});
  try{
    await fetch(ENDPOINT,{method:"POST",body});
  }catch(e){
    // offline ‚Üí log later
    const q = JSON.parse(localStorage.getItem("queue")||"[]");
    q.push({action,params,time:Date.now()});
    localStorage.setItem("queue",JSON.stringify(q));
  }
}

async function flushQueue(){
  const q = JSON.parse(localStorage.getItem("queue")||"[]");
  if (!q.length) return;

  const rest=[];
  for (const job of q){
    try{
      const body = new URLSearchParams({action:job.action,...job.params});
      await fetch(ENDPOINT,{method:"POST",body});
    }catch(e){
      rest.push(job);
    }
  }
  localStorage.setItem("queue",JSON.stringify(rest));
}
setInterval(flushQueue,3000);

/***********************************************************
 * INIT
 ***********************************************************/
pinEl.focus();
</script>

</body>
</html>
