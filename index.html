<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Teacher Attendance ‚Äî Guard Console</title>
<meta name="description" content="Guard console for IN/OUT with Cougar Card swipe/tap or name lookup." />
<meta name="color-scheme" content="light dark">
<meta id="meta-theme" name="theme-color" content="#ffffff">
<style>
  :root{
    --bg:#f6f7fb; --card:#ffffff; --text:#0f172a; --muted:#667085; --border:#e5e7eb;
    --in:#16a34a; --out:#dc2626; --blue:#2563eb;
    --radius-lg:14px; --radius-xl:18px;
    --shadow-1:0 10px 30px rgba(0,0,0,.08);
    --shadow-2:0 14px 40px rgba(0,0,0,.18);
    --ring:0 0 0 6px rgba(59,130,246,.16);
  }
  body.dark{
    --bg:#0b1020; --card:#111827; --text:#f3f4f6; --muted:#cbd5e1; --border:#374151;
  }
  *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
  html,body{ height:100%; margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--text); }

  .wrap{ margin:auto; width:min(1100px,96%); background:var(--card); padding:28px; border-radius:var(--radius-xl); box-shadow:var(--shadow-1); position:relative; }
  h1{ margin:0 0 8px; font-weight:800; font-size:28px; letter-spacing:.2px; }
  .muted{ color:var(--muted); }

  .badges{ position:absolute; right:18px; top:18px; display:flex; gap:8px; align-items:center; }
  .badge{ font-size:12px; font-weight:800; padding:6px 10px; border-radius:999px; border:1px solid var(--border); background:var(--card); color:var(--text); }
  .gear{ border:1px solid var(--border); background:var(--card); color:var(--text); border-radius:10px; padding:6px 10px; cursor:pointer; font-weight:800; display:flex; align-items:center; gap:6px; transition:background .2s ease; }
  .gear:hover{ background: color-mix(in oklab, var(--card) 90%, var(--text) 10%); }
  .gear:focus-visible{ outline:none; box-shadow:var(--ring); }

  .toast{
    position:fixed; left:50%; bottom:24px; transform:translateX(-50%) translateY(20px);
    opacity:0; background:var(--card); border:1px solid var(--border);
    box-shadow:0 8px 30px rgba(0,0,0,.12); border-radius:14px; padding:16px 20px;
    font-weight:800; transition:all .25s ease; pointer-events:none; font-size:18px;
  }
  .toast.show{ opacity:1; transform:translateX(-50%) translateY(0); }

  .segment{ display:flex; gap:14px; width:100%; margin:20px 0; }
  .segment.segment-xl button{
    flex:1 1 0; border:2px solid #d1d5db; border-radius:16px;
    font-weight:900; font-size:42px; line-height:1.1; min-height:96px;
    padding:22px 24px; cursor:pointer; color:#111;
    background:linear-gradient(180deg, #f8fafc 0%, #eef2f7 100%);
    transition:transform .06s ease, box-shadow .2s ease, background .2s ease;
    box-shadow:0 4px 10px rgba(0,0,0,.05);
  }
  .segment.segment-xl button.active#actIn{
    background:linear-gradient(180deg, #16a34a 0%, #15803d 100%);
    color:#fff; border-color:#16a34a; box-shadow:0 0 0 4px rgba(22,163,74,.25);
  }
  .segment.segment-xl button.active#actOut{
    background:linear-gradient(180deg, #dc2626 0%, #991b1b 100%);
    color:#fff; border-color:#dc2626; box-shadow:0 0 0 4px rgba(220,38,38,.25);
  }

  .card{ border:1px solid var(--border); border-radius:14px; padding:16px; background:var(--card); margin-bottom:16px; }
  .grid{ display:grid; grid-template-columns:1fr 1fr; gap:18px; align-items:start; }

  input[type=text], input[type=password]{
    width:100%; padding:18px 20px; font-size:24px;
    border:1.5px solid var(--border); border-radius:12px;
    background:var(--card); color:var(--text);
    outline:none; transition:border-color .2s ease, box-shadow .2s ease, background .2s ease;
  }
  input[type=text]:focus-visible, input[type=password]:focus-visible{
    border-color:#3b82f6; box-shadow:var(--ring);
  }
  input:-webkit-autofill{
    -webkit-box-shadow:0 0 0px 1000px var(--card) inset !important;
    -webkit-text-fill-color:var(--text) !important;
    transition:background-color 5000s ease-in-out 0s;
  }

  .list{
    display:grid; gap:12px; max-height:460px; overflow:auto; margin-top:14px;
    background: var(--card);
    -webkit-overflow-scrolling: touch;
    overscroll-behavior: contain;
  }
  .list::-webkit-scrollbar { width: 10px; height: 10px; }
  .list::-webkit-scrollbar-thumb { border-radius: 999px; background: #b7c0d133; }
  .list::-webkit-scrollbar-track { background: var(--card); }
  .list { scrollbar-color: #98a2b33d var(--card); scrollbar-width: thin; }

  .row{
    display:flex; justify-content:space-between; align-items:center; gap:16px;
    padding:14px 16px; border:1px solid var(--border); border-radius:12px;
    background: var(--card);
  }
  .name{ font-weight:800; font-size:20px; color:var(--text); overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

  .actionBtn{
    --c: var(--blue);
    background:linear-gradient(180deg, var(--c) 0%, color-mix(in srgb, var(--c) 80%, #000 20%) 100%);
    color:#fff; font-size:20px; padding:16px 20px;
    border:2px solid var(--c); border-radius:14px; font-weight:900; cursor:pointer;
    transition:transform .06s ease, filter .15s ease, box-shadow .2s ease;
    box-shadow:0 6px 14px rgba(0,0,0,.12);
  }
  .actionBtn:hover{ filter:brightness(.96); transform:translateY(-1px); }
  .actionBtn:active{ transform:scale(.985); box-shadow:inset 0 3px 8px rgba(0,0,0,.25); }

  .nfcBar{ display:flex; align-items:center; gap:12px; flex-wrap:wrap; margin-top:10px; }
  .nfcBtn{
    padding:14px 18px; border-radius:12px; border:2px solid #4f46e5; color:#fff; background:#4f46e5;
    font-weight:800; cursor:pointer; font-size:18px; transition: transform .06s ease, box-shadow .2s ease;
  }
  .nfcBtn.secondary{ background:transparent; color:#4f46e5; }

  .drawer{
    position:fixed; right:16px; top:64px; width:min(520px,92%); max-height:80vh;
    border:1px solid var(--border); background:var(--card); border-radius:16px; box-shadow:var(--shadow-2);
    padding:16px; overflow:auto; display:none; z-index:20; color:var(--text);
  }
  .drawer h3{ margin:0 0 12px; font-size:18px; display:flex; align-items:center; gap:8px; }

  @media (max-width:900px){
    .grid{ grid-template-columns:1fr; }
    .segment.segment-xl button{ font-size:36px; min-height:88px; }
  }
</style>
</head>
<body>
  <div class="wrap" role="application" aria-label="Teacher Attendance Guard Console">
    <div class="badges" aria-live="polite" aria-atomic="true">
      <div id="netBadge" class="badge">Online</div>
      <div id="nfcBadge" class="badge" style="display:none;">NFC Ready</div>
      <button id="themeBtn" class="gear" title="Toggle theme" aria-label="Toggle dark mode">üåô Dark</button>
      <button id="adminBtn" class="gear" title="Admin" aria-haspopup="dialog" aria-controls="admin"><span>‚öôÔ∏è</span><span>Admin</span></button>
    </div>

    <h1>Teacher Attendance ‚Äî Guard Console</h1>
    <p class="muted">Choose <b>IN</b> or <b>OUT</b>, then <b>swipe/tap your Cougar Card</b> or search the faculty directory.</p>

    <div class="segment segment-xl" role="tablist" aria-label="Action">
      <button id="actIn" class="active" role="tab" aria-selected="true" type="button" aria-label="Set action to IN">IN</button>
      <button id="actOut" role="tab" aria-selected="false" type="button" aria-label="Set action to OUT">OUT</button>
    </div>

    <div class="grid">
      <div class="card">
        <h2>Cougar Card</h2>
        <input id="pin" type="password" maxlength="10" inputmode="numeric" autocomplete="one-time-code"
               placeholder="Swipe or tap your Cougar Card" aria-label="Cougar Card" />
        <div id="nfcBar" class="nfcBar" style="display:none;">
          <button id="nfcStart" class="nfcBtn">Scan with NFC</button>
          <button id="nfcStop" class="nfcBtn secondary">Stop</button>
        </div>
      </div>

      <div class="card">
        <h2>Lookup by Name</h2>
        <input id="q" type="text" inputmode="search" enterkeyhint="search"
               autocapitalize="words" autocorrect="off" spellcheck="false"
               placeholder="Search faculty directory" aria-label="Search teacher by name" />
        <div id="results" class="list" role="list" aria-live="polite"></div>
      </div>
    </div>

    <div id="toast" class="toast" role="status" aria-live="polite"></div>
  </div>

  <div id="admin" class="drawer" role="dialog" aria-modal="false" aria-labelledby="adminTitle">
    <h3 id="adminTitle"><span>‚öôÔ∏è</span><span>Admin Settings</span></h3>
    <p class="muted">Manage reader configuration and debug live activity.</p>
  </div>

<script>
  // ===== Config =====
  const ENDPOINT = 'https://script.google.com/macros/s/AKfycbzF4Hy0W2ZBbB6dOPRcT3PIKsEZekW2HtHuPAAp99jwUpasH7Iq1mMYCtQ35WEPfkiQQw/exec';
  const COOLDOWN_MS = 400;
  const THEME_KEY = 'theme';

  // ===== DOM =====
  const $ = s => document.querySelector(s);
  const pinEl = $('#pin'), qEl = $('#q'), toastEl = $('#toast');
  const btnIn = $('#actIn'), btnOut = $('#actOut');
  const netBadge = $('#netBadge'), nfcBadge = $('#nfcBadge');
  const nfcBar = $('#nfcBar'), nfcStartBtn = $('#nfcStart'), nfcStopBtn = $('#nfcStop');
  const themeBtn = $('#themeBtn'), metaTheme = $('#meta-theme');
  const adminBtn = $('#adminBtn'), adminDrawer = $('#admin');

  let lastSubmitAt = 0;

  // ===== Theme (with persistence) =====
  function setTheme(mode){
    const dark = mode === 'dark';
    document.body.classList.toggle('dark', dark);
    themeBtn.textContent = dark ? '‚òÄÔ∏è Light' : 'üåô Dark';
    if (metaTheme) metaTheme.content = dark ? '#0b1020' : '#ffffff';
    localStorage.setItem(THEME_KEY, dark ? 'dark' : 'light');
  }
  function initTheme(){
    const saved = localStorage.getItem(THEME_KEY);
    if (saved) { setTheme(saved); return; }
    const prefersDark = window.matchMedia?.('(prefers-color-scheme: dark)').matches;
    setTheme(prefersDark ? 'dark' : 'light');
  }
  themeBtn.addEventListener('click', () => setTheme(document.body.classList.contains('dark') ? 'light' : 'dark'));

  // ===== Toast =====
  let toastTimer=null;
  function showToast(text){
    toastEl.textContent = text;
    toastEl.classList.add('show');
    clearTimeout(toastTimer);
    toastTimer = setTimeout(()=>toastEl.classList.remove('show'), 2400);
  }

  // Map backend error wording ‚Üí Cougar Card
  function humanizeError(msg){
    if(!msg) return 'Error';
    return String(msg).replace(/Quick Pin/gi, 'Cougar Card');
  }

  // ===== Network badge =====
  function updateNet(){
    const on = navigator.onLine;
    netBadge.textContent = on ? 'Online' : 'Offline';
    netBadge.style.background = on ? 'var(--card)' : '#fee2e2';
    netBadge.style.color = on ? 'var(--text)' : '#991b1b';
  }
  window.addEventListener('online', updateNet);
  window.addEventListener('offline', updateNet);
  updateNet();

  // ===== Action toggle =====
  function setAction(a){
    const inActive = a === 'in';
    btnIn.classList.toggle('active', inActive);
    btnOut.classList.toggle('active', !inActive);
  }
  btnIn.addEventListener('click', () => setAction('in'));
  btnOut.addEventListener('click', () => setAction('out'));
  window.addEventListener('keydown', (e)=>{ if(e.key==='ArrowLeft') setAction('in'); if(e.key==='ArrowRight') setAction('out'); });

  // ===== Submit API =====
  async function submitPinOrId({ pin, personId }) {
    const act = btnIn.classList.contains('active') ? 'in' : 'out';
    const body = new URLSearchParams({ action: act, ...(pin?{pin}:{personId}) }).toString();
    try{
      const res = await fetch(ENDPOINT, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body });
      const text = await res.text(); let data=null; try{ data = JSON.parse(text); }catch{}
      if (!res.ok || (data && data.error)) {
        showToast(humanizeError((data && data.error) || ('Error ' + res.status)));
        return;
      }
      const { status, firstName, lastName, time } = data || {};
      const verb = (status === 'in') ? 'IN' : (status === 'out') ? 'OUT' : (status||'').toUpperCase();
      const line = `${firstName||''} ${lastName||''} signed ${verb} ‚Äî ${time||''}`.trim();
      showToast(line || 'Done.');
      try{ navigator.vibrate?.(30); }catch{}
    }catch{
      showToast('Network error');
    }finally{
      lastSubmitAt = Date.now();
    }
  }

  // ===== Cougar Card input: auto-submit on exact 10 digits =====
  pinEl.addEventListener('input', ()=>{
    const digits = (pinEl.value||'').replace(/\D+/g,'');
    if (digits.length === 10) {
      if (Date.now() - lastSubmitAt < COOLDOWN_MS) return;
      submitPinOrId({ pin: digits });
      pinEl.value = '';
    }
  });

  // ===== Name Search (backend supports multi-word AND) =====
  let searchTimer=null;
  qEl.addEventListener('input', ()=>{
    clearTimeout(searchTimer);
    const q = qEl.value.trim();
    if (!q) { $('#results').innerHTML = ''; return; }
    searchTimer = setTimeout(()=>doSearch(q), 180);
  });
  qEl.addEventListener('keydown', (e)=>{
    if (e.key === 'Enter') {
      clearTimeout(searchTimer);
      const q = qEl.value.trim();
      if (q) doSearch(q);
      e.preventDefault();
    }
  });

  async function doSearch(q){
    try{
      const res = await fetch(`${ENDPOINT}?action=search&q=${encodeURIComponent(q)}`);
      const data = await res.json();
      const box = $('#results');
      if (!Array.isArray(data) || !data.length) { box.innerHTML = '<div class="muted">No matches found.</div>'; return; }
      box.innerHTML = '';
      data.forEach(({ firstName, lastName, personId })=>{
        const row = document.createElement('div'); row.className='row'; row.setAttribute('role','listitem');
        const name = document.createElement('div'); name.className='name'; name.textContent = `${firstName} ${lastName}`;
        const btn  = document.createElement('button'); btn.className='actionBtn'; btn.textContent='Submit';
        btn.addEventListener('click', ()=> submitPinOrId({ personId }));
        row.appendChild(name); row.appendChild(btn); box.appendChild(row);
      });
    }catch{
      showToast('Search failed');
    }
  }

  // ===== NFC (Android Chrome) =====
  if ('NDEFReader' in window) {
    nfcBar.style.display = '';
    let ndef = new NDEFReader(); let started = false;
    nfcStartBtn.addEventListener('click', async ()=>{
      if (started) return;
      try{
        await ndef.scan(); started = true;
        nfcBadge.style.display = '';
        showToast('NFC scanning started');
        ndef.onreading = (event)=>{
          const uid = String(event.serialNumber || '').toUpperCase().replace(/[^0-9A-F]/g,'');
          if (!uid) { showToast('NFC read error'); return; }
          // Simple mapping: last 10 digits (pad left) ‚Äî aligns with backend normalization
          const pin = uid.slice(-10).padStart(10,'0');
          if (Date.now() - lastSubmitAt >= COOLDOWN_MS) submitPinOrId({ pin });
        };
        ndef.onreadingerror = ()=> showToast('NFC read error ‚Äî try again');
      }catch{
        showToast('NFC not permitted or unavailable');
      }
    });
    nfcStopBtn.addEventListener('click', ()=>{
      try{ ndef.onreading = null; ndef.onreadingerror = null; }catch{}
      started = false; showToast('NFC stopped');
    });
  }

  // ===== Admin drawer =====
  adminBtn.addEventListener('click', ()=>{
    adminDrawer.style.display='block';
    adminDrawer.setAttribute('aria-modal','true');
  });
  adminDrawer.addEventListener('click', (e)=>{
    if (e.target === adminDrawer) {
      adminDrawer.style.display='none';
      adminDrawer.setAttribute('aria-modal','false');
    }
  });

  // ===== Init =====
  document.addEventListener('DOMContentLoaded', ()=>{
    initTheme();
    setAction('in');
  });
</script>
</body>
</html>
