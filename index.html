<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
  />
  <title>Teacher Attendance â€” Guard Console</title>
  <meta name="description" content="Guard console for IN/OUT with 10-digit Quick Pin or name lookup. Web NFC on Android; keyboard-wedge reader on iOS/desktop." />
  <meta name="color-scheme" content="light">
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { display:flex; min-height:100svh; margin:0; background:#f6f7fb; }
    .wrap { margin:auto; width:min(1100px,96%); background:#fff; padding:28px; border-radius:18px; box-shadow:0 10px 30px rgba(0,0,0,.08); position:relative; }
    h1 { margin:0 0 6px; font-weight:800; font-size:28px; letter-spacing:.2px; }
    .sub { color:#475467; margin-bottom:18px; font-size:16px; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:18px; align-items:start; }
    .card { border:1px solid #e5e7eb; border-radius:14px; padding:16px; background:#fff; }
    .card h2 { margin:0 0 10px; font-size:20px; }
    input[type="password"], input[type="search"] {
      padding:18px 20px; font-size:24px; border:1.5px solid #d0d5dd; border-radius:12px; width:100%;
    }
    .muted { color:#667085; }
    .list { display:grid; gap:12px; max-height:460px; overflow:auto; margin-top:14px; }
    .row { display:flex; justify-content:space-between; align-items:center; gap:16px; padding:14px 16px; border:1px solid #e5e7eb; border-radius:12px; background:#fafafa; }
    .name { font-weight:800; font-size:20px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .btn { padding:16px 20px; border:0; border-radius:14px; font-size:20px; cursor:pointer; }
    .primary { background:#111827; color:#fff; }
    .status { margin-top:12px; min-height:32px; font-weight:800; font-size:18px; }
    .good { color:#0f766e; }
    .bad { color:#b91c1c; }

    /* ====== LARGE IN/OUT toggle buttons (neutral until selected) ====== */
    .segment { display:flex; gap:14px; width:100%; }
    .segment.segment-xl button {
      flex:1 1 0;
      border:2px solid #d1d5db;
      border-radius:16px;
      font-weight:900;
      font-size:42px;
      line-height:1.1;
      min-height:96px;
      padding:22px 24px;
      cursor:pointer;
      color:#111;
      background:#f3f4f6;         /* neutral */
      transition: transform .06s ease, box-shadow .2s ease, background .2s ease, color .2s ease, border-color .2s ease;
      box-shadow:0 4px 10px rgba(0,0,0,.05);
      touch-action: manipulation; user-select:none;
    }
    .segment.segment-xl button:active { transform: scale(.99); }
    .segment.segment-xl button.active#actIn {
      background:#16a34a; color:#fff; border-color:#16a34a; box-shadow:0 0 0 4px rgba(22,163,74,.25);
      animation: pulse 350ms ease-out;
    }
    .segment.segment-xl button.active#actOut {
      background:#dc2626; color:#fff; border-color:#dc2626; box-shadow:0 0 0 4px rgba(220,38,38,.25);
      animation: pulse 350ms ease-out;
    }
    @keyframes pulse {
      0%   { box-shadow:0 0 0 0 rgba(0,0,0,0.0); }
      50%  { box-shadow:0 0 0 6px rgba(0,0,0,0.06); }
      100% { box-shadow:0 0 0 4px rgba(0,0,0,0.0); }
    }

    /* Toast */
    .toast {
      position: fixed; left: 50%; bottom: 24px; transform: translateX(-50%) translateY(20px);
      opacity: 0; background: #ffffff; border:1px solid #e5e7eb; box-shadow: 0 8px 30px rgba(0,0,0,.12);
      border-radius: 14px; padding: 16px 20px; font-weight:800; transition: all .25s ease; pointer-events:none; font-size:18px;
    }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

    /* Top right badges */
    .badges { position:absolute; right:18px; top:18px; display:flex; gap:8px; }
    .badge { font-size:12px; font-weight:800; padding:6px 10px; border-radius:999px; border:1px solid #e5e7eb; background:#fff; }
    .badge.offline { background:#fee2e2; color:#991b1b; border-color:#fecaca; }
    .badge.ok { background:#dcfce7; color:#166534; border-color:#bbf7d0; }
    .badge.nfc { background:#e0e7ff; color:#3730a3; border-color:#c7d2fe; }

    /* NFC */
    .nfcBar { display:flex; align-items:center; gap:12px; flex-wrap:wrap; margin-top:10px; }
    .nfcBtn {
      padding:14px 18px; border-radius:12px; border:2px solid #4f46e5; color:#fff; background:#4f46e5;
      font-weight:800; cursor:pointer; font-size:18px;
    }
    .nfcBtn.secondary { background:#fff; color:#4f46e5; }

    /* 10-digit validity styling (optional) */
    input#pin.invalid { border-color:#ef4444; box-shadow:0 0 0 3px rgba(239,68,68,.15); }
    input#pin.valid   { border-color:#16a34a; box-shadow:0 0 0 3px rgba(22,163,74,.15); }

    /* Admin panel */
    #nfcAdmin .btn { padding:8px 12px; border:0; border-radius:10px; font-weight:800; cursor:pointer; }

    /* Responsive */
    @media (max-width: 900px) {
      .grid { grid-template-columns: 1fr; }
      .segment.segment-xl button { font-size:36px; min-height:88px; }
      .wrap { padding:22px; }
    }
  </style>
</head>
<body>
  <div class="wrap" role="application" aria-label="Teacher Attendance Guard Console">
    <div class="badges" aria-live="polite" aria-atomic="true">
      <div id="netBadge" class="badge ok">Online</div>
      <div id="nfcBadge" class="badge nfc" style="display:none;">NFC Ready</div>
      <div id="actBadge" class="badge">IN</div>
    </div>

    <h1>Teacher Attendance â€” Guard Console</h1>
    <p class="sub">Choose <b>IN</b> or <b>OUT</b>, then swipe/tap a card (10-digit Quick Pin) or look up by name. Android Chrome supports Web NFC; iPhone uses a keyboard-wedge reader or manual entry.</p>

    <div class="card" style="margin-bottom:16px;">
      <div style="display:flex;align-items:center;gap:16px;flex-wrap:wrap;">
        <!-- Huge buttons (neutral until selected) -->
        <div class="segment segment-xl" role="tablist" aria-label="Action">
          <button id="actIn"  class="active" role="tab" aria-selected="true"  type="button" aria-label="Set action to IN">IN</button>
          <button id="actOut" role="tab" aria-selected="false" type="button" aria-label="Set action to OUT">OUT</button>
        </div>
        <div class="muted" style="flex:1 1 100%;">Action applies to both card pins and name lookup.</div>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>Quick Pin (10 digits, auto)</h2>
        <input id="pin"
               inputmode="numeric"
               autocomplete="one-time-code"
               pattern="\d{10}"
               maxlength="10"
               placeholder="Enter 10-digit codeâ€¦"
               type="password"
               aria-label="Quick Pin" />
        <div id="pinStatus" class="status muted" aria-live="polite">Waiting for 10-digit codeâ€¦</div>

        <!-- NFC controls (Android Chrome only) -->
        <div id="nfcBar" class="nfcBar" style="display:none;">
          <button id="nfcStart" class="nfcBtn">ðŸ”· Scan with NFC</button>
          <button id="nfcStop"  class="nfcBtn secondary">Stop</button>
        </div>
      </div>

      <div class="card">
        <h2>Lookup by Name</h2>
        <input id="q" type="search" placeholder="Start typing first or last name" aria-label="Search teacher by name" />
        <div id="results" class="list" role="list" aria-live="polite"></div>
      </div>
    </div>

    <div id="toast" class="toast" role="status" aria-live="polite"></div>
    <div id="msg" class="status muted" style="margin-top:16px;" aria-live="polite">Ready.</div>
    <p class="muted" style="margin:8px 0 0; font-size:12px;">Â© Yeshivat Frisch 5786</p>
  </div>

  <!-- NFC Match Admin (hidden; toggle with Shift+A or #admin) -->
  <div id="nfcAdmin" style="display:none; position:fixed; right:16px; bottom:16px; width:min(520px,95%); background:#fff; padding:16px; border:1px solid #e5e7eb; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.12); z-index:99999;">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:8px; margin-bottom:8px;">
      <strong>NFC Match (UID â†’ 10-digit)</strong>
      <button id="nfcAdminClose" class="btn" style="background:#111827;color:#fff;">Close</button>
    </div>
    <div style="font-size:13px; color:#475467; margin-bottom:8px;">
      Scan a card with your phone and compare these outputs to what the USB reader types (10 digits). Pick the rule that matches. Saved locally.
    </div>
    <div id="nfcProbe" style="font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:13px; background:#f8fafc; border:1px solid #e5e7eb; padding:10px; border-radius:10px; white-space:pre-wrap; min-height:80px;">
      Awaiting NFC readâ€¦
    </div>
    <div style="margin-top:10px;">
      <label style="display:block; font-weight:700; margin-bottom:6px;">Choose matching rule:</label>
      <div id="nfcRules" style="display:grid; gap:8px;"></div>
    </div>
  </div>

<script>
  // ====== CONFIG ======
  const ENDPOINT = 'https://script.google.com/macros/s/AKfycbzF4Hy0W2ZBbB6dOPRcT3PIKsEZekW2HtHuPAAp99jwUpasH7Iq1mMYCtQ35WEPfkiQQw/exec';
  const PIN_REQUIRED_LEN = 10;

  // ====== DOM ======
  const $ = sel => document.querySelector(sel);
  const pinEl = $('#pin'), qEl = $('#q'), msgEl = $('#msg'), pinStatusEl = $('#pinStatus'), resultsEl = $('#results'), toastEl = $('#toast');
  const btnIn = $('#actIn'), btnOut = $('#actOut');
  const netBadge = $('#netBadge'), actBadge = $('#actBadge');
  const nfcBadge = $('#nfcBadge'), nfcBar = $('#nfcBar'), nfcStartBtn = $('#nfcStart'), nfcStopBtn = $('#nfcStop');

  // ====== Action Toggle ======
  function currentAction(){ return btnIn.classList.contains('active') ? 'in' : 'out'; }
  function setAction(a){
    const inActive = (a === 'in');
    btnIn.classList.toggle('active', inActive);  btnIn.setAttribute('aria-selected', String(inActive));
    btnOut.classList.toggle('active', !inActive); btnOut.setAttribute('aria-selected', String(!inActive));
    actBadge.textContent = inActive ? 'IN' : 'OUT';
    setTimeout(() => pinEl.focus(), 0);
  }
  btnIn.addEventListener('click', () => setAction('in'));
  btnOut.addEventListener('click', () => setAction('out'));
  window.addEventListener('keydown', (e) => {
    if (e.key === 'ArrowLeft') setAction('in');
    if (e.key === 'ArrowRight') setAction('out');
  });

  // ====== UX helpers ======
  function setMsg(text, cls='muted'){ msgEl.className = 'status ' + cls; msgEl.textContent = text; }
  function setPinMsg(text, cls='muted'){ pinStatusEl.className = 'status ' + cls; pinStatusEl.textContent = text; }
  let toastTimer = null;
  function showToast(text){ toastEl.textContent = text; toastEl.classList.add('show'); clearTimeout(toastTimer); toastTimer = setTimeout(()=>toastEl.classList.remove('show'), 2400); }
  function onlineChanged(){
    const on = navigator.onLine;
    netBadge.textContent = on ? 'Online' : 'Offline';
    netBadge.className = 'badge ' + (on ? 'ok' : 'offline');
  }
  window.addEventListener('online', onlineChanged);
  window.addEventListener('offline', onlineChanged);
  onlineChanged();

  // ====== Normalize to exactly 10 digits ======
  function normalizeToTenDigits(raw) {
    if (!raw) return '';
    const s = String(raw);
    if (/^\d+$/.test(s)) {
      if (s.length === 10) return s;
      if (s.length > 10) { const m = s.match(/\d{10}/); return m ? m[0] : ''; }
      return '';
    }
    const digits = s.replace(/\D+/g, '');
    if (digits.length === 10) return digits;
    if (digits.length > 10) { const m = digits.match(/\d{10}/); return m ? m[0] : ''; }
    return '';
  }

  // ====== Submit API ======
  async function submitPinOrId({ pin, personId }) {
    const act = currentAction();
    const body = new URLSearchParams({ action: act, ...(pin?{pin}:{}), ...(personId?{personId}:{}) }).toString();
    try {
      const res = await fetch(ENDPOINT, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body,
      });
      const text = await res.text();
      let data = null; try { data = JSON.parse(text); } catch {}
      if (!res.ok || (data && data.error)) {
        const msg = (data && data.error) ? String(data.error) : ('Error ' + res.status);
        const nicer = /not found/i.test(msg) ? 'Quick Pin / Person not found in Directory' : msg;
        setMsg(nicer, 'bad'); showToast(nicer); return;
      }
      const { status, firstName, lastName, time, paired } = data || {};
      const extra = (status === 'out' && typeof paired === 'boolean') ? (paired ? ' (paired)' : ' (no prior IN)') : '';
      const verb = (status === 'in') ? 'IN' : (status === 'out') ? 'OUT' : 'UPDATED';
      const line = `${firstName||''} ${lastName||''} signed ${verb}${extra} â€” ${time||''}`.trim();
      setMsg(line || 'Done.', 'good'); showToast(line || 'Done.');
    } catch (err) {
      setMsg('Network error', 'bad'); showToast('Network error');
    } finally {
      pinEl.focus();
    }
  }

  // ====== Quick Pin (10-digit, auto-submit) ======
  let pinTimer = null;
  pinEl.addEventListener('input', () => {
    clearTimeout(pinTimer);
    const norm = normalizeToTenDigits(pinEl.value || '');
    pinEl.classList.remove('invalid','valid');
    if (!norm) {
      if (pinEl.value) pinEl.classList.add('invalid');
      setPinMsg('Waiting for 10-digit codeâ€¦', 'muted');
      return;
    }
    if (norm.length === PIN_REQUIRED_LEN) {
      pinEl.classList.add('valid');
      pinTimer = setTimeout(() => {
        pinEl.value = norm; // show normalized value
        submitPinOrId({ pin: norm });
        pinEl.value = '';
        pinEl.classList.remove('valid');
        setPinMsg('Submitted.', 'good');
      }, 200);
    }
  });

  pinEl.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      const norm = normalizeToTenDigits(pinEl.value || '');
      if (norm.length === PIN_REQUIRED_LEN) {
        submitPinOrId({ pin: norm });
        pinEl.value = '';
        pinEl.classList.remove('valid','invalid');
        setPinMsg('Submitted.', 'good');
      } else {
        pinEl.classList.add('invalid');
        setPinMsg('Needs exactly 10 digits.', 'bad');
      }
    }
  });

  // ====== Name Lookup ======
  let searchTimer = null;
  qEl.addEventListener('input', () => {
    clearTimeout(searchTimer);
    const q = qEl.value.trim(); resultsEl.innerHTML = '';
    if (!q) { setMsg('Ready.', 'muted'); return; }
    searchTimer = setTimeout(() => doSearch(q), 160);
  });
  async function doSearch(q) {
    setMsg('Searchingâ€¦', 'muted');
    try {
      const res = await fetch(ENDPOINT + `?action=search&q=${encodeURIComponent(q)}`, { method: 'GET' });
      const data = await res.json();
      if (!Array.isArray(data) || data.length === 0) {
        resultsEl.innerHTML = '<div class="muted">No matches.</div>'; setMsg('No matches', 'muted'); return;
      }
      resultsEl.innerHTML = '';
      data.forEach(({ firstName, lastName, personId }) => {
        const row = document.createElement('div'); row.className = 'row'; row.setAttribute('role','listitem');
        const name = document.createElement('div'); name.className = 'name'; name.textContent = `${firstName} ${lastName}`;
        const btn = document.createElement('button'); btn.className = 'btn primary'; btn.textContent = 'Submit';
        btn.addEventListener('click', () => { submitPinOrId({ personId }); pinEl.focus(); });
        row.appendChild(name); row.appendChild(btn); resultsEl.appendChild(row);
      });
      setMsg('Select a name then click Submit (uses selected IN/OUT).', 'muted');
    } catch (e) {
      resultsEl.innerHTML = '<div class="bad">Search failed.</div>'; setMsg('Search failed', 'bad');
    }
  }

  // ====== NFC UID â†’ 10-digit converters (match USB) ======
  const NFC_RULES = [
    { id: 'HEX_BE_PAD10',   label: 'HEX big-endian (last 4 bytes) â†’ decimal, pad 10' },
    { id: 'HEX_LE_PAD10',   label: 'HEX little-endian (last 4 bytes) â†’ decimal, pad 10' },
    { id: 'LAST3_DEC_PAD10',label: 'Last 3 bytes â†’ decimal, pad 10' },
  ];
  function hexToBytes(hex) {
    const s = (hex||'').replace(/[^0-9a-f]/gi,'');
    const out = []; for (let i=0;i<s.length;i+=2) out.push(parseInt(s.substr(i,2),16));
    return out;
  }
  function bytesToNumberBE(bytes){ return bytes.reduce((a,b)=>(a*256+b)>>>0,0); }
  function bytesToNumberLE(bytes){ return bytes.reduceRight((a,b)=>(a*256+b)>>>0,0); }
  function pad10(n){ const s = String(n>>>0); return s.length>=10 ? s.slice(-10) : s.padStart(10,'0'); }
  function uidToTenByRule(uidHex, ruleId){
    const bytes = hexToBytes(uidHex);
    switch (ruleId) {
      case 'HEX_BE_PAD10': { const slice = bytes.slice(-4); return pad10(bytesToNumberBE(slice)); }
      case 'HEX_LE_PAD10': { const slice = bytes.slice(-4); return pad10(bytesToNumberLE(slice)); }
      case 'LAST3_DEC_PAD10': { const slice = bytes.slice(-3); return pad10(bytesToNumberBE(slice)); }
      default: return '';
    }
  }
  const NFC_RULE_KEY = 'attendance:nfc_rule';
  function getSelectedNfcRule(){ return localStorage.getItem(NFC_RULE_KEY) || NFC_RULES[0].id; }
  function setSelectedNfcRule(id){ localStorage.setItem(NFC_RULE_KEY, id); }

  // ====== Admin panel (Shift+A or #admin) ======
  const nfcAdmin = document.getElementById('nfcAdmin');
  const nfcAdminClose = document.getElementById('nfcAdminClose');
  const nfcRulesEl = document.getElementById('nfcRules');
  const nfcProbe = document.getElementById('nfcProbe');

  function renderNfcRules(selectedId) {
    nfcRulesEl.innerHTML = '';
    NFC_RULES.forEach(r => {
      const id = 'r_'+r.id;
      const wrap = document.createElement('label');
      wrap.style.display = 'flex';
      wrap.style.alignItems = 'center';
      wrap.style.gap = '8px';
      const radio = document.createElement('input');
      radio.type = 'radio'; radio.name = 'nfc_rule'; radio.value = r.id; radio.id = id; radio.checked = (r.id === selectedId);
      radio.addEventListener('change', () => setSelectedNfcRule(r.id));
      const txt = document.createElement('span'); txt.textContent = r.label;
      wrap.appendChild(radio); wrap.appendChild(txt);
      nfcRulesEl.appendChild(wrap);
    });
  }
  function showAdmin(){ renderNfcRules(getSelectedNfcRule()); nfcAdmin.style.display = ''; }
  function hideAdmin(){ nfcAdmin.style.display = 'none'; }
  nfcAdminClose?.addEventListener('click', hideAdmin);
  window.addEventListener('keydown', (e) => { if (e.shiftKey && (e.key==='A'||e.key==='a')) (nfcAdmin.style.display==='none'||!nfcAdmin.style.display) ? showAdmin() : hideAdmin(); });
  if (location.hash === '#admin') showAdmin();

  // ====== Web NFC (Android Chrome only) â€” NDEF Text (10 digits) or UIDâ†’10 using rule ======
  let ndef = null;
  function supportsWebNFC(){ return 'NDEFReader' in window; }
  async function startNFC() {
    if (!supportsWebNFC()) return;
    try {
      ndef = new NDEFReader();
      await ndef.scan(); // requires user gesture
      setMsg('NFC scanning started', 'good'); showToast('NFC scanning started');
      nfcStartBtn.disabled = true; nfcStopBtn.disabled = false;

      ndef.onreadingerror = () => { setMsg('NFC read error â€” try again', 'bad'); showToast('NFC read error'); };
      ndef.onreading = (event) => {
        const { message, serialNumber } = event;
        const uidHex = String(serialNumber || '').toUpperCase().replace(/[^0-9A-F]/g,'');

        // 1) Try NDEF text/URL that resolves to 10 digits
        let ten = '';
        for (const record of message.records) {
          const texty = record.recordType === 'text' || record.recordType === 'url' || record.mediaType === 'text/plain';
          if (!texty) continue;
          try {
            const td = new TextDecoder(record.encoding || 'utf-8');
            const text = record.data ? td.decode(record.data) : '';
            ten = normalizeToTenDigits(text);
            if (ten) break;
          } catch(_) {}
        }

        // 2) Else try UID â†’ 10 using selected rule
        if (!ten && uidHex) ten = uidToTenByRule(uidHex, getSelectedNfcRule());

        // Admin probe output (to help pick the right rule)
        if (nfcAdmin && nfcAdmin.style.display !== 'none') {
          const variants = NFC_RULES.map(r => `${r.id.padEnd(16)} â†’ ${uidToTenByRule(uidHex, r.id)}`).join('\n');
          nfcProbe.textContent = `UID: ${uidHex || '(none)'}\n\n${variants}\n\nChosen: ${getSelectedNfcRule()}\nResult: ${ten || '(no 10-digit match)'}`;
        }

        if (!ten) { setMsg('NFC must resolve to a 10-digit code (NDEF or UID rule).', 'bad'); showToast('NFC needs 10 digits'); return; }

        submitPinOrId({ pin: ten });
        setPinMsg('NFC submitted.', 'good');
      };
    } catch (err) {
      setMsg('NFC not permitted or unavailable', 'bad'); showToast('NFC not permitted');
    }
  }
  function stopNFC() {
    if (ndef) { ndef.onreading = null; ndef.onreadingerror = null; }
    nfcStartBtn.disabled = false; nfcStopBtn.disabled = true; setMsg('NFC stopped.', 'muted');
  }
  if ('NDEFReader' in window) {
    nfcBar.style.display = ''; nfcBadge.style.display = '';
    nfcStopBtn.disabled = true;
    nfcStartBtn.addEventListener('click', startNFC);
    nfcStopBtn.addEventListener('click', stopNFC);
  }

  // ====== Initialize ======
  setAction('in');  // default
  pinEl.focus();

  // Keep focus on pin after most clicks (kiosk-friendly)
  document.addEventListener('click', (e) => {
    if (e.target === qEl || qEl.contains(e.target)) return;
    if (e.target !== pinEl && e.target !== nfcStartBtn && e.target !== nfcStopBtn) {
      setTimeout(() => pinEl.focus(), 0);
    }
  });
</script>
</body>
</html>
