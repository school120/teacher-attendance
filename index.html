<!doctype html>
try { const a = new (window.AudioContext||window.webkitAudioContext)();
const o = a.createOscillator(); const g = a.createGain();
o.frequency.value=freq; o.connect(g); g.connect(a.destination); o.start();
g.gain.setValueAtTime(.06,a.currentTime); g.gain.exponentialRampToValueAtTime(.0001,a.currentTime+ms/1000);
setTimeout(()=>{o.stop();a.close();}, ms+40);
} catch(_){}
};


function setMsg(text, cls='muted') { msgEl.className = 'msg ' + cls; msgEl.textContent = text; }


async function submitPin(pin) {
if (!pin) { setMsg('Please enter your Quick Pin', 'bad'); tone(220); return; }
setMsg('Submitting…', 'muted');


// Use URL-encoded form to avoid CORS preflight
const body = new URLSearchParams({ pin }).toString();


try {
const res = await fetch(ENDPOINT, {
method: 'POST',
headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
body
});


// Attempt to parse JSON (Apps Script returns application/json)
let data = null;
try { data = await res.json(); } catch(_) { /* may be opaque if CORS policy changes */ }


if (!res.ok) {
const text = data && data.error ? data.error : ('Error ' + res.status);
setMsg(text, 'bad'); tone(220);
return;
}


if (!data) { setMsg('Submitted.', 'good'); tone(880); return; }


const { status, firstName, lastName, time } = data;
if (status === 'in') {
setMsg(`${firstName} ${lastName} checked IN at ${time}`, 'good');
tone(880);
} else if (status === 'out') {
setMsg(`${firstName} ${lastName} checked OUT at ${time}`, 'good');
tone(660);
} else {
setMsg('Done.', 'good'); tone(660);
}
} catch (err) {
setMsg(String(err), 'bad'); tone(220);
} finally {
pinEl.value = '';
pinEl.focus();
}
}


submitBtn.addEventListener('click', () => submitPin(pinEl.value.trim()));
pinEl.addEventListener('keydown', (e) => {
if (e.key === 'Enter') submitPin(pinEl.value.trim());
});


document.querySelectorAll('.key').forEach(k => {
k.addEventListener('click', () => {
const v = k.textContent.trim();
if (v === '⌫') { pinEl.value = pinEl.value.slice(0, -1); tone(260); return; }
if (v === '↵') { submitPin(pinEl.value.trim()); return; }
if (/^[0-9]$/.test(v)) { pinEl.value += v; tone(520, 60); }
pinEl.focus();
});
});


pinEl.focus();
</script>
</body>
</html>
