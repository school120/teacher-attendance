<!doctype html>
const stuMap = new Map();
stuRes.forEach(r=>{
const lf = String(r.fullName||''); const flip = flipLF(lf);
const legacy = String(r.legacyId||''); const s = scoreName(q, flip.first||'', flip.last||'', lf);
const cur = stuMap.get(legacy); if (!cur || s > cur._score) stuMap.set(legacy, {...r, _flip:flip, _score:s});
});
const stuSorted = Array.from(stuMap.values()).sort((a,b)=>b._score - a._score).slice(0,30);


if (myToken !== searchToken || !qEl.value.trim()) return;


const frag = document.createDocumentFragment();


if (facSorted.length) {
frag.appendChild(sectionHeader('FACULTY'));
facSorted.forEach(({ firstName, lastName, personId })=>{
frag.appendChild(resultRow(`${firstName} ${lastName}`, 'Submit', ()=> submitPinOrId({ personId })));
});
}


if (stuSorted.length) {
frag.appendChild(sectionHeader('STUDENTS'));
stuSorted.forEach(({ fullName, legacyId, _flip })=>{
const label = (_flip.first ? `${_flip.first} ${_flip.last}` : fullName).trim();
frag.appendChild(resultRow(
label,
btnOut.classList.contains('active') ? 'Sign OUT' : 'Sign IN',
()=>{
const isOut = btnOut.classList.contains('active');
if (!isOut) {
// IN → Veracross handoff
const kioskURL = VC_BASE + encodeURIComponent(legacyId);
window.open(kioskURL, '_blank', 'width=480,height=820,noopener,noreferrer');
showToast(`${label} — sent to Veracross`, true);
chimeOk();
return;
}
// OUT → send directly to backend using legacyId
submitPinOrId({ pin: String(legacyId) });
}
));
});
}


box.innerHTML = '';
if (!facSorted.length && !stuSorted.length) {
box.innerHTML = '<div class="muted" style="text-align:center;">No matches found.</div>';
} else {
box.appendChild(frag);
}
} catch (e){
if (e && e.name === 'AbortError') return;
if (myToken === searchToken) $('#results').innerHTML = '<div class="muted" style="text-align:center;">Search failed.</div>';
}
}


/* ===== Init ===== */
document.addEventListener('DOMContentLoaded', ()=>{
initTheme();
setAction('in');
setTimeout(()=>{ pinEl.focus(); }, 0);
});
</script>
</body>
</html>
