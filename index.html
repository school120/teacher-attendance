<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
<title>Teacher Attendance â€” Guard Console</title>
<meta name="description" content="Guard console for IN/OUT with card swipe/tap or name lookup." />
<meta name="color-scheme" content="light dark">
<meta id="meta-theme" name="theme-color" content="#ffffff">
<style>
  :root{
    --bg:#f6f7fb; --card:#ffffff; --text:#0f172a; --muted:#667085; --border:#e5e7eb;
    --in:#16a34a; --out:#dc2626; --blue:#2563eb; --ink:#0b1220;
    --radius-xl:18px; --ring:0 0 0 6px rgba(59,130,246,.16);
  }
  body.dark{ --bg:#0b1020; --card:#111827; --text:#f3f4f6; --muted:#cbd5e1; --border:#374151; --ink:#f3f4f6; }
  *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
  html, body { height:100%; margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
  .wrap{
    margin:auto; width:min(1100px,96%); background:var(--card);
    border-radius:var(--radius-xl); box-shadow:0 10px 30px rgba(0,0,0,.08);
    min-height:100svh; padding:28px; position:relative;
  }
  h1{ margin:0 0 8px; font-weight:800; font-size:28px; letter-spacing:.2px; }
  .muted{ color:var(--muted); }
  .badges{ position:absolute; right:18px; top:18px; display:flex; gap:8px; align-items:center; }
  .badge{ font-size:12px; font-weight:800; padding:6px 10px; border-radius:999px; border:1px solid var(--border); background:var(--card); color:var(--text); }
  .gear{ border:1px solid var(--border); background:var(--card); color:var(--text); border-radius:10px; padding:6px 10px; cursor:pointer; font-weight:800; }
  .gear:focus-visible{ outline:none; box-shadow:var(--ring); }

  .segment{ display:flex; gap:14px; width:100%; margin:20px 0; }
  .segment.segment-xl button{
    flex:1 1 0; border:2px solid #d1d5db; border-radius:16px;
    font-weight:900; font-size:42px; line-height:1.1; min-height:96px;
    padding:22px 24px; cursor:pointer; color:#111;
    background:linear-gradient(180deg, #f8fafc 0%, #eef2f7 100%);
    transition:transform .06s ease, box-shadow .2s ease, background .2s ease; box-shadow:0 4px 10px rgba(0,0,0,.05);
  }
  .segment.segment-xl button.active#actIn{
    background:linear-gradient(180deg, #16a34a 0%, #15803d 100%); color:#fff; border-color:#16a34a; box-shadow:0 0 0 4px rgba(22,163,74,.25);
  }
  .segment.segment-xl button.active#actOut{
    background:linear-gradient(180deg, #dc2626 0%, #991b1b 100%); color:#fff; border-color:#dc2626; box-shadow:0 0 0 4px rgba(220,38,38,.25);
  }

  .grid{ display:grid; grid-template-columns:1fr 1fr; gap:18px; align-items:stretch; }
  .card{ border:1px solid var(--border); border-radius:14px; background:var(--card); padding:16px; display:flex; flex-direction:column; gap:12px; }
  .card h2{ margin:0 0 2px; font-size:20px; }

  input[type=text], input[type=password], input[type=search]{
    width:100%; padding:18px 20px; font-size:24px; border:1.5px solid var(--border); border-radius:12px; background:var(--card); color:var(--text);
  }
  input[type=text]:focus-visible, input[type=password]:focus-visible, input[type=search]:focus-visible{ border-color:#3b82f6; box-shadow:var(--ring); outline:none; }

  .list{ display:grid; gap:12px; max-height:460px; overflow:auto; margin-top:4px; padding-right:8px; }
  .row{ display:grid; grid-template-columns:minmax(0,1fr) auto; align-items:center; gap:12px; padding:12px 14px; border:1px solid var(--border); border-radius:12px; background: var(--card); }
  .name{ min-width:0; font-weight:800; font-size:20px; color:var(--text); overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

  .sectionTag{
    font-weight:900; letter-spacing:.12em; font-size:12px; opacity:.9;
    color:#0b1220; background:#e6eefb; padding:6px 10px; border-radius:999px; border:1px solid #c6d3f2;
  }
  body.dark .sectionTag{ color:#e8eefc; background:#16243c; border-color:#2a4a7d; }

  .actionBtn{
    background:#2563eb; color:#fff; font-size:20px; padding:12px 16px; border:2px solid #2563eb; border-radius:14px; font-weight:900; cursor:pointer;
  }

  /* ===== Sophisticated toast (bottom center, icon + color variants) ===== */
  .toast{
    position:fixed; left:50%; bottom:20px;
    transform:translateX(-50%) translateY(10px); opacity:0;
    min-width:min(92vw, 780px);
    padding:16px 18px;
    border-radius:14px;
    background:var(--card);
    color:var(--ink);
    border:1px solid var(--border);
    box-shadow:0 12px 34px rgba(0,0,0,.18);
    pointer-events:none;
    z-index:1000;
    display:flex; align-items:center; gap:12px;
    font-weight:900; font-size: clamp(18px, 2.6vw, 22px);
    transition: transform .18s ease-out, opacity .18s ease-out;
  }
  .toast.show{ opacity:1; transform:translateX(-50%) translateY(0); }
  .toast .dot{
    width:14px; height:14px; border-radius:50%;
    background:#2563eb; box-shadow:0 0 0 4px color-mix(in srgb, #2563eb 30%, transparent);
    flex:none;
  }
  .toast.ok .dot{ background:#16a34a; box-shadow:0 0 0 4px color-mix(in srgb, #16a34a 30%, transparent); }
  .toast.fail .dot{ background:#dc2626; box-shadow:0 0 0 4px color-mix(in srgb, #dc2626 30%, transparent); }
  .toast .label{ font-weight:900; }
  .toast .sub{ font-weight:700; color:var(--muted); margin-left:auto; font-size: .88em; }

  @media (max-width:900px){ .grid{ grid-template-columns:1fr; } .segment.segment-xl button{ font-size:36px; min-height:88px; } }
</style>
</head>
<body>
  <div class="wrap" role="application" aria-label="Teacher Attendance Guard Console">
    <div class="badges" aria-live="polite" aria-atomic="true">
      <div id="netBadge" class="badge">Online</div>
      <button id="themeBtn" class="gear" title="Toggle theme" aria-label="Toggle dark mode">ðŸŒ™ Dark</button>
    </div>

    <h1>Teacher Attendance â€” Guard Console</h1>
    <p class="muted">Choose <b>IN</b> or <b>OUT</b>, then <b>swipe/tap card</b> or search by name (faculty first, then students).</p>

    <div class="segment segment-xl" role="tablist" aria-label="Action">
      <button id="actIn" class="active" role="tab" aria-selected="true" type="button" aria-label="Set action to IN">IN</button>
      <button id="actOut" role="tab" aria-selected="false" type="button" aria-label="Set action to OUT">OUT</button>
    </div>

    <div class="grid">
      <!-- LEFT: Card -->
      <div class="card">
        <h2>Cougar Card (Quick Pin / Legacy ID)</h2>
        <input id="pin" type="password" maxlength="32" inputmode="numeric" autocomplete="one-time-code"
               placeholder="Tap or swipe cardâ€¦" aria-label="Cougar Card" />
      </div>

      <!-- RIGHT: Lookup -->
      <div class="card">
        <h2>Lookup by Name</h2>
        <input id="q" type="search" inputmode="search" enterkeyhint="search"
               autocapitalize="words" autocorrect="off" spellcheck="false"
               placeholder="Search faculty or students" aria-label="Search name" />
        <div id="results" class="list" role="list" aria-live="polite"></div>
      </div>
    </div>

    <div id="toast" class="toast" role="status" aria-live="polite">
      <span class="dot" aria-hidden="true"></span>
      <span id="toastLabel" class="label">Ready.</span>
      <span id="toastSub" class="sub"></span>
    </div>
  </div>

<script>
  /* ==================== Config ==================== */
  const ENDPOINT = 'https://script.google.com/macros/s/AKfycbzF4Hy0W2ZBbB6dOPRcT3PIKsEZekW2HtHuPAAp99jwUpasH7Iq1mMYCtQ35WEPfkiQQw/exec';
  const VC_BASE  = 'https://checkin.veracross.com/frisch/kiosk/entrance?legacy=';
  const COOLDOWN_MS = 200;          // quick throttle
  const DEDUPE_WINDOW_MS = 5000;    // block repeats for 5s

  /* ==================== DOM ==================== */
  const $ = s => document.querySelector(s);
  const pinEl = $('#pin'), qEl = $('#q');
  const toastEl = $('#toast'), toastLabel = $('#toastLabel'), toastSub = $('#toastSub');
  const btnIn = $('#actIn'), btnOut = $('#actOut');
  const netBadge = $('#netBadge'), themeBtn = $('#themeBtn'), metaTheme = $('#meta-theme');

  let lastSubmitAt = 0;
  const lastSeenMap = new Map(); // de-dupe

  /* ==================== Theme ==================== */
  function setTheme(mode){
    const dark = mode === 'dark';
    document.body.classList.toggle('dark', dark);
    themeBtn.textContent = dark ? 'â˜€ï¸ Light' : 'ðŸŒ™ Dark';
    if (metaTheme) metaTheme.content = dark ? '#0b1020' : '#ffffff';
    localStorage.setItem('theme', dark ? 'dark' : 'light');
  }
  function initTheme(){
    const saved = localStorage.getItem('theme');
    if (saved) { setTheme(saved); return; }
    const prefersDark = window.matchMedia?.('(prefers-color-scheme: dark)').matches;
    setTheme(prefersDark ? 'dark' : 'light');
  }
  themeBtn.addEventListener('click', () => setTheme(document.body.classList.contains('dark') ? 'light' : 'dark'));

  /* ==================== Toast (polished) ==================== */
  let toastTimer=null;
  function showToast(label, kind='info', sub=''){
    toastLabel.textContent = label || '';
    toastSub.textContent = sub || '';
    toastEl.classList.remove('ok','fail');
    if (kind === 'ok') toastEl.classList.add('ok');
    if (kind === 'fail') toastEl.classList.add('fail');
    toastEl.classList.add('show');
    clearTimeout(toastTimer);
    toastTimer = setTimeout(()=>toastEl.classList.remove('show'), 2600);
  }

  /* ==================== Chimes (submission only) ==================== */
  let audioCtx=null, master=null, compressor=null, audioReady=false;
  function initAudioOnce(){
    if (audioReady) return;
    const AC = window.AudioContext || window.webkitAudioContext;
    if (!AC) return;
    audioCtx = new AC();
    compressor = audioCtx.createDynamicsCompressor();
    compressor.threshold.setValueAtTime(-14, audioCtx.currentTime);
    compressor.knee.setValueAtTime(20, audioCtx.currentTime);
    compressor.ratio.setValueAtTime(12, audioCtx.currentTime);
    compressor.attack.setValueAtTime(0.003, audioCtx.currentTime);
    compressor.release.setValueAtTime(0.08, audioCtx.currentTime);
    master = audioCtx.createGain();
    master.gain.setValueAtTime(0.95, audioCtx.currentTime);
    master.connect(compressor).connect(audioCtx.destination);
    audioReady = true;
  }
  // Unlock once
  window.addEventListener('pointerdown', () => { initAudioOnce(); audioCtx?.resume?.(); }, { once:true });
  window.addEventListener('keydown', () => { initAudioOnce(); audioCtx?.resume?.(); }, { once:true });

  function beep({ f=880, d=0.18, t, type='sine', g=0.85 }){
    if (!audioReady) return;
    const o = audioCtx.createOscillator();
    const gnode = audioCtx.createGain();
    o.type = type; o.frequency.setValueAtTime(f, t);
    gnode.gain.setValueAtTime(0, t);
    gnode.gain.linearRampToValueAtTime(g, t+0.012);
    gnode.gain.exponentialRampToValueAtTime(0.0001, t+d);
    o.connect(gnode).connect(master);
    o.start(t); o.stop(t+d+0.02);
  }
  function chimeOK(){
    if (!audioReady) return;
    const t0 = audioCtx.currentTime + 0.01;
    beep({ f:740, d:0.11, t:t0,     type:'sine', g:1.0 });
    beep({ f:980, d:0.13, t:t0+.12, type:'sine', g:1.0 });
    beep({ f:1240,d:0.15, t:t0+.25, type:'sine', g:1.0 });
  }
  function chimeFAIL(){
    if (!audioReady) return;
    const t0 = audioCtx.currentTime + 0.01;
    beep({ f:440, d:0.15, t:t0,     type:'square', g:1.0 });
    beep({ f:330, d:0.17, t:t0+.14, type:'square', g:0.95 });
    beep({ f:262, d:0.19, t:t0+.28, type:'square', g:0.9 });
  }

  /* ==================== Net badge ==================== */
  function updateNet(){
    const on = navigator.onLine;
    netBadge.textContent = on ? 'Online' : 'Offline';
    netBadge.style.background = on ? 'var(--card)' : '#fee2e2';
    netBadge.style.color = on ? 'var(--text)' : '#991b1b';
  }
  window.addEventListener('online', updateNet);
  window.addEventListener('offline', updateNet);
  updateNet();

  /* ==================== Focus ==================== */
  function focusPin(){ try { pinEl.focus(); pinEl.select?.(); } catch(_) {} }
  function focusPinSafely(){ if (document.activeElement !== qEl) focusPin(); }
  document.addEventListener('visibilitychange', () => { if (!document.hidden) focusPinSafely(); });
  window.addEventListener('pageshow', (e) => { if (e.persisted) focusPinSafely(); });

  /* ==================== Action toggle ==================== */
  function setAction(a){
    const inActive = a === 'in';
    btnIn.classList.toggle('active', inActive);
    btnOut.classList.toggle('active', !inActive);
    setTimeout(focusPinSafely, 0);
  }
  btnIn.addEventListener('click', () => setAction('in'));
  btnOut.addEventListener('click', () => setAction('out'));
  window.addEventListener('keydown', (e)=>{ if(e.key==='ArrowLeft') setAction('in'); if(e.key==='ArrowRight') setAction('out'); });

  /* ==================== Helpers ==================== */
  const digitsOnly = s => String(s||'').replace(/\D+/g,'');
  function normalizeToTenDigits(raw) {
    const d = digitsOnly(raw);
    if (!d) return '';
    return d.length <= 10 ? d.padStart(10, '0') : d.slice(-10);
  }
  function makeKey({ pin, personId }) { return pin ? `pin:${pin}` : `pid:${personId}`; }
  function canSendNow(key) {
    const now = Date.now();
    const last = lastSeenMap.get(key) || 0;
    if (now - last < DEDUPE_WINDOW_MS) return false;
    lastSeenMap.set(key, now);
    return true;
  }

  /* ==================== Submit + student handoff ==================== */
  async function submitPinOrId({ pin, personId }) {
    const act = btnIn.classList.contains('active') ? 'in' : 'out';
    const key = makeKey({ pin, personId });
    if (!canSendNow(key)) { showToast('Duplicate scan ignored (5s)','info'); focusPinSafely(); return; }

    const body = new URLSearchParams({ action: act, ...(pin?{pin}:{personId}) }).toString();
    try{
      const res = await fetch(ENDPOINT, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body });
      const txt = await res.text(); let data=null; try{ data = JSON.parse(txt); }catch{}

      // Student path (backend confirms & returns legacyId + name)
      if (data && data.status === 'student_in' && data.legacyId) {
        const legacy = String(data.legacyId);
        const name = data.student || 'Student';
        const kioskURL = VC_BASE + encodeURIComponent(legacy);
        window.open(kioskURL, '_blank', 'width=480,height=820,noopener,noreferrer');
        showToast(`${name} â€” sent to Veracross`, 'ok', 'student');
        chimeOK();
        return;
      }

      if (!res.ok || (data && data.error)) {
        showToast((data && data.error) || ('Error ' + res.status), 'fail');
        chimeFAIL();
        return;
      }

      // Faculty success
      const { status, firstName, lastName, time } = data || {};
      const verb = (status === 'in') ? 'IN' : (status === 'out') ? 'OUT' : (status||'').toUpperCase();
      const line = `${firstName||''} ${lastName||''} signed ${verb} â€” ${time||''}`.trim();
      showToast(line || 'Done.', 'ok', 'faculty');
      chimeOK();
    }catch(err){
      showToast('Network error', 'fail');
      console.error('submitPinOrId error', err);
      chimeFAIL();
    }finally{
      lastSubmitAt = Date.now();
      focusPinSafely();
    }
  }

  /* ==================== USB wedge â€” auto submit on quiet ==================== */
  let wedgeTimer = null;
  const WEDGE_QUIET_MS = 90;
  pinEl.addEventListener('input', ()=>{
    clearTimeout(wedgeTimer);
    wedgeTimer = setTimeout(()=>{
      const nowDigits = digitsOnly(pinEl.value);
      if (nowDigits.length < 10) return;
      const ten = nowDigits.slice(-10);
      if (Date.now() - lastSubmitAt < COOLDOWN_MS) return;
      submitPinOrId({ pin: ten });
      pinEl.value = '';
      focusPinSafely();
    }, WEDGE_QUIET_MS);
  });
  pinEl.addEventListener('keydown',(e)=>{
    if (e.key === 'Enter') { e.preventDefault(); e.stopPropagation(); } // stop double-submit
  });

  /* ==================== Search (faculty first, then students) ==================== */
  let searchTimer = null, searchAbort = null, searchToken = 0;
  const norm = s => String(s||'').toLowerCase();

  function sectionHeader(text){
    const row = document.createElement('div'); row.className='row';
    const tag = document.createElement('span'); tag.className='sectionTag'; tag.textContent = text;
    row.appendChild(tag); row.appendChild(document.createElement('div'));
    return row;
  }
  function resultRow(label, btnText, onClick){
    const row = document.createElement('div'); row.className='row';
    const name = document.createElement('div'); name.className='name'; name.textContent = label;
    const btn  = document.createElement('button'); btn.className='actionBtn'; btn.textContent = btnText;
    btn.addEventListener('click', onClick);
    row.appendChild(name); row.appendChild(btn);
    return row;
  }

  function scoreName(q, first, last, fullLF){
    const nq = norm(q), nf = norm(first), nl = norm(last);
    const nfl = (nf + ' ' + nl).trim();
    const nlf = fullLF ? norm(fullLF) : (nl ? (nl + ', ' + nf) : nf);
    if (nfl === nq || nlf === nq) return 1000;
    if (nf === nq || nl === nq) return 900;
    let s = 0;
    if (nf.startsWith(nq)) s += 120;
    if (nl.startsWith(nq)) s += 110;
    if (nfl.startsWith(nq)) s += 100;
    if (nlf.startsWith(nq)) s += 95;
    if (nf.includes(nq)) s += 30;
    if (nl.includes(nq)) s += 28;
    if (nfl.includes(nq)) s += 26;
    if (nlf.includes(nq)) s += 24;
    return s;
  }
  function flipLF(full){
    const i = String(full||'').indexOf(',');
    if (i >= 0) { return { first: full.slice(i+1).trim(), last: full.slice(0,i).trim() }; }
    return { first: String(full||'').trim(), last: '' };
  }

  qEl.addEventListener('input', ()=>{
    clearTimeout(searchTimer);
    const q = qEl.value.trim();
    const box = $('#results');

    if (!q) {
      try { searchAbort?.abort(); } catch(_) {}
      searchAbort = null; searchToken++;
      box.innerHTML = '';
      return;
    }
    searchTimer = setTimeout(()=>doSearch(q), 100);
  });

  qEl.addEventListener('keydown', (e)=>{
    if (e.key === 'Enter') {
      clearTimeout(searchTimer);
      const q = qEl.value.trim();
      if (!q) {
        try { searchAbort?.abort(); } catch(_) {}
        searchAbort = null; searchToken++; $('#results').innerHTML = '';
        e.preventDefault(); return;
      }
      doSearch(q); e.preventDefault();
    }
  });

  async function doSearch(q){
    try { searchAbort?.abort(); } catch(_){}
    searchAbort = new AbortController();
    const myToken = ++searchToken;
    const sig = searchAbort.signal;
    const box = $('#results'); box.innerHTML = '<div class="muted">Searchingâ€¦</div>';

    try{
      const facP = fetch(`${ENDPOINT}?action=search&q=${encodeURIComponent(q)}`, {signal:sig}).then(r=>r.json());
      const stuP = fetch(`${ENDPOINT}?action=studentSearch&q=${encodeURIComponent(q)}`, {signal:sig}).then(r=>r.json());
      let [facRes, stuRes] = await Promise.allSettled([facP, stuP]);

      if (myToken !== searchToken || !qEl.value.trim()) return;

      facRes = facRes.status==='fulfilled' && Array.isArray(facRes.value) ? facRes.value : [];
      stuRes = stuRes.status==='fulfilled' && Array.isArray(stuRes.value) ? stuRes.value : [];

      const facDedup = new Map();
      facRes.forEach(r=>{
        const pid = String(r.personId||'');
        const s = scoreName(q, r.firstName||'', r.lastName||'');
        const cur = facDedup.get(pid);
        if (!cur || s > cur._score) facDedup.set(pid, {...r, _score:s});
      });
      const facSorted = Array.from(facDedup.values()).sort((a,b)=>b._score - a._score).slice(0,30);

      const stuDedup = new Map();
      stuRes.forEach(r=>{
        const lf = String(r.fullName||'');
        const flip = flipLF(lf);
        const legacy = String(r.legacyId||'');
        const s = scoreName(q, flip.first||'', flip.last||'', lf);
        const cur = stuDedup.get(legacy);
        if (!cur || s > cur._score) stuDedup.set(legacy, {...r, _flip:flip, _score:s});
      });
      const stuSorted = Array.from(stuDedup.values()).sort((a,b)=>b._score - a._score).slice(0,30);

      if (myToken !== searchToken || !qEl.value.trim()) return;

      const frag = document.createDocumentFragment();
      if (facSorted.length) {
        frag.appendChild(sectionHeader('FACULTY'));
        facSorted.forEach(({ firstName, lastName, personId })=>{
          frag.appendChild(resultRow(`${firstName} ${lastName}`, 'Submit', ()=> submitPinOrId({ personId })));
        });
      }
      if (stuSorted.length) {
        frag.appendChild(sectionHeader('STUDENTS'));
        stuSorted.forEach(({ fullName, legacyId, _flip })=>{
          const label = (_flip.first ? `${_flip.first} ${_flip.last}` : fullName).trim();
          frag.appendChild(resultRow(label, 'Sign IN', ()=>{
            const kioskURL = VC_BASE + encodeURIComponent(legacyId);
            window.open(kioskURL, '_blank', 'width=480,height=820,noopener,noreferrer');
            showToast(`${label} â€” sent to Veracross`, 'ok', 'student');
            chimeOK();
          }));
        });
      }

      box.innerHTML = '';
      if (!facSorted.length && !stuSorted.length) {
        box.innerHTML = '<div class="muted">No matches found.</div>';
      } else {
        box.appendChild(frag);
      }
    } catch (e){
      if (e && e.name === 'AbortError') return;
      if (myToken === searchToken) $('#results').innerHTML = '<div class="muted">Search failed.</div>';
    }
  }

  /* ==================== Init ==================== */
  document.addEventListener('DOMContentLoaded', ()=>{
    initTheme();
    setAction('in');
    showToast('Ready â€” scan card or search', 'info');
    focusPinSafely();
  });
</script>
</body>
</html>
