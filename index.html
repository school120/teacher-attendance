<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
<title>Attendance â€” Guard Console</title>
<meta name="description" content="IN/OUT for faculty + student Veracross sign-in with fallback." />
<meta name="color-scheme" content="light dark">
<meta id="meta-theme" name="theme-color" content="#ffffff">
<style>
  :root{
    --bg:#f6f7fb; --card:#ffffff; --text:#0f172a; --muted:#667085; --border:#e5e7eb;
    --in:#16a34a; --out:#dc2626; --blue:#2563eb;
    --radius-lg:14px; --radius-xl:18px;
    --shadow-1:0 10px 30px rgba(0,0,0,.08);
    --shadow-2:0 14px 40px rgba(0,0,0,.18);
    --ring:0 0 0 6px rgba(59,130,246,.16);
    --safe-top: env(safe-area-inset-top);
    --safe-right: env(safe-area-inset-right);
    --safe-bottom: env(safe-area-inset-bottom);
    --safe-left: env(safe-area-inset-left);
  }
  body.dark{ --bg:#0b1020; --card:#111827; --text:#f3f4f6; --muted:#cbd5e1; --border:#374151; }
  *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
  html, body { height:100%; margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
  html { overflow-x:hidden; }
  body{ min-height:100svh; overscroll-behavior-y:contain; overflow:auto; -webkit-overflow-scrolling:touch; }

  .wrap{
    margin:auto; width:min(1100px,96%); background:var(--card);
    border-radius:var(--radius-xl); box-shadow:var(--shadow-1); position:relative;
    min-height:calc(100svh - var(--safe-top) - var(--safe-bottom));
    padding: calc(28px + var(--safe-top)) calc(28px + var(--safe-right)) calc(28px + var(--safe-bottom)) calc(28px + var(--safe-left));
    overflow:visible; overflow-x:clip;
  }

  h1{ margin:0 0 8px; font-weight:800; font-size:28px; letter-spacing:.2px; }
  .muted{ color:var(--muted); }
  .badges{ position:absolute; right:calc(18px + var(--safe-right)); top:calc(18px + var(--safe-top)); display:flex; gap:8px; align-items:center; }
  .badge{ font-size:12px; font-weight:800; padding:6px 10px; border-radius:999px; border:1px solid var(--border); background:var(--card); color:var(--text); }
  .gear{ border:1px solid var(--border); background:var(--card); color:var(--text); border-radius:10px; padding:6px 10px; cursor:pointer; font-weight:800; display:flex; align-items:center; gap:6px; transition:background .2s ease; }
  .gear:hover{ background: color-mix(in oklab, var(--card) 90%, var(--text) 10%); }
  .gear:focus-visible{ outline:none; box-shadow:var(--ring); }

  .toast{
    position:fixed; left:50%; bottom:calc(24px + var(--safe-bottom)); transform:translateX(-50%) translateY(20px);
    opacity:0; background:var(--card); border:1px solid var(--border); box-shadow:0 8px 30px rgba(0,0,0,.12);
    border-radius:14px; padding:16px 20px; font-weight:800; transition:all .25s ease; pointer-events:none; font-size:18px; z-index:50;
  }
  .toast.show{ opacity:1; transform:translateX(-50%) translateY(0); }

  .segment{ display:flex; gap:14px; width:100%; margin:20px 0; }
  .segment.segment-xl button{
    flex:1 1 0; border:2px solid #d1d5db; border-radius:16px; font-weight:900; font-size:42px; line-height:1.1; min-height:96px;
    padding:22px 24px; cursor:pointer; color:#111; background:linear-gradient(180deg, #f8fafc 0%, #eef2f7 100%);
    transition:transform .06s ease, box-shadow .2s ease, background .2s ease; box-shadow:0 4px 10px rgba(0,0,0,.05);
  }
  .segment.segment-xl button.active#actIn{
    background:linear-gradient(180deg, #16a34a 0%, #15803d 100%); color:#fff; border-color:#16a34a; box-shadow:0 0 0 4px rgba(22,163,74,.25);
  }
  .segment.segment-xl button.active#actOut{
    background:linear-gradient(180deg, #dc2626 0%, #991b1b 100%); color:#fff; border-color:#dc2626; box-shadow:0 0 0 4px rgba(220,38,38,.25);
  }

  .grid{ display:grid; grid-template-columns:1fr 1fr; gap:18px; align-items:stretch; }
  .card{ border:1px solid var(--border); border-radius:14px; background:var(--card); padding:16px; display:flex; flex-direction:column; overflow:hidden; }
  .card h2{ margin:0 0 12px; font-size:20px; }

  input[type=text], input[type=password], input[type=search]{
    width:100%; padding:18px 20px; font-size:24px; border:1.5px solid var(--border); border-radius:12px; background:var(--card); color:var(--text);
    outline:none; transition:border-color .2s ease, box-shadow .2s ease, background .2s ease;
  }
  input[type=text]:focus-visible, input[type=password]:focus-visible, input[type=search]:focus-visible{ border-color:#3b82f6; box-shadow:var(--ring); }

  .list{ display:grid; gap:12px; max-height:460px; overflow:auto; margin-top:14px; background: var(--card); padding-right:16px; }
  .list::-webkit-scrollbar { width:10px; height:10px; }
  .list::-webkit-scrollbar-thumb { border-radius:999px; background:#b7c0d133; }
  .list::-webkit-scrollbar-track { background:var(--card); }
  .list { scrollbar-color:#98a2b33d var(--card); scrollbar-width:thin; }
  .row{ display:grid; grid-template-columns:minmax(0,1fr) auto; align-items:center; gap:12px; padding:14px 16px; border:1px solid var(--border); border-radius:12px; background: var(--card); }
  .name{ min-width:0; font-weight:800; font-size:20px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
  .sectionTitle{ font-size:13px; font-weight:900; color:var(--muted); text-transform:uppercase; letter-spacing:.08em; margin:4px 2px; }

  .actionBtn{
    --c: var(--blue);
    background:linear-gradient(180deg, var(--c) 0%, color-mix(in srgb, var(--c) 80%, #000 20%) 100%);
    color:#fff; font-size:20px; padding:16px 20px; border:2px solid var(--c); border-radius:14px; font-weight:900; cursor:pointer;
    transition:transform .06s ease, filter .15s ease, box-shadow .2s ease; box-shadow:0 6px 14px rgba(0,0,0,.12); justify-self:end;
  }
  .actionBtn:hover{ filter:brightness(.96); transform:translateY(-1px); }
  .actionBtn:active{ transform:scale(.985); box-shadow:inset 0 3px 8px rgba(0,0,0,.25); }

  .nfcBar{ display:flex; align-items:center; gap:12px; flex-wrap:wrap; margin-top:10px; }
  .nfcBtn{ padding:14px 18px; border-radius:12px; border:2px solid #4f46e5; color:#fff; background:#4f46e5; font-weight:800; cursor:pointer; font-size:18px; }
  .nfcBtn.secondary{ background:transparent; color:#4f46e5; }

  /* Ribbon for manual Veracross fallback */
  .ribbon{
    display:none; position:fixed; left:50%; transform:translateX(-50%);
    bottom:calc(80px + var(--safe-bottom));
    background:var(--card); border:1px solid var(--border); border-radius:14px; box-shadow:var(--shadow-2);
    padding:12px; z-index:60; gap:8px; align-items:center;
  }
  .ribbon .pill{ padding:10px 14px; border-radius:12px; border:1px solid var(--border); background:var(--card); font-weight:800; cursor:pointer; }
  .ribbon .pill.primary{ background:#111827; color:#fff; border-color:#111827; }
  .ribbon .id{ font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:16px; padding:8px 10px; background:#f3f4f6; border-radius:8px; }

  /* Manual Student Entry card */
  .padRow{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  .bigBtn{ padding:16px 20px; border-radius:14px; border:2px solid #111827; background:#111827; color:#fff; font-weight:900; font-size:18px; cursor:pointer; }
  @media (max-width:900px){ .grid{ grid-template-columns:1fr; } .segment.segment-xl button{ font-size:36px; min-height:88px; } }
</style>
</head>
<body>
  <div class="wrap" role="application" aria-label="Attendance Guard Console">
    <div class="badges" aria-live="polite" aria-atomic="true">
      <div id="netBadge" class="badge">Online</div>
      <div id="nfcBadge" class="badge" style="display:none;">NFC Ready</div>
      <button id="themeBtn" class="gear" title="Toggle theme" aria-label="Toggle dark mode">ðŸŒ™ Dark</button>
    </div>

    <h1>Attendance â€” Guard Console</h1>
    <p class="muted">Choose <b>IN</b> or <b>OUT</b>. Faculty uses Quick Pin; students are sent to Veracross. Name search supports both.</p>

    <div class="segment segment-xl" role="tablist" aria-label="Action">
      <button id="actIn" class="active" role="tab" aria-selected="true" type="button">IN</button>
      <button id="actOut" role="tab" aria-selected="false" type="button">OUT</button>
    </div>

    <div class="grid">
      <!-- LEFT: Card / Quick Pin + Manual Student Entry -->
      <div class="card">
        <h2>Cougar Card / Quick Pin</h2>
        <input id="pin" type="password" maxlength="32" inputmode="numeric" autocomplete="one-time-code"
               placeholder="Swipe or tap card" aria-label="Cougar Card / Quick Pin" />
        <div id="nfcBar" class="nfcBar" style="display:none;">
          <button id="nfcStart" class="nfcBtn">Scan with NFC</button>
          <button id="nfcStop" class="nfcBtn secondary">Stop</button>
        </div>

        <div style="margin-top:18px;"></div>
        <h2>Manual Student Entry</h2>
        <div class="padRow">
          <input id="stuId" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="Legacy Student ID (10 digits)" />
          <button id="stuSignIn" class="bigBtn">Student Sign In (Veracross)</button>
        </div>
      </div>

      <!-- RIGHT: Lookup by Name -->
      <div class="card">
        <h2>Lookup by Name</h2>
        <input id="q" type="search" inputmode="search" enterkeyhint="search"
               autocapitalize="words" autocorrect="off" spellcheck="false"
               placeholder="Search faculty or students" aria-label="Search by name" />
        <div id="results" class="list" role="list" aria-live="polite"></div>
      </div>
    </div>

    <div id="toast" class="toast" role="status" aria-live="polite"></div>
    <!-- Manual action ribbon for students -->
    <div id="ribbon" class="ribbon" role="group" aria-label="Veracross fallback">
      <span>Student:</span>
      <span id="ribbonName" class="name"></span>
      <span class="id" id="ribbonId"></span>
      <button id="copyBtn" class="pill">Copy Legacy ID</button>
      <button id="openBtn" class="pill primary">Open Veracross Kiosk</button>
    </div>
  </div>

  <!-- Hidden background target for Veracross -->
  <iframe name="vc_bg" style="display:none;width:0;height:0;border:0;" aria-hidden="true"></iframe>

<script>
/* ===== Config ===== */
const ENDPOINT = 'https://script.google.com/macros/s/AKfycbzF4Hy0W2ZBbB6dOPRcT3PIKsEZekW2HtHuPAAp99jwUpasH7Iq1mMYCtQ35WEPfkiQQw/exec';
const KIOSK_URL = 'https://checkin.veracross.com/frisch/kiosk/entrance'; // visible page
const KIOSK_POST = 'https://checkin.veracross.com/frisch/checkin/log';   // background endpoint
const COOLDOWN_MS = 400;
const THEME_KEY = 'theme';

/* ===== DOM ===== */
const $ = s => document.querySelector(s);
const pinEl = $('#pin'), qEl = $('#q'), toastEl = $('#toast');
const btnIn = $('#actIn'), btnOut = $('#actOut');
const netBadge = $('#netBadge'), nfcBadge = $('#nfcBadge');
const nfcBar = $('#nfcBar'), nfcStartBtn = $('#nfcStart'), nfcStopBtn = $('#nfcStop');

/* Ribbon */
const ribbon = $('#ribbon'), ribbonName = $('#ribbonName'), ribbonId = $('#ribbonId');
const copyBtn = $('#copyBtn'), openBtn = $('#openBtn');

/* Manual student */
const stuIdEl = $('#stuId'), stuSignInBtn = $('#stuSignIn');

let lastSubmitAt = 0;

/* ===== Theme ===== */
function setTheme(mode){
  const dark = mode === 'dark';
  document.body.classList.toggle('dark', dark);
  $('#meta-theme').content = dark ? '#0b1020' : '#ffffff';
  localStorage.setItem(THEME_KEY, dark ? 'dark' : 'light');
}
function initTheme(){
  const saved = localStorage.getItem(THEME_KEY);
  if (saved) setTheme(saved);
  else setTheme(window.matchMedia?.('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
}
$('#themeBtn').addEventListener('click', ()=> setTheme(document.body.classList.contains('dark') ? 'light' : 'dark'));

/* ===== Toast ===== */
let toastTimer=null;
function showToast(text, tone='neutral'){
  toastEl.textContent = text;
  toastEl.classList.add('show');
  // reset style
  toastEl.style.background = 'var(--card)';
  toastEl.style.borderColor = 'var(--border)';
  toastEl.style.color = 'var(--text)';
  if (tone==='ok'){ toastEl.style.background='#ecfdf5'; toastEl.style.borderColor='#065f46'; toastEl.style.color='#065f46'; }
  if (tone==='err'){ toastEl.style.background='#fee2e2'; toastEl.style.borderColor='#b91c1c'; toastEl.style.color='#b91c1c'; }
  if (tone==='warn'){ toastEl.style.background='#fff7ed'; toastEl.style.borderColor='#92400e'; toastEl.style.color='#92400e'; }
  clearTimeout(toastTimer); toastTimer=setTimeout(()=>toastEl.classList.remove('show'), 2400);
}

/* ===== Net badge ===== */
function updateNet(){
  const on = navigator.onLine;
  netBadge.textContent = on ? 'Online' : 'Offline';
  netBadge.style.background = on ? 'var(--card)' : '#fee2e2';
  netBadge.style.color = on ? 'var(--text)' : '#991b1b';
}
window.addEventListener('online', updateNet);
window.addEventListener('offline', updateNet);
updateNet();

/* ===== Focus helpers ===== */
function focusPin(){ try { pinEl.focus(); pinEl.select?.(); } catch(_) {} }
function focusPinSafely(){ if (document.activeElement !== qEl && document.activeElement !== stuIdEl) focusPin(); }
document.addEventListener('visibilitychange', () => { if (!document.hidden) focusPinSafely(); });
window.addEventListener('pageshow', (e) => { if (e.persisted) focusPinSafely(); });

/* ===== IN/OUT toggle ===== */
function setAction(a){
  const inActive = a === 'in';
  btnIn.classList.toggle('active', inActive);
  btnOut.classList.toggle('active', !inActive);
  setTimeout(focusPinSafely, 0);
}
btnIn.addEventListener('click', () => setAction('in'));
btnOut.addEventListener('click', () => setAction('out'));
window.addEventListener('keydown', (e)=>{ if(e.key==='ArrowLeft') setAction('in'); if(e.key==='ArrowRight') setAction('out'); });

/* ===== Helpers ===== */
const digitsOnly = s => String(s||'').replace(/\D+/g,'');
const padLeft10 = d => d.length<=10 ? d.padStart(10,'0') : d.slice(-10);
function lfToFl(name){ const m=String(name||'').match(/^\s*([^,]+)\s*,\s*(.+)\s*$/); return m ? `${m[2]} ${m[1]}`.trim() : String(name||''); }

/* ===== Veracross background POST (hidden) + manual fallback ribbon ===== */
function postToVeracrossBackground(legacyId){
  // fire-and-forget POST to KIOSK_POST in a hidden iframe
  const form = document.createElement('form');
  form.method='POST'; form.action=KIOSK_POST; form.target='vc_bg'; form.style.display='none';
  const add=(n,v)=>{ const i=document.createElement('input'); i.type='hidden'; i.name=n; i.value=v; form.appendChild(i); };
  add('legacy_id', legacyId); add('kiosk_type','4'); add('check_in_method','3'); add('kiosk','34');
  document.body.appendChild(form);
  try { form.submit(); } catch {}
  setTimeout(()=>form.remove(), 1500);
}

function showRibbon(studentName, legacyId){
  ribbonName.textContent = studentName || '';
  ribbonId.textContent = legacyId || '';
  ribbon.style.display = 'flex';
}
function hideRibbon(){ ribbon.style.display = 'none'; }

copyBtn.addEventListener('click', async ()=>{
  try { await navigator.clipboard.writeText(ribbonId.textContent || ''); showToast('Legacy ID copied', 'ok'); }
  catch { showToast('Copy failed', 'warn'); }
});
openBtn.addEventListener('click', ()=>{ window.open(KIOSK_URL, '_blank', 'noopener'); });

/* ===== Backend calls ===== */
async function postFaculty({ pin, personId }) {
  const act = btnIn.classList.contains('active') ? 'in' : 'out';
  const body = new URLSearchParams({ action: act, ...(pin?{pin}:{personId}) });
  const res = await fetch(ENDPOINT, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body });
  const text = await res.text(); let data=null; try{ data=JSON.parse(text);}catch{}
  return { ok: res.ok && data && !data.error, data, status:res.status, raw:text };
}

async function searchFaculty(q){ const r=await fetch(`${ENDPOINT}?action=search&q=${encodeURIComponent(q)}`); return r.json(); }

async function fetchJson(u){ try{ const r=await fetch(u); const t=await r.text(); try{ return JSON.parse(t);}catch{return null;} }catch{return null;} }
async function searchStudents(q){
  let d = await fetchJson(`${ENDPOINT}?action=studentSearch&q=${encodeURIComponent(q)}`);
  if (!Array.isArray(d) || !d.length) d = await fetchJson(`${ENDPOINT}?action=studentsearch&q=${encodeURIComponent(q)}`);
  return Array.isArray(d) ? d : [];
}
async function getStudentByLegacy(id){
  let d = await fetchJson(`${ENDPOINT}?action=studentByLegacy&id=${encodeURIComponent(id)}`);
  if (!d || d.error) d = await fetchJson(`${ENDPOINT}?action=studentbylegacy&id=${encodeURIComponent(id)}`);
  return (d && d.found) ? d : { found:false };
}

/* ===== Unified submit with colored toasts ===== */
async function submitPinOrId({ pin, personId, uid }) {
  const res = await postFaculty({ pin, personId });
  if (!res.ok) {
    const msg = (res.data && res.data.error) || ('Error ' + res.status);
    // Student fallback if "not found"
    if (/not\s*found/i.test(msg) && pin) {
      const s = await getStudentByLegacy(pin);
      if (s && s.found) {
        const display = lfToFl(s.fullName || '') || ('Student ' + s.legacyId);
        // Try background POST, always show ribbon so guard can manually finish if needed
        postToVeracrossBackground(s.legacyId);
        showRibbon(display, s.legacyId);
        showToast(`${display} â€” sent to Veracross`, 'ok');
        return;
      }
    }
    showToast(msg, 'err'); return;
  }

  const data = res.data || {};
  if (data.status === 'in' || data.status === 'out') {
    const { status, firstName, lastName, time, paired } = data;
    const verb = status==='in' ? 'IN' : 'OUT';
    const extra = (status==='out' && paired===false) ? ' (no prior IN)' : '';
    showToast(`${(firstName||'') + ' ' + (lastName||'')}`.trim() + ` â€” ${verb}${extra} at ${time||''}`, 'ok');
  } else if (data.status === 'student_in') {
    const display = data.student || ('Student ' + (data.legacyId||''));
    postToVeracrossBackground(String(data.legacyId||''));
    showRibbon(display, String(data.legacyId||''));
    showToast(`${display} â€” sent to Veracross`, 'ok');
  } else {
    showToast('Unknown response', 'warn');
  }
}

/* ===== Wedge / Quick Pin input ===== */
let wedgeTimer=null;
const WEDGE_QUIET_MS=120;

pinEl.addEventListener('input', ()=>{
  clearTimeout(wedgeTimer);
  wedgeTimer=setTimeout(async ()=>{
    const raw = pinEl.value || '';
    const d = digitsOnly(raw);
    if (!d) return;
    if (d.length < 10) { showToast('ID too short', 'warn'); pinEl.value=''; focusPin(); return; }
    const ten = padLeft10(d);
    if (Date.now() - lastSubmitAt < COOLDOWN_MS) return;
    lastSubmitAt = Date.now();
    await submitPinOrId({ pin: ten });
    pinEl.value=''; focusPin();
  }, WEDGE_QUIET_MS);
});

/* ===== Name search (faculty + students) ===== */
let searchDebounce = null, searchController = null, searchSeq = 0;

const normKey = (a,b)=>`${String(a||'').trim().toLowerCase()}|${String(b||'').trim().toLowerCase()}`;
function uniqueBy(arr, keyFn){ const seen=new Set(), out=[]; for(const it of arr||[]){ const k=keyFn(it); if(!k||seen.has(k)) continue; seen.add(k); out.push(it);} return out; }

function sortFac(a,b){ const al=String(a.lastName||'').toLowerCase(); const bl=String(b.lastName||'').toLowerCase();
  if (al!==bl) return al<bl?-1:1; const af=String(a.firstName||'').toLowerCase(); const bf=String(b.firstName||'').toLowerCase(); return af<bf?-1:af>bf?1:0; }
function sortStu(a,b){ const an=String(a.fullName||'').toLowerCase(); const bn=String(b.fullName||'').toLowerCase(); return an<bn?-1:an>bn?1:0; }

qEl.addEventListener('input', () => {
  clearTimeout(searchDebounce);
  const q = qEl.value.trim();
  const box = $('#results'); box.replaceChildren();
  if (!q || q.length < 2) return; // do nothing if empty/1 char
  searchDebounce = setTimeout(() => doSearch(q, box), 200);
});

async function doSearch(q, box) {
  if (!q || q.length < 2) return;
  if (searchController) try { searchController.abort(); } catch(_) {}
  searchController = new AbortController();
  const signal = searchController.signal;
  const mySeq = ++searchSeq;

  let facList=[], stuList=[];
  try {
    const [facRes, stuRes] = await Promise.allSettled([
      fetch(`${ENDPOINT}?action=search&q=${encodeURIComponent(q)}`, { signal }),
      (async()=>{ const a = await searchStudents(q); return a; })()
    ]);
    if (mySeq !== searchSeq) return;
    if (facRes.status==='fulfilled') facList = await facRes.value.json();
    if (stuRes.status==='fulfilled') stuList = stuRes.value;
  } catch { box.textContent = 'Search failed.'; return; }

  if (!Array.isArray(facList)) facList = [];
  if (!Array.isArray(stuList)) stuList = [];

  facList = uniqueBy(facList.filter(r=>r && (r.firstName||r.lastName)),
                     r => String(r.personId||'').trim() || normKey(r.firstName, r.lastName)).sort(sortFac);

  stuList = uniqueBy(stuList.filter(r=>r && (r.fullName||r.legacyId)),
                     r => String(r.legacyId||'').trim() || String(r.fullName||'').trim().toLowerCase()).sort(sortStu);

  if (!facList.length && !stuList.length) { const div=document.createElement('div'); div.className='muted'; div.textContent='No matches.'; box.appendChild(div); return; }

  const addHeader = (t)=>{ const h=document.createElement('div'); h.className='sectionTitle'; h.textContent=t; box.appendChild(h); };

  if (facList.length) {
    addHeader('Faculty');
    for (const { firstName, lastName, personId } of facList) {
      const row=document.createElement('div'); row.className='row'; row.setAttribute('role','listitem');
      const name=document.createElement('div'); name.className='name'; name.textContent=`${firstName||''} ${lastName||''}`.trim();
      const btn=document.createElement('button'); btn.className='actionBtn'; btn.textContent='Submit';
      btn.addEventListener('click', async ()=>{
        const r = await postFaculty({ personId });
        if (r.ok) {
          const { status, firstName, lastName, time, paired } = r.data || {};
          const verb = status==='in'?'IN':'OUT'; const extra = (status==='out' && paired===false) ? ' (no prior IN)' : '';
          showToast(`${(firstName||'') + ' ' + (lastName||'')}`.trim() + ` â€” ${verb}${extra} at ${time||''}`,'ok');
        } else {
          showToast((r.data && r.data.error) || 'Error', 'err');
        }
        setTimeout(()=>focusPin(),0);
      });
      row.appendChild(name); row.appendChild(btn); box.appendChild(row);
    }
  }

  if (stuList.length) {
    addHeader('Students');
    for (const { fullName, legacyId } of stuList) {
      const row=document.createElement('div'); row.className='row'; row.setAttribute('role','listitem');
      const name=document.createElement('div'); name.className='name'; name.textContent=lfToFl(fullName||'');
      const btn=document.createElement('button'); btn.className='actionBtn'; btn.textContent='Sign In';
      btn.addEventListener('click', async ()=>{
        if (!btnIn.classList.contains('active')) { showToast('Students can only sign IN', 'err'); return; }
        postToVeracrossBackground(String(legacyId||'')); // background
        showRibbon(lfToFl(fullName||''), String(legacyId||''));
        showToast(`${lfToFl(fullName||'')} â€” sent to Veracross`, 'ok');
        setTimeout(()=>focusPin(),0);
      });
      row.appendChild(name); row.appendChild(btn); box.appendChild(row);
    }
  }
}

/* ===== Manual Student Entry ===== */
stuSignInBtn.addEventListener('click', ()=>{
  if (!btnIn.classList.contains('active')) { showToast('Students can only sign IN', 'err'); return; }
  const d = padLeft10(digitsOnly(stuIdEl.value||''));
  if (!d || d.length!==10) { showToast('Enter a 10-digit Legacy ID', 'warn'); stuIdEl.focus(); return; }
  postToVeracrossBackground(d);
  showRibbon('Student', d);
  showToast(`Student â€” sent to Veracross`, 'ok');
  stuIdEl.value=''; focusPin();
});

/* ===== NFC (Android Chrome) â€” optional ===== */
function supportsWebNFC(){ return 'NDEFReader' in window; }
let ndef=null, nfcStarted=false;
const hexToBytes=(hex)=>{ const s=(hex||'').replace(/[^0-9a-f]/gi,''); const out=[]; for(let i=0;i<s.length;i+=2) out.push(parseInt(s.substr(i,2),16)); return out; };
const numLE=(a)=>a.reduceRight((x,b)=>(x*256+b)>>>0,0);
const numBE=(a)=>a.reduce((x,b)=>(x*256+b)>>>0,0);
const pad10=(n)=>{ const s=String(n>>>0); return s.length>=10? s.slice(-10):s.padStart(10,'0'); };
function uidToTen(uidHex){ const b=hexToBytes(uidHex); return pad10(numLE(b.slice(-4))); }

if (supportsWebNFC()) {
  nfcBar.style.display = ''; nfcStopBtn.disabled = true;
  nfcStartBtn.addEventListener('click', async ()=>{
    if (nfcStarted) return;
    try{
      ndef=new NDEFReader(); await ndef.scan(); nfcStarted=true;
      nfcBadge.style.display=''; nfcStartBtn.disabled=true; nfcStopBtn.disabled=false;
      showToast('NFC scanning started');
      ndef.onreading=(ev)=>{
        const uidHex=String(ev.serialNumber||'').toUpperCase().replace(/[^0-9A-F]/g,'');
        let ten = uidToTen(uidHex);
        ten = padLeft10(ten);
        if (!ten || ten.length!==10) { showToast('Unrecognized NFC', 'warn'); return; }
        if (Date.now()-lastSubmitAt>=COOLDOWN_MS) { lastSubmitAt=Date.now(); submitPinOrId({ pin: ten }); }
      };
      ndef.onreadingerror=()=>showToast('NFC read error','warn');
    }catch{ showToast('NFC not permitted or unavailable', 'warn'); }
  });
  nfcStopBtn.addEventListener('click', ()=>{
    if (ndef){ ndef.onreading=null; ndef.onreadingerror=null; }
    nfcStarted=false; nfcStartBtn.disabled=false; nfcStopBtn.disabled=true;
    showToast('NFC stopped');
  });
}

/* ===== Init ===== */
document.addEventListener('DOMContentLoaded', ()=>{
  initTheme();
  setAction('in');
  focusPin(); // focus quick pin on load
});
</script>
</body>
</html>
