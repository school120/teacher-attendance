<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
<title>Teacher Attendance ‚Äî Guard Console</title>
<meta name="description" content="Guard console for IN/OUT with Cougar Card swipe/tap or name lookup." />
<meta name="color-scheme" content="light dark">
<meta id="meta-theme" name="theme-color" content="#ffffff">
<style>
  :root{
    --bg:#f6f7fb; --card:#ffffff; --text:#0f172a; --muted:#667085; --border:#e5e7eb;
    --in:#16a34a; --out:#dc2626; --blue:#2563eb;
    --radius-lg:14px; --radius-xl:18px;
    --shadow-1:0 10px 30px rgba(0,0,0,.08);
    --shadow-2:0 14px 40px rgba(0,0,0,.18);
    --ring:0 0 0 6px rgba(59,130,246,.16);

    --safe-top: env(safe-area-inset-top);
    --safe-right: env(safe-area-inset-right);
    --safe-bottom: env(safe-area-inset-bottom);
    --safe-left: env(safe-area-inset-left);
  }
  body.dark{ --bg:#0b1020; --card:#111827; --text:#f3f4f6; --muted:#cbd5e1; --border:#374151; }

  *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
  html, body { height:100%; margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
  html { overflow-x:hidden; }
  body{ min-height:100svh; overscroll-behavior-y:contain; overflow:auto; -webkit-overflow-scrolling:touch; }

  .wrap{
    margin:auto; width:min(1100px,96%); background:var(--card);
    border-radius:var(--radius-xl); box-shadow:var(--shadow-1); position:relative;
    min-height:calc(100svh - var(--safe-top) - var(--safe-bottom));
    padding: calc(28px + var(--safe-top)) calc(28px + var(--safe-right)) calc(28px + var(--safe-bottom)) calc(28px + var(--safe-left));
    overflow:visible; overflow-x:clip;
  }

  h1{ margin:0 0 8px; font-weight:800; font-size:28px; letter-spacing:.2px; }
  .muted{ color:var(--muted); }

  .badges{
    position:absolute; right:calc(18px + var(--safe-right)); top:calc(18px + var(--safe-top));
    display:flex; gap:8px; align-items:center;
  }
  .badge{ font-size:12px; font-weight:800; padding:6px 10px; border-radius:999px; border:1px solid var(--border); background:var(--card); color:var(--text); }
  .gear{ border:1px solid var(--border); background:var(--card); color:var(--text); border-radius:10px; padding:6px 10px; cursor:pointer; font-weight:800; display:flex; align-items:center; gap:6px; transition:background .2s ease; }
  .gear:hover{ background: color-mix(in oklab, var(--card) 90%, var(--text) 10%); }
  .gear:focus-visible{ outline:none; box-shadow:var(--ring); }

  .toast{
    position:fixed; left:50%; bottom:calc(24px + var(--safe-bottom)); transform:translateX(-50%) translateY(20px);
    opacity:0; background:var(--card); border:1px solid var(--border); box-shadow:0 8px 30px rgba(0,0,0,.12);
    border-radius:14px; padding:16px 20px; font-weight:800; transition:all .25s ease; pointer-events:none; font-size:18px; z-index:50;
  }
  .toast.show{ opacity:1; transform:translateX(-50%) translateY(0); }

  .segment{ display:flex; gap:14px; width:100%; margin:20px 0; }
  .segment.segment-xl button{
    flex:1 1 0; border:2px solid #d1d5db; border-radius:16px; font-weight:900; font-size:42px; line-height:1.1; min-height:96px;
    padding:22px 24px; cursor:pointer; color:#111; background:linear-gradient(180deg, #f8fafc 0%, #eef2f7 100%);
    transition:transform .06s ease, box-shadow .2s ease, background .2s ease; box-shadow:0 4px 10px rgba(0,0,0,.05);
  }
  .segment.segment-xl button.active#actIn{
    background:linear-gradient(180deg, #16a34a 0%, #15803d 100%); color:#fff; border-color:#16a34a; box-shadow:0 0 0 4px rgba(22,163,74,.25);
  }
  .segment.segment-xl button.active#actOut{
    background:linear-gradient(180deg, #dc2626 0%, #991b1b 100%); color:#fff; border-color:#dc2626; box-shadow:0 0 0 4px rgba(220,38,38,.25);
  }

  .grid{ display:grid; grid-template-columns:1fr 1fr; gap:18px; align-items:stretch; }
  .card{
    border:1px solid var(--border); border-radius:14px; background:var(--card); padding:16px; margin-bottom:0;
    display:flex; flex-direction:column; height:100%; overflow:hidden; background-clip: padding-box;
  }
  .card h2{ margin:0 0 12px; font-size:20px; }

  input[type=text], input[type=password], input[type=search]{
    width:100%; padding:18px 20px; font-size:24px; border:1.5px solid var(--border); border-radius:12px; background:var(--card); color:var(--text);
    outline:none; transition:border-color .2s ease, box-shadow .2s ease, background .2s ease;
  }
  input[type=text]:focus-visible, input[type=password]:focus-visible, input[type=search]:focus-visible{ border-color:#3b82f6; box-shadow:var(--ring); }
  input:-webkit-autofill{
    -webkit-box-shadow:0 0 0px 1000px var(--card) inset !important; -webkit-text-fill-color:var(--text) !important; transition:background-color 5000s ease-in-out 0s;
  }

  .list{
    display:grid; gap:12px; max-height:460px; overflow:auto; margin-top:14px; background: var(--card); background-clip: padding-box;
    -webkit-overflow-scrolling: touch; overscroll-behavior: contain; flex:1 1 auto; scrollbar-gutter: stable both-edges; padding-right:16px;
  }
  .list::-webkit-scrollbar { width:10px; height:10px; }
  .list::-webkit-scrollbar-thumb { border-radius:999px; background:#b7c0d133; }
  .list::-webkit-scrollbar-track { background:var(--card); }
  .list { scrollbar-color:#98a2b33d var(--card); scrollbar-width:thin; }

  .sectionTitle{ font-size:13px; font-weight:900; color:var(--muted); text-transform:uppercase; letter-spacing:.08em; margin:4px 2px; }
  .row{ display:grid; grid-template-columns:minmax(0,1fr) auto; align-items:center; gap:12px; padding:14px 16px; border:1px solid var(--border); border-radius:12px; background: var(--card); }
  .name{ min-width:0; font-weight:800; font-size:20px; color:var(--text); overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

  .actionBtn{
    --c: var(--blue);
    background:linear-gradient(180deg, var(--c) 0%, color-mix(in srgb, var(--c) 80%, #000 20%) 100%);
    color:#fff; font-size:20px; padding:16px 20px; border:2px solid var(--c); border-radius:14px; font-weight:900; cursor:pointer;
    transition:transform .06s ease, filter .15s ease, box-shadow .2s ease; box-shadow:0 6px 14px rgba(0,0,0,.12); justify-self:end;
  }
  .actionBtn:hover{ filter:brightness(.96); transform:translateY(-1px); }
  .actionBtn:active{ transform:scale(.985); box-shadow:inset 0 3px 8px rgba(0,0,0,.25); }

  .nfcBar{ display:flex; align-items:center; gap:12px; flex-wrap:wrap; margin-top:10px; }
  .nfcBtn{ padding:14px 18px; border-radius:12px; border:2px solid #4f46e5; color:#fff; background:#4f46e5; font-weight:800; cursor:pointer; font-size:18px; transition: transform .06s ease, box-shadow .2s ease; }
  .nfcBtn.secondary{ background:transparent; color:#4f46e5; }

  .drawer{
    position:fixed; right:calc(16px + var(--safe-right)); top:calc(64px + var(--safe-top));
    width:min(560px,92%); max-height:80vh; border:1px solid var(--border); background:var(--card); border-radius:16px; box-shadow:var(--shadow-2);
    padding:16px; overflow:auto; display:none; z-index:40; color:var(--text);
  }
  .drawer h3{ margin:0 0 12px; font-size:18px; display:flex; align-items:center; gap:8px; }
  .opt{ display:flex; gap:10px; align-items:center; margin:8px 0; }
  .hint{ color:var(--muted); font-size:12px; margin:6px 0 8px; }
  .kv { display:grid; grid-template-columns: 160px 1fr; gap:8px 12px; font-size:14px; }
  .kv .k { color:var(--muted); }
  .log { margin-top:10px; max-height:220px; overflow:auto; background:var(--card); border:1px solid var(--border); border-radius:10px; padding:10px; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; }
  .log .item { padding:4px 0; border-bottom:1px dashed var(--border); }
  .log .item:last-child { border-bottom:0; }
  .drawer footer{ display:flex; gap:8px; margin-top:14px; }
  .btn{ padding:12px 14px; border-radius:12px; border:1px solid var(--border); background:var(--card); color:var(--text); font-weight:800; cursor:pointer; }
  .btn.primary{ border-color:#3b82f6; background:#3b82f6; color:#fff; }

  @media (max-width:620px){
    .badges{ position:static; margin:0 0 8px 0; justify-content:flex-end; gap:6px; }
    h1{ margin-top:2px; }
  }
  @media (max-width:900px){
    .grid{ grid-template-columns:1fr; }
    .segment.segment-xl button{ font-size:36px; min-height:88px; }
  }
</style>
</head>
<body>
  <div class="wrap" role="application" aria-label="Teacher Attendance Guard Console">
    <div class="badges" aria-live="polite" aria-atomic="true">
      <div id="netBadge" class="badge">Online</div>
      <div id="nfcBadge" class="badge" style="display:none;">NFC Ready</div>
      <button id="themeBtn" class="gear" title="Toggle theme" aria-label="Toggle dark mode">üåô Dark</button>
      <button id="adminBtn" class="gear" title="Admin" aria-haspopup="dialog" aria-controls="admin"><span>‚öôÔ∏è</span><span>Admin</span></button>
    </div>

    <h1>Teacher Attendance ‚Äî Guard Console</h1>
    <p class="muted">Choose <b>IN</b> or <b>OUT</b>, then <b>swipe/tap your Cougar Card</b> or search the directory.</p>

    <div class="segment segment-xl" role="tablist" aria-label="Action">
      <button id="actIn" class="active" role="tab" aria-selected="true" type="button" aria-label="Set action to IN">IN</button>
      <button id="actOut" role="tab" aria-selected="false" type="button" aria-label="Set action to OUT">OUT</button>
    </div>

    <div class="grid">
      <!-- LEFT: Cougar Card -->
      <div class="card">
        <h2>Cougar Card</h2>
        <input id="pin" type="password" maxlength="32" inputmode="numeric" autocomplete="one-time-code"
               placeholder="Swipe or tap your Cougar Card" aria-label="Cougar Card" />
        <div id="nfcBar" class="nfcBar" style="display:none;">
          <button id="nfcStart" class="nfcBtn">Scan with NFC</button>
          <button id="nfcStop" class="nfcBtn secondary">Stop</button>
        </div>
        <div style="margin-top:auto;"></div>
      </div>

      <!-- RIGHT: Unified Lookup by Name -->
      <div class="card">
        <h2>Lookup by Name</h2>
        <input id="q" type="search" inputmode="search" enterkeyhint="search"
               autocapitalize="words" autocorrect="off" spellcheck="false"
               placeholder="Search faculty or students" aria-label="Search by name" />
        <div id="results" class="list" role="list" aria-live="polite"></div>
      </div>
    </div>

    <div id="toast" class="toast" role="status" aria-live="polite"></div>
  </div>

  <!-- Hidden background target for Veracross (silent submit) -->
  <iframe name="vc_bg" style="display:none;width:0;height:0;border:0;" aria-hidden="true"></iframe>

  <!-- ===== Admin Drawer ===== -->
  <div id="admin" class="drawer" role="dialog" aria-modal="false" aria-labelledby="adminTitle">
    <h3 id="adminTitle"><span>‚öôÔ∏è</span><span>Admin Settings</span></h3>

    <section>
      <strong>NFC mapping rule</strong>
      <div class="hint">Translate NFC UID/text ‚Üí 10-digit Cougar Card code (faculty). Students use 10-digit Legacy ID.</div>
      <div class="opt"><input type="radio" name="rule" value="HEX_LE_PAD10" id="r1"><label for="r1">HEX_LE_PAD10</label></div>
      <div class="opt"><input type="radio" name="rule" value="HEX_BE_PAD10" id="r2"><label for="r2">HEX_BE_PAD10</label></div>
      <div class="opt"><input type="radio" name="rule" value="LAST3_DEC_PAD10" id="r3"><label for="r3">LAST3_DEC_PAD10</label></div>
      <div class="opt"><input type="radio" name="rule" value="FULL_UID_DEC_PAD10" id="r4"><label for="r4">FULL_UID_DEC_PAD10</label></div>
      <div class="opt"><input type="radio" name="rule" value="PASS_THROUGH_DIGITS_PAD10" id="r5"><label for="r5">PASS_THROUGH_DIGITS_PAD10</label></div>
    </section>

    <section style="margin-top:12px;">
      <strong>Keyboard wedge</strong>
      <div class="opt"><input type="checkbox" id="ckTrim"><label for="ckTrim">Trim to digits & pad to 10 (recommended)</label></div>
      <div class="opt"><input type="checkbox" id="ckIgnoreEnter"><label for="ckIgnoreEnter">Ignore Enter key (prevents double submit)</label></div>
    </section>

    <section style="margin-top:12px;">
      <strong>Debug</strong>
      <div class="opt"><input type="checkbox" id="ckDebug"><label for="ckDebug">Show parsed values in toast</label></div>
      <div class="hint">Toggle with <b>Ctrl/‚åò + Shift + D</b>.</div>
    </section>

    <section class="live" style="margin-top:14px; border-top:1px dashed var(--border); padding-top:12px;">
      <h3 style="margin-bottom:8px;">Live Reader</h3>
      <div class="kv">
        <div class="k">Rule</div><div id="liveRule">‚Äî</div>
        <div class="k">Last UID</div><div id="liveUid">‚Äî</div>
        <div class="k">Last parsed</div><div id="liveTen">‚Äî</div>
      </div>
      <div class="log" id="liveLog" aria-label="Reader log"></div>
    </section>

    <footer>
      <button id="adminClose" class="btn">Close</button>
      <button id="adminReset" class="btn">Reset to defaults</button>
      <button id="adminClearLog" class="btn">Clear Log</button>
    </footer>
  </div>

<script>
  // ===== Config =====
  const ENDPOINT = 'https://script.google.com/macros/s/AKfycbzF4Hy0W2ZBbB6dOPRcT3PIKsEZekW2HtHuPAAp99jwUpasH7Iq1mMYCtQ35WEPfkiQQw/exec';
  const COOLDOWN_MS = 400;
  const THEME_KEY = 'theme';

  // Admin keys + defaults
  const RULE_KEY='nfcRule', TRIM_KEY='wedgeTrim', IGNENTER_KEY='wedgeIgnoreEnter', DEBUG_KEY='debugOn';
  const DEFAULTS = { [RULE_KEY]:'HEX_LE_PAD10', [TRIM_KEY]:'1', [IGNENTER_KEY]:'1', [DEBUG_KEY]:'0' };

  // ===== DOM =====
  const $ = s => document.querySelector(s);
  const pinEl = $('#pin'), qEl = $('#q'), toastEl = $('#toast');
  const btnIn = $('#actIn'), btnOut = $('#actOut');
  const netBadge = $('#netBadge'), nfcBadge = $('#nfcBadge');
  const nfcBar = $('#nfcBar'), nfcStartBtn = $('#nfcStart'), nfcStopBtn = $('#nfcStop');
  const themeBtn = $('#themeBtn'), metaTheme = $('#meta-theme');
  const adminBtn = $('#adminBtn'), adminDrawer = $('#admin'),
        adminClose = $('#adminClose'), adminReset = $('#adminReset'), adminClearLog = $('#adminClearLog');
  const ckTrim = $('#ckTrim'), ckIgnoreEnter = $('#ckIgnoreEnter'), ckDebug = $('#ckDebug');
  const liveRuleEl = $('#liveRule'), liveUidEl = $('#liveUid'), liveTenEl = $('#liveTen'), liveLogEl = $('#liveLog');
  let lastSubmitAt = 0;

  // ===== Theme =====
  function setTheme(mode){
    const dark = mode === 'dark';
    document.body.classList.toggle('dark', dark);
    themeBtn.textContent = dark ? '‚òÄÔ∏è Light' : 'üåô Dark';
    if (metaTheme) metaTheme.content = dark ? '#0b1020' : '#ffffff';
    localStorage.setItem(THEME_KEY, dark ? 'dark' : 'light');
  }
  function initTheme(){
    const saved = localStorage.getItem(THEME_KEY);
    if (saved) { setTheme(saved); return; }
    const prefersDark = window.matchMedia?.('(prefers-color-scheme: dark)').matches;
    setTheme(prefersDark ? 'dark' : 'light');
  }
  themeBtn.addEventListener('click', () => setTheme(document.body.classList.contains('dark') ? 'light' : 'dark'));

  // ===== Toast =====
  let toastTimer=null;
  function showToast(text){
    toastEl.textContent = text;
    toastEl.classList.add('show');
    clearTimeout(toastTimer);
    toastTimer = setTimeout(()=>toastEl.classList.remove('show'), 2400);
  }

  // ===== Net badge =====
  function updateNet(){
    const on = navigator.onLine;
    netBadge.textContent = on ? 'Online' : 'Offline';
    netBadge.style.background = on ? 'var(--card)' : '#fee2e2';
    netBadge.style.color = on ? 'var(--text)' : '#991b1b';
  }
  window.addEventListener('online', updateNet);
  window.addEventListener('offline', updateNet);
  updateNet();

  // ===== Focus =====
  function focusPin(){ try { pinEl.focus(); pinEl.select?.(); } catch(_) {} }
  function focusPinSafely(){ if (document.activeElement !== qEl) focusPin(); }
  document.addEventListener('visibilitychange', () => { if (!document.hidden) focusPinSafely(); });
  window.addEventListener('pageshow', (e) => { if (e.persisted) focusPinSafely(); });

  // ===== IN/OUT toggle =====
  function setAction(a){
    const inActive = a === 'in';
    btnIn.classList.toggle('active', inActive);
    btnOut.classList.toggle('active', !inActive);
    setTimeout(focusPinSafely, 0);
  }
  btnIn.addEventListener('click', () => setAction('in'));
  btnOut.addEventListener('click', () => setAction('out'));
  window.addEventListener('keydown', (e)=>{ if(e.key==='ArrowLeft') setAction('in'); if(e.key==='ArrowRight') setAction('out'); });

  // ===== Admin storage =====
  const lsGet=(k,d)=>{const v=localStorage.getItem(k); return v==null?d:v;};
  const lsSet=(k,v)=>localStorage.setItem(k,v);
  const getSelectedNfcRule=()=>lsGet(RULE_KEY, DEFAULTS[RULE_KEY]);

  function mountAdmin(){
    (document.querySelector(`input[name="rule"][value="${getSelectedNfcRule()}"]`) || $('#r1')).checked = true;
    ckTrim.checked = lsGet(TRIM_KEY, DEFAULTS[TRIM_KEY]) === '1';
    ckIgnoreEnter.checked = lsGet(IGNENTER_KEY, DEFAULTS[IGNENTER_KEY]) === '1';
    ckDebug.checked = lsGet(DEBUG_KEY, DEFAULTS[DEBUG_KEY]) === '1';
    liveRuleEl.textContent = getSelectedNfcRule();
  }
  function showAdmin(show=true){
    adminDrawer.style.display = show ? 'block' : 'none';
    adminDrawer.setAttribute('aria-modal', show ? 'true' : 'false');
  }
  adminBtn.addEventListener('click', () => { mountAdmin(); showAdmin(true); });
  adminClose.addEventListener('click', () => { showAdmin(false); focusPinSafely(); });
  adminReset.addEventListener('click', () => {
    Object.entries(DEFAULTS).forEach(([k,v]) => lsSet(k,v));
    mountAdmin(); liveLogEl.innerHTML=''; liveUidEl.textContent='‚Äî'; liveTenEl.textContent='‚Äî';
    showToast('Admin reset to defaults');
  });
  adminClearLog.addEventListener('click', () => { liveLogEl.innerHTML=''; });

  document.querySelectorAll('input[name="rule"]').forEach(r => {
    r.addEventListener('change', () => {
      if (r.checked) { lsSet(RULE_KEY, r.value); liveRuleEl.textContent = r.value; showToast('Rule: ' + r.value); focusPinSafely(); }
    });
  });
  ckTrim.addEventListener('change', () => lsSet(TRIM_KEY, ckTrim.checked ? '1' : '0'));
  ckIgnoreEnter.addEventListener('change', () => lsSet(IGNENTER_KEY, ckIgnoreEnter.checked ? '1' : '0'));
  ckDebug.addEventListener('change', () => lsSet(DEBUG_KEY, ckDebug.checked ? '1' : '0'));
  window.addEventListener('keydown', (e) => {
    const isD = (e.key||'').toLowerCase()==='d';
    const combo = isD && e.shiftKey && (e.ctrlKey || e.metaKey);
    if (!combo) return;
    if (document.activeElement && /^(INPUT|TEXTAREA)$/.test(document.activeElement.tagName)) return;
    e.preventDefault();
    const nv = lsGet(DEBUG_KEY,'0')==='1' ? '0':'1'; lsSet(DEBUG_KEY,nv);
    showToast('Debug ' + (nv==='1' ? 'ON' : 'OFF'));
  });

  // ===== Helpers =====
  const digitsOnly = s => String(s||'').replace(/\D+/g,'');
  const padLeft10 = d => d.length<=10 ? d.padStart(10,'0') : d.slice(-10);

  // Convert "Last, First" -> "First Last"
  function lfToFl(name){
    const s = String(name||'').trim();
    const m = s.match(/^\s*([^,]+)\s*,\s*(.+)\s*$/);
    return m ? `${m[2]} ${m[1]}`.trim() : s;
  }

  // ===== Veracross background POST (hidden iframe) =====
  function postToVeracrossBackground(legacyId){
    const form = document.createElement('form');
    form.method='POST';
    form.action='https://checkin.veracross.com/frisch/checkin/log';
    form.target='vc_bg';
    form.style.display='none';
    const add=(n,v)=>{const i=document.createElement('input'); i.type='hidden'; i.name=n; i.value=v; form.appendChild(i);};
    add('legacy_id', legacyId);
    add('kiosk_type','4'); add('check_in_method','3'); add('kiosk','34');
    document.body.appendChild(form);
    try { form.submit(); } catch {}
    setTimeout(()=>form.remove(),1500);
  }

  // ===== Backend calls =====
  async function postFaculty({ pin, personId }) {
    const act = btnIn.classList.contains('active') ? 'in' : 'out';
    const body = new URLSearchParams({ action: act, ...(pin?{pin}:{personId}) });
    const res = await fetch(ENDPOINT, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body });
    const text = await res.text(); let data=null; try{ data=JSON.parse(text);}catch{}
    return { ok: res.ok && data && !data.error, data, status:res.status, raw:text };
  }
  async function searchFaculty(q){ const r=await fetch(`${ENDPOINT}?action=search&q=${encodeURIComponent(q)}`); return r.json(); }
  async function getStudentByLegacy(id){
    try{
      const res = await fetch(`${ENDPOINT}?action=studentByLegacy&id=${encodeURIComponent(id)}`);
      const data = await res.json();
      if (data && data.found) return { found:true, fullName:String(data.fullName||''), personId:String(data.personId||''), legacyId:String(id||'') };
    }catch{}
    return { found:false, fullName:'', legacyId:String(id||'') };
  }
  async function searchStudents(q){
    try{ const r=await fetch(`${ENDPOINT}?action=studentSearch&q=${encodeURIComponent(q)}`); return r.json(); }
    catch { return { error:true }; }
  }

  // ===== Student helper: toast with "First Last"
  async function sendStudentToVeracross(legacyId){
    let display = 'Student ' + legacyId;
    try {
      const s = await getStudentByLegacy(legacyId);
      if (s && s.found && s.fullName) display = lfToFl(s.fullName);
    } catch {}
    postToVeracrossBackground(legacyId);
    showToast(`${display} ‚Äî sent to Veracross`);
  }

  // ===== ‚ÄúNot found‚Äù detector =====
  function isNotFoundError(obj){
    const msg = (obj && (obj.error || obj.message || obj.raw)) ? String(obj.error || obj.message || obj.raw) : '';
    return /not\s*found/i.test(msg);
  }

  // ===== Wedge / Scan input (10 digits: faculty ‚Üí student fallback) =====
  let wedgeTimer=null;
  const WEDGE_QUIET_MS=120;

  pinEl.addEventListener('input', ()=>{
    clearTimeout(wedgeTimer);
    wedgeTimer=setTimeout(async ()=>{
      const raw = pinEl.value || '';
      const d = digitsOnly(raw);
      if (!d) return;

      if (d.length >= 10) {
        const ten = padLeft10(d);
        if (Date.now() - lastSubmitAt < COOLDOWN_MS) return;
        lastSubmitAt = Date.now();

        const r = await postFaculty({ pin: ten });
        if (r.ok) {
          const { status, firstName, lastName, time } = r.data || {};
          const verb = status==='in'?'IN': status==='out'?'OUT':'UPDATED';
          showToast(`${(firstName||'') + ' ' + (lastName||'')}`.trim() + ` signed ${verb} ‚Äî ${time||''}`);
        } else if (isNotFoundError(r.data)) {
          if (!btnIn.classList.contains('active')) { showToast('Students can only sign IN'); }
          else { await sendStudentToVeracross(ten); }
        } else {
          showToast((r.data && r.data.error) || 'Server error');
        }
      } else {
        showToast('ID too short');
      }

      pinEl.value=''; focusPin();
    }, WEDGE_QUIET_MS);
  });

  pinEl.addEventListener('keydown',(e)=>{
    if (localStorage.getItem('wedgeIgnoreEnter') !== '0' && e.key === 'Enter') {
      e.preventDefault(); e.stopPropagation();
    }
  });

  // ===== Unified name lookup ‚Äî robust dedupe + single headers + request cancel =====
  let searchTimer = null;
  let searchController = null;
  let searchSeq = 0;

  const normNameKey = (fn, ln) =>
    `${String(fn||'').trim().toLowerCase()}|${String(ln||'').trim().toLowerCase()}`;

  function uniqueBy(arr, keyFn) {
    const seen = new Set();
    const out = [];
    for (const item of arr || []) {
      const k = keyFn(item);
      if (!k || seen.has(k)) continue;
      seen.add(k);
      out.push(item);
    }
    return out;
  }

  function sortFac(a,b){
    const al = String(a.lastName||'').toLowerCase(), bl = String(b.lastName||'').toLowerCase();
    if (al !== bl) return al < bl ? -1 : 1;
    const af = String(a.firstName||'').toLowerCase(), bf = String(b.firstName||'').toLowerCase();
    return af < bf ? -1 : af > bf ? 1 : 0;
  }
  function sortStu(a,b){
    const an = String(a.fullName||'').toLowerCase(), bn = String(b.fullName||'').toLowerCase();
    return an < bn ? -1 : an > bn ? 1 : 0;
  }

  qEl.addEventListener('input', () => {
    clearTimeout(searchTimer);
    const q = qEl.value.trim();
    const box = document.querySelector('#results');
    box.replaceChildren();
    if (!q) return;

    searchTimer = setTimeout(() => doSearch(q, box), 200);
  });

  async function doSearch(q, box) {
    if (searchController) try { searchController.abort(); } catch(_) {}
    searchController = new AbortController();
    const signal = searchController.signal;

    const mySeq = ++searchSeq;

    let facRaw = [], stuRaw = [];
    try {
      const [facRes, stuRes] = await Promise.allSettled([
        fetch(`${ENDPOINT}?action=search&q=${encodeURIComponent(q)}`, { signal }),
        fetch(`${ENDPOINT}?action=studentSearch&q=${encodeURIComponent(q)}`, { signal })
      ]);

      if (mySeq !== searchSeq) return;

      if (facRes.status === 'fulfilled') facRaw = await facRes.value.json();
      if (stuRes.status === 'fulfilled') stuRaw = await stuRes.value.json();
    } catch (e) {
      if (e.name === 'AbortError') return;
      box.replaceChildren(document.createTextNode('Search failed.'));
      return;
    }

    if (mySeq !== searchSeq) return;

    if (!Array.isArray(facRaw)) facRaw = [];
    if (!Array.isArray(stuRaw)) stuRaw = [];

    const facList = uniqueBy(
      facRaw.filter(r => r && (r.firstName || r.lastName)),
      r => String(r.personId || '').trim() || normNameKey(r.firstName, r.lastName)
    ).sort(sortFac);

    const stuList = uniqueBy(
      stuRaw.filter(r => r && (r.fullName || r.legacyId)),
      r => String(r.legacyId || '').trim() || String(r.fullName || '').trim().toLowerCase()
    ).sort(sortStu);

    box.replaceChildren();

    if (!facList.length && !stuList.length) {
      const div = document.createElement('div');
      div.className = 'muted';
      div.textContent = 'No matches.';
      box.appendChild(div);
      return;
    }

    const addHeader = (title) => {
      const h = document.createElement('div');
      h.className = 'sectionTitle';
      h.textContent = title;
      box.appendChild(h);
    };

    // FACULTY
    if (facList.length) {
      addHeader('Faculty');
      for (const { firstName, lastName, personId } of facList) {
        const row=document.createElement('div'); row.className='row'; row.setAttribute('role','listitem');
        const name=document.createElement('div'); name.className='name';
        name.textContent = `${firstName||''} ${lastName||''}`.trim();
        const btn=document.createElement('button'); btn.className='actionBtn'; btn.textContent='Submit';
        btn.addEventListener('click', async ()=>{
          const r = await postFaculty({ personId });
          if (r.ok) {
            const { status, firstName, lastName, time } = r.data || {};
            const verb = status==='in'?'IN': status==='out'?'OUT':'UPDATED';
            showToast(`${(firstName||'') + ' ' + (lastName||'')}`.trim() + ` ${verb} ‚Äî ${time||''}`);
          } else {
            showToast((r.data && r.data.error) || 'Error');
          }
          setTimeout(() => { try { pinEl.focus(); } catch(_) {} }, 0);
        });
        row.appendChild(name); row.appendChild(btn); box.appendChild(row);
      }
    }

    // STUDENTS
    if (stuList.length) {
      addHeader('Students');
      for (const { fullName, legacyId } of stuList) {
        const row=document.createElement('div'); row.className='row'; row.setAttribute('role','listitem');
        const name=document.createElement('div'); name.className='name';
        const nameFL = lfToFl(fullName || '');
        name.textContent = nameFL || legacyId || '';
        const btn=document.createElement('button'); btn.className='actionBtn'; btn.textContent='Sign In';
        btn.addEventListener('click', async ()=>{
          if (!btnIn.classList.contains('active')) { showToast('Students can only sign IN'); return; }
          await sendStudentToVeracross(String(legacyId||'')); 
          setTimeout(() => { try { pinEl.focus(); } catch(_) {} }, 0);
        });
        row.appendChild(name); row.appendChild(btn); box.appendChild(row);
      }
    }
  }

  // ===== NFC (Android Chrome). 10-digit: faculty first, then student fallback =====
  function supportsWebNFC(){ return 'NDEFReader' in window; }
  let ndef=null, nfcStarted=false;
  const hexToBytes=(hex)=>{ const s=(hex||'').replace(/[^0-9a-f]/gi,''); const out=[]; for(let i=0;i<s.length;i+=2) out.push(parseInt(s.substr(i,2),16)); return out; };
  const numLE=(a)=>a.reduceRight((x,b) => (x*256+b)>>>0, 0);
  const numBE=(a)=>a.reduce((x,b) => (x*256+b)>>>0, 0);
  const pad10=(n)=>{ const s=String(n>>>0); return s.length>=10? s.slice(-10) : s.padStart(10,'0'); };
  function uidToTen(uidHex){
    const b=hexToBytes(uidHex);
    switch(localStorage.getItem('nfcRule') || 'HEX_LE_PAD10'){
      case 'HEX_LE_PAD10': return pad10(numLE(b.slice(-4)));
      case 'HEX_BE_PAD10': return pad10(numBE(b.slice(-4)));
      case 'LAST3_DEC_PAD10': return pad10(numBE(b.slice(-3)));
      case 'FULL_UID_DEC_PAD10': return pad10(numBE(b));
      case 'PASS_THROUGH_DIGITS_PAD10': default: return digitsOnly(uidHex);
    }
  }
  function pushLive(uidHex, parsed){
    liveUidEl.textContent=uidHex||'‚Äî';
    liveTenEl.textContent=parsed||'‚Äî';
    liveRuleEl.textContent=localStorage.getItem('nfcRule') || 'HEX_LE_PAD10';
    const ts=new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit'});
    const div=document.createElement('div'); div.className='item';
    div.textContent=`[${ts}] UID:${(uidHex||'').slice(-8)} ‚Üí ${parsed} (${localStorage.getItem('nfcRule') || 'HEX_LE_PAD10'})`;
    liveLogEl.appendChild(div); liveLogEl.scrollTop=liveLogEl.scrollHeight;
  }

  if (supportsWebNFC()) {
    nfcBar.style.display = ''; nfcStopBtn.disabled = true;
    nfcStartBtn.addEventListener('click', async ()=>{
      if (nfcStarted) return;
      try{
        ndef=new NDEFReader(); await ndef.scan(); nfcStarted=true;
        nfcBadge.style.display=''; nfcStartBtn.disabled=true; nfcStopBtn.disabled=false;
        showToast('NFC scanning started'); focusPinSafely();

        ndef.onreading=(ev)=>{
          const uidHex=String(ev.serialNumber||'').toUpperCase().replace(/[^0-9A-F]/g,'');
          let parsed=uidToTen(uidHex);
          if (!parsed || parsed.length!==10) {
            for (const rec of ev.message.records||[]) {
              const txty = rec.recordType==='text' || rec.recordType==='url' || rec.mediaType==='text/plain';
              if (!txty) continue;
              try{ const td=new TextDecoder(rec.encoding||'utf-8'); const t=rec.data?td.decode(rec.data):''; const d=digitsOnly(t); if (d && d.length>=10) { parsed=padLeft10(d); break; } }catch{}
            }
          }
          if (!parsed){ showToast('Unrecognized NFC'); return; }

          const go = async ()=>{
            const ten = padLeft10(parsed);
            const r = await postFaculty({ pin: ten });
            if (r.ok) {
              const { status, firstName, lastName, time } = r.data || {};
              const verb = status==='in'?'IN': status==='out'?'OUT':'UPDATED';
              showToast(`${(firstName||'') + ' ' + (lastName||'')}`.trim() + ` ${verb} ‚Äî ${time||''}`);
            } else if (isNotFoundError(r.data)) {
              if (!btnIn.classList.contains('active')) { showToast('Students can only sign IN'); }
              else { await sendStudentToVeracross(ten); }
            } else {
              showToast((r.data && r.data.error) || 'Server error');
            }
          };

          if (Date.now()-lastSubmitAt>=COOLDOWN_MS) { lastSubmitAt=Date.now(); go(); }
          pushLive(uidHex, parsed);
          focusPinSafely();
        };
        ndef.onreadingerror=()=>showToast('NFC read error');
      }catch{ showToast('NFC not permitted or unavailable'); focusPinSafely(); }
    });
    nfcStopBtn.addEventListener('click', ()=>{
      if (ndef){ ndef.onreading=null; ndef.onreadingerror=null; }
      nfcStarted=false; nfcStartBtn.disabled=false; nfcStopBtn.disabled=true;
      showToast('NFC stopped'); focusPinSafely();
    });
  }

  // ===== Init =====
  document.addEventListener('DOMContentLoaded', ()=>{
    initTheme();
    Object.entries(DEFAULTS).forEach(([k,v])=>{ if(localStorage.getItem(k)==null) localStorage.setItem(k,v); });
    setAction('in'); focusPinSafely();
  });

  // Admin drawer close via backdrop
  adminDrawer.addEventListener('click',(e)=>{ if(e.target===adminDrawer){ showAdmin(false); focusPinSafely(); } });
</script>
</body>
</html>
