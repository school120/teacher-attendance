<script>
  // ...keep everything else in your file...

  // ===== Unified name lookup — dedup and single headers =====
  let searchTimer = null;

  // Small utilities
  const normNameKey = (fn, ln) => `${String(fn||'').trim().toLowerCase()}|${String(ln||'').trim().toLowerCase()}`;
  function uniqueBy(arr, keyFn) {
    const seen = new Set();
    const out = [];
    for (const item of arr) {
      const k = keyFn(item);
      if (!k || seen.has(k)) continue;
      seen.add(k);
      out.push(item);
    }
    return out;
  }

  qEl.addEventListener('input', () => {
    clearTimeout(searchTimer);
    const q = qEl.value.trim();
    const box = document.querySelector('#results');
    box.innerHTML = '';
    if (!q) return;

    searchTimer = setTimeout(() => doSearch(q, box), 200);
  });

  async function doSearch(q, box) {
    try {
      const [facRaw, stuRaw] = await Promise.all([
        searchFaculty(q).catch(() => []),
        searchStudents(q).catch(() => [])
      ]);

      // --- Faculty: dedupe by personId, fallback to normalized "fn|ln"
      const facListDedupe = uniqueBy(
        (Array.isArray(facRaw) ? facRaw : []).filter(r => r && (r.firstName || r.lastName)),
        r => String(r.personId || '').trim() || normNameKey(r.firstName, r.lastName)
      ).sort((a,b)=>{
        const al = String(a.lastName||'').toLowerCase(), bl = String(b.lastName||'').toLowerCase();
        if (al !== bl) return al < bl ? -1 : 1;
        const af = String(a.firstName||'').toLowerCase(), bf = String(b.firstName||'').toLowerCase();
        return af < bf ? -1 : af > bf ? 1 : 0;
      });

      // --- Students: dedupe by legacyId, fallback to fullName
      const stuListDedupe = uniqueBy(
        (Array.isArray(stuRaw) ? stuRaw : []).filter(r => r && (r.fullName || r.legacyId)),
        r => String(r.legacyId || '').trim() || String(r.fullName || '').trim().toLowerCase()
      ).sort((a,b)=>{
        const an = String(a.fullName||'').toLowerCase(), bn = String(b.fullName||'').toLowerCase();
        return an < bn ? -1 : an > bn ? 1 : 0;
      });

      if (!facListDedupe.length && !stuListDedupe.length) {
        box.innerHTML = '<div class="muted">No matches.</div>';
        return;
      }

      const addTitleOnce = (title) => {
        const h = document.createElement('div');
        h.className = 'sectionTitle';
        h.textContent = title;
        box.appendChild(h);
      };

      // Render Faculty section once
      if (facListDedupe.length) {
        addTitleOnce('Faculty');
        for (const { firstName, lastName, personId } of facListDedupe) {
          const row = document.createElement('div'); row.className='row'; row.setAttribute('role','listitem');
          const name = document.createElement('div'); name.className='name'; name.textContent = `${firstName||''} ${lastName||''}`.trim();
          const btn  = document.createElement('button'); btn.className='actionBtn'; btn.textContent='Submit';
          btn.addEventListener('click', async ()=>{
            const r = await postFaculty({ personId });
            if (r.ok) {
              const { status, firstName, lastName, time } = r.data || {};
              const verb = status==='in'?'IN': status==='out'?'OUT':'UPDATED';
              showToast(`${firstName||''} ${lastName||''} ${verb} — ${time||''}`.trim());
            } else {
              showToast((r.data && r.data.error) || 'Error');
            }
            // Return focus to swipe field
            setTimeout(() => { try { pinEl.focus(); } catch(_) {} }, 0);
          });
          row.appendChild(name); row.appendChild(btn); box.appendChild(row);
        }
      }

      // Render Students section once
      if (stuListDedupe.length) {
        addTitleOnce('Students');
        for (const { fullName, legacyId } of stuListDedupe) {
          const row = document.createElement('div'); row.className='row'; row.setAttribute('role','listitem');
          const name = document.createElement('div'); name.className='name'; name.textContent = fullName || legacyId;
          const btn  = document.createElement('button'); btn.className='actionBtn'; btn.textContent='Sign In';
          btn.addEventListener('click', async ()=>{
            if (!btnIn.classList.contains('active')) { showToast('Students can only sign IN'); return; }
            await sendStudentToVeracross(String(legacyId||''));
            setTimeout(() => { try { pinEl.focus(); } catch(_) {} }, 0);
          });
          row.appendChild(name); row.appendChild(btn); box.appendChild(row);
        }
      }
    } catch {
      box.innerHTML = '<div class="muted">Search failed.</div>';
    }
  }

  // ...keep everything else in your file...
</script>
