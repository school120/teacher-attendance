<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport"
  content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
<title>Guard Booth Attendance Kiosk</title>
<meta name="description"
  content="Guard kiosk for IN/OUT with card swipe/tap or name lookup. Faculty handled in-app; students IN â†’ Veracross, OUT â†’ logged." />
<meta name="color-scheme" content="light dark">
<meta id="meta-theme" name="theme-color" content="#ffffff">

<style>
  :root{
    --bg:#f6f7fb; --card:#ffffff; --text:#0f172a; --muted:#667085; --border:#e5e7eb;
    --in:#16a34a; --out:#dc2626; --blue:#2563eb; --ok:#0f766e; --err:#b91c1c;
    --radius-lg:14px; --radius-xl:18px; --shadow-1:0 10px 30px rgba(0,0,0,.08);
    --ring:0 0 0 6px rgba(59,130,246,.16);
  }
  body.dark{
    --bg:#0b1020; --card:#111827; --text:#f3f4f6; --muted:#cbd5e1; --border:#374151;
  }

  *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
  html,body{ margin:0; height:100%; background:var(--bg); color:var(--text);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
  html{ overflow-x:hidden; }

  .wrap{
    margin:auto; width:min(1100px,96%); background:var(--card); border-radius:var(--radius-xl);
    box-shadow:var(--shadow-1); min-height:100svh; padding:28px; position:relative;
  }

  .top-center{ text-align:center; margin-bottom:8px; }
  h1{ margin:0 0 6px; font-size:30px; font-weight:900; }

  .muted{ color:var(--muted); }

  .badges{
    position:absolute; right:18px; top:18px; display:flex; gap:8px; flex-wrap:wrap;
    justify-content:flex-end; max-width:60%;
  }
  .badge{
    font-size:12px; font-weight:800; padding:6px 10px; border-radius:999px;
    border:1px solid var(--border); background:var(--card); white-space:nowrap;
  }
  .gear{
    border:1px solid var(--border); background:var(--card); border-radius:10px;
    padding:6px 10px; font-weight:800; cursor:pointer;
  }

  .toast{
    position:fixed; left:50%; bottom:24px; transform:translateX(-50%) translateY(20px);
    opacity:0; background:var(--card); border:1px solid var(--border); box-shadow:0 8px 30px rgba(0,0,0,.12);
    border-radius:14px; padding:18px 22px; font-weight:900; font-size:20px; transition:.18s;
    z-index:50;
  }
  .toast.show{ opacity:1; transform:translateX(-50%) translateY(0); }
  .toast.ok{ color:var(--ok); }
  .toast.err{ color:var(--err); }

  .segment{
    margin:16px 0 20px; display:flex; gap:14px;
  }
  .segment.segment-xl button{
    flex:1; border:2px solid #d1d5db; border-radius:16px; font-weight:900;
    font-size:42px; min-height:96px; padding:22px 24px; cursor:pointer;
    background:linear-gradient(180deg,#f8fafc 0%,#eef2f7 100%);
  }
  #actIn.active{
    background:linear-gradient(180deg,#16a34a 0%,#15803d 100%); color:white;
    border-color:#16a34a; box-shadow:0 0 0 4px rgba(22,163,74,.3);
  }
  #actOut.active{
    background:linear-gradient(180deg,#dc2626 0%,#991b1b 100%); color:white;
    border-color:#dc2626; box-shadow:0 0 0 4px rgba(220,38,38,.3);
  }

  .grid{ display:grid; grid-template-columns:1fr 1fr; gap:18px; }
  .card{
    background:var(--card); border:1px solid var(--border); border-radius:14px;
    padding:16px; display:flex; flex-direction:column;
  }
  input[type=password],input[type=search]{
    width:100%; padding:18px 20px; font-size:24px; border:1.5px solid var(--border);
    border-radius:12px; background:var(--card); color:var(--text);
  }
  input:focus-visible{
    border-color:#3b82f6; box-shadow:var(--ring); outline:none;
  }

  .list{
    margin-top:14px; overflow:auto; display:grid; gap:12px;
    max-height:460px; padding-right:16px;
  }
  .row{
    padding:14px 16px; border:1px solid var(--border); border-radius:12px;
    display:grid; grid-template-columns:1fr auto; gap:12px;
  }
  .name{ font-size:20px; font-weight:800; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; }
  .actionBtn{
    padding:14px 18px; font-size:20px; border-radius:14px; cursor:pointer;
    font-weight:900; color:white; background:linear-gradient(180deg,#2563eb 0%,#1e40af 100%);
    border:2px solid #2563eb;
  }

  .sectionHdr{ text-align:center; font-size:14px; font-weight:900; padding:10px 0 2px; color:var(--muted); }

  @media(max-width:900px){
    .grid{ grid-template-columns:1fr; }
    .segment.segment-xl button{ font-size:36px; min-height:88px; }
  }

  /* Bootstrap Overlay */
  .boot-overlay{
    position:fixed; inset:0; background:rgba(15,23,42,.78); display:flex;
    align-items:center; justify-content:center; z-index:60;
  }
  .boot-overlay-inner{
    background:var(--card); padding:20px 26px; border-radius:16px;
    display:flex; flex-direction:column; gap:10px; align-items:center;
  }
  .boot-spinner{
    width:32px; height:32px; border-radius:999px;
    border:3px solid rgba(148,163,184,.7); border-top-color:var(--blue);
    animation:spin .7s linear infinite;
  }
  @keyframes spin{ to{ transform:rotate(360deg); } }
</style>
</head>

<body>
<div class="wrap">
  <div class="badges">
    <div id="netBadge" class="badge">Online</div>
    <div id="rosterStatus" class="badge">Roster: â€”</div>
    <button id="themeBtn" class="gear">ðŸŒ™ Dark</button>
  </div>

  <div class="top-center">
    <h1>Guard Booth Attendance Kiosk</h1>
    <p class="muted">Select <b>IN</b> or <b>OUT</b>, then swipe card or search.</p>
  </div>

  <div class="segment segment-xl">
    <button id="actIn" class="active">IN</button>
    <button id="actOut">OUT</button>
  </div>

  <div class="grid">
    <div class="card">
      <h2>Cougar Card</h2>
      <input id="pin" type="password" autocomplete="one-time-code" placeholder="Tap or swipeâ€¦" />
    </div>

    <div class="card">
      <h2>Lookup by Name</h2>
      <input id="q" type="search" placeholder="Search faculty or students" />
      <div id="results" class="list"></div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <div id="bootOverlay" class="boot-overlay">
    <div class="boot-overlay-inner">
      <div class="boot-spinner"></div>
      <div class="boot-text">Loading rostersâ€¦</div>
    </div>
  </div>
</div>

<script>
(() => {
'use strict';

/*************************************************************
 * CONFIG
 *************************************************************/
const ENDPOINT = 'YOUR_DEPLOYED_WEBAPP_URL';   // â† replace with your Apps Script URL
const VC_BASE  = 'https://checkin.veracross.com/frisch/kiosk/entrance?legacy=';
const COOLDOWN_MS = 250;
const DEDUPE_MS = 5000;
const WEDGE_QUIET = 100;

/*************************************************************
 * DOM SHORTCUTS
 *************************************************************/
const $ = s => document.querySelector(s);
const pinEl = $('#pin');
const qEl   = $('#q');
const toastEl = $('#toast');
const actIn = $('#actIn'), actOut = $('#actOut');
const resultsEl = $('#results');
const themeBtn = $('#themeBtn');
const netBadge = $('#netBadge');
const rosterStatus = $('#rosterStatus');
const bootOverlay = $('#bootOverlay');
const metaTheme = document.querySelector('meta[name="theme-color"]');

/*************************************************************
 * BASIC HELPERS
 *************************************************************/
const digits = s => String(s||'').replace(/\D+/g,'');
const ten = s => digits(s).slice(-10);

/*************************************************************
 * TOAST
 *************************************************************/
const Toast = (()=>{ 
  let t=null;
  function show(msg, ok=true, ms=2000){
    toastEl.textContent=msg;
    toastEl.classList.toggle('ok',ok);
    toastEl.classList.toggle('err',!ok);
    toastEl.classList.add('show');
    clearTimeout(t);
    t=setTimeout(()=>toastEl.classList.remove('show'),ms);
  }
  return { show };
})();

/*************************************************************
 * CHIMES
 *************************************************************/
const Chime = (()=>{ 
  let ctx, ready=false;
  function init(){
    if(ready) return;
    const AC = window.AudioContext||window.webkitAudioContext;
    ctx = new AC();
    window.addEventListener('pointerdown',()=>ctx.resume(),{once:true});
    ready=true;
  }
  function ok(){
    init();
    const o=ctx.createOscillator(), g=ctx.createGain();
    o.frequency.value=880; o.type='sine';
    o.connect(g).connect(ctx.destination);
    g.gain.setValueAtTime(0,ctx.currentTime);
    g.gain.linearRampToValueAtTime(.9,ctx.currentTime+.02);
    g.gain.exponentialRampToValueAtTime(0.0001,ctx.currentTime+.2);
    o.start(); o.stop(ctx.currentTime+.25);
  }
  function fail(){
    init();
    const o=ctx.createOscillator(), g=ctx.createGain();
    o.frequency.value=200; o.type='square';
    o.connect(g).connect(ctx.destination);
    g.gain.setValueAtTime(0,ctx.currentTime);
    g.gain.linearRampToValueAtTime(.7,ctx.currentTime+.02);
    g.gain.exponentialRampToValueAtTime(0.0001,ctx.currentTime+.3);
    o.start(); o.stop(ctx.currentTime+.35);
  }
  return { ok, fail };
})();

 /*************************************************************
 * THEME
 *************************************************************/
function setTheme(mode){
  const dark = mode==='dark';
  document.body.classList.toggle('dark',dark);
  themeBtn.textContent = dark ? 'â˜€ï¸ Light' : 'ðŸŒ™ Dark';
  if (metaTheme) metaTheme.content = dark ? '#0b1020' : '#ffffff';
  localStorage.setItem('kiosk_theme',dark?'dark':'light');
}
function initTheme(){
  const saved = localStorage.getItem('kiosk_theme');
  if(saved){ setTheme(saved); return; }
  const sysDark = window.matchMedia?.('(prefers-color-scheme: dark)').matches;
  setTheme(sysDark?'dark':'light');
}
themeBtn.addEventListener('click',()=>{
  setTheme(document.body.classList.contains('dark')?'light':'dark');
});

/*************************************************************
 * NETWORK BADGE
 *************************************************************/
function updateNet(){
  const o = navigator.onLine;
  netBadge.textContent = o?'Online':'Offline';
  netBadge.style.background = o?'var(--card)':'#fee2e2';
  netBadge.style.color = o?'var(--text)':'#991b1b';
}
window.addEventListener('online',updateNet);
window.addEventListener('offline',updateNet);

/*************************************************************
 * ACTION TOGGLE (IN / OUT)
 *************************************************************/
function setAction(a){
  const isIn = a==='in';
  actIn.classList.toggle('active',isIn);
  actOut.classList.toggle('active',!isIn);
  pinEl.focus();
}
actIn.addEventListener('click',()=>setAction('in'));
actOut.addEventListener('click',()=>setAction('out'));

/*************************************************************
 * BOOTSTRAP DATA
 * Backend now returns:
 * {
 *   students: [
 *      { legacyId, firstName, lastName }
 *   ],
 *   faculty: [
 *      { personId, firstName, lastName, pin }
 *   ]
 * }
 *************************************************************/
let students = [];
let faculty = [];
let mapStudents = new Map();   // legacy â†’ record
let mapFacultyPins = new Map();// pin â†’ record
let mapFacultyPid  = new Map();// personId â†’ record
let bootstrapReady = false;

function firstLast(f,l){ return `${f||''} ${l||''}`.trim(); }

async function loadBootstrap(){
  const url = ENDPOINT + '?action=bootstrap';
  const res = await fetch(url);
  if(!res.ok) throw new Error('Bootstrap HTTP '+res.status);
  const data = await res.json();

  // Students
  students = data.students || [];
  mapStudents.clear();
  students.forEach(s=>{
    mapStudents.set(String(s.legacyId),{
      legacyId:String(s.legacyId),
      firstName:s.firstName||'',
      lastName:s.lastName||'',
      label:firstLast(s.firstName,s.lastName)
    });
  });

  // Faculty
  faculty = data.faculty || [];
  mapFacultyPins.clear();
  mapFacultyPid.clear();
  faculty.forEach(f=>{
    if(f.pin) mapFacultyPins.set(String(f.pin),f);
    if(f.personId) mapFacultyPid.set(String(f.personId),f);
  });

  bootstrapReady = true;
}

/*************************************************************
 * SEARCH ENGINE â€” FIRST LAST ONLY
 *************************************************************/
function norm(s){
  return String(s||'').toLowerCase()
    .normalize('NFKD').replace(/[\u0300-\u036f]/g,'');
}

function score(first,last,q){
  const Nq = norm(q);
  const Nf = norm(first);
  const Nl = norm(last);
  const full = Nf + ' ' + Nl;

  if(full === Nq) return 1000;
  if(Nf === Nq || Nl === Nq) return 900;

  let s=0;
  if(Nf.startsWith(Nq)) s+=120;
  if(Nl.startsWith(Nq)) s+=110;
  if(full.startsWith(Nq)) s+=100;

  if(Nf.includes(Nq)) s+=40;
  if(Nl.includes(Nq)) s+=38;
  if(full.includes(Nq)) s+=36;

  return s;
}

/*************************************************************
 * RENDER LIST
 *************************************************************/
function sectionHeader(txt){
  const d=document.createElement('div');
  d.className='sectionHdr'; d.textContent=txt;
  return d;
}
function resultRow(label, onclick){
  const row=document.createElement('div'); row.className='row';
  const name=document.createElement('div'); name.className='name'; name.textContent=label;
  const btn=document.createElement('button'); btn.className='actionBtn'; btn.textContent='Submit';
  btn.addEventListener('click',onclick);
  row.appendChild(name); row.appendChild(btn);
  return row;
}

/*************************************************************
 * DO SEARCH
 *************************************************************/
function localSearch(q){
  const Q=q.trim(); if(!Q){ resultsEl.innerHTML=''; return; }

  const facHits=[];
  for(const f of faculty){
    const sc = score(f.firstName,f.lastName,Q);
    if(sc>0) facHits.push({...f,_score:sc});
  }

  const stuHits=[];
  for(const s of students){
    const sc = score(s.firstName,s.lastName,Q);
    if(sc>0) stuHits.push({...s,_score:sc});
  }

  facHits.sort((a,b)=>b._score - a._score);
  stuHits.sort((a,b)=>b._score - a._score);

  const frag=document.createDocumentFragment();

  // Faculty first
  if(facHits.length){
    frag.appendChild(sectionHeader('FACULTY'));
    facHits.slice(0,25).forEach(f=>{
      const label = firstLast(f.firstName,f.lastName);
      frag.appendChild(
        resultRow(label,()=>quickFaculty(f,label))
      );
    });
  }

  if(stuHits.length){
    frag.appendChild(sectionHeader('STUDENTS'));
    stuHits.slice(0,25).forEach(s=>{
      const label = firstLast(s.firstName,s.lastName);
      frag.appendChild(
        resultRow(label,()=>quickStudent(s,label))
      );
    });
  }

  resultsEl.replaceChildren();
  if(!facHits.length && !stuHits.length){
    resultsEl.innerHTML='<div class="muted" style="text-align:center;">No matches found.</div>';
  } else {
    resultsEl.appendChild(frag);
  }
}

/*************************************************************
 * FAST ACTIONS
 *************************************************************/
function isIn(){ return actIn.classList.contains('active'); }

function quickStudent(s,label){
  if(isIn()){
    // Student IN â†’ Veracross + log
    const url = VC_BASE + encodeURIComponent(s.legacyId);
    window.open(url,'_blank','width=480,height=820');
    Toast.show(`${label} â€” sent to Veracross`,true);
    Chime.ok();

    fetch(ENDPOINT,{
      method:'POST',
      headers:{'Content-Type':'application/x-www-form-urlencoded'},
      body:new URLSearchParams({
        action:'in', src:'name_fast', pin:String(s.legacyId)
      })
    });
  } else {
    // Student OUT fast
    const now = new Date();
    const t = now.toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'});
    Toast.show(`${label} â€” signed OUT â€” ${t}`,true);
    Chime.ok();

    fetch(ENDPOINT,{
      method:'POST',
      headers:{'Content-Type':'application/x-www-form-urlencoded'},
      body:new URLSearchParams({
        action:'out', src:'student_out_fast', pin:String(s.legacyId)
      })
    });
  }
}

function quickFaculty(f,label){
  const act = isIn()?'in':'out';
  const now = new Date();
  const t = now.toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'});
  Toast.show(`${label} signed ${act.toUpperCase()} â€” ${t}`,true);
  Chime.ok();

  const params={ action:act, src:'name_fast_faculty', personId:f.personId };
  if(f.pin) params.pin=f.pin;

  fetch(ENDPOINT,{
    method:'POST',
    headers:{'Content-Type':'application/x-www-form-urlencoded'},
    body:new URLSearchParams(params)
  });
}

/*************************************************************
 * CARD INPUT
 *************************************************************/
let lastSend=0, wedgeTimer=null;

pinEl.addEventListener('input',()=>{
  clearTimeout(wedgeTimer);
  wedgeTimer=setTimeout(()=>{
    const d = digits(pinEl.value);
    if(d.length<10) return;
    if(Date.now()-lastSend<COOLDOWN_MS) return;

    const card = ten(d);

    // Local match first
    if(bootstrapReady){
      if(mapStudents.has(card)){
        quickStudent(mapStudents.get(card),mapStudents.get(card).label);
      } else if(mapFacultyPins.has(card)){
        const f = mapFacultyPins.get(card);
        const label = firstLast(f.firstName,f.lastName);
        quickFaculty(f,label);
      } else {
        slowSubmit({ pin:card, src:'card' });
      }
    } else {
      slowSubmit({ pin:card, src:'card' });
    }

    pinEl.value='';
    lastSend=Date.now();
    pinEl.focus();
  },WEDGE_QUIET);
});

/*************************************************************
 * SLOW SUBMIT (fallback)
 *************************************************************/
async function slowSubmit({ pin, personId, src }){
  const act = isIn()?'in':'out';
  try{
    const res = await fetch(ENDPOINT,{
      method:'POST',
      headers:{'Content-Type':'application/x-www-form-urlencoded'},
      body:new URLSearchParams({
        action:act, pin:pin||'', personId:personId||'', src:src||''
      })
    });
    const data = await res.json().catch(()=>null);

    if(data && data.status==='student_in'){
      const url = VC_BASE + encodeURIComponent(pin);
      window.open(url,'_blank','width=480,height=820');
      Toast.show(`Student â€” sent to Veracross`,true);
      Chime.ok();
      return;
    }
    if(data && data.status==='student_out_recorded'){
      Toast.show(`Student â€” signed OUT`,true);
      Chime.ok();
      return;
    }

    if(data && data.status){
      const label = `${data.firstName||''} ${data.lastName||''}`.trim();
      Toast.show(`${label} signed ${data.status.toUpperCase()}`,true);
      Chime.ok();
      return;
    }

    Toast.show(data?.error || 'Error',false);
    Chime.fail();
  }catch(err){
    Toast.show('Network error',false);
    Chime.fail();
  }
}

/*************************************************************
 * SEARCH HANDLER
 *************************************************************/
qEl.addEventListener('input',()=>{
  const q = qEl.value.trim();
  if(!q){ resultsEl.innerHTML=''; return; }
  if(bootstrapReady) localSearch(q);
});

/*************************************************************
 * INIT
 *************************************************************/
document.addEventListener('DOMContentLoaded',async()=>{
  initTheme();
  updateNet();

  pinEl.disabled=true;
  qEl.disabled=true;

  try{
    await loadBootstrap();
    bootstrapReady=true;
    bootOverlay.style.display='none';
    Toast.show('Kiosk ready (fast mode)',true,1500);
  }catch(e){
    bootstrapReady=false;
    bootOverlay.style.display='none';
    Toast.show('Online without cache â€” slower fallback',false,3000);
  }

  pinEl.disabled=false;
  qEl.disabled=false;
  setAction('in');
  pinEl.focus();
});
})();
</script>
</body>
</html>
