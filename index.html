<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
<title>Guard Booth Attendance Kiosk</title>
<meta name="color-scheme" content="light dark">
<meta id="meta-theme" name="theme-color" content="#ffffff">
<style>
  :root{
    --bg:#f6f7fb; --card:#ffffff; --text:#0f172a; --muted:#667085; --border:#e5e7eb;
    --in:#16a34a; --out:#dc2626; --ok:#0f766e; --err:#b91c1c;
    --radius-lg:14px; --radius-xl:18px;
    --shadow-1:0 10px 30px rgba(0,0,0,.08);
  }
  body.dark{ --bg:#0b1020; --card:#111827; --text:#f3f4f6; --muted:#cbd5e1; --border:#374151; }

  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;}
  .wrap{margin:auto;width:min(1100px,96%);background:var(--card);
    border-radius:var(--radius-xl);box-shadow:var(--shadow-1);padding:28px;min-height:100svh;}
  h1{text-align:center;margin:0;font-size:30px;font-weight:900;}
  p.muted{text-align:center;color:var(--muted);margin:6px 0 18px;}
  .badge{position:absolute;right:16px;top:16px;font-weight:800;padding:6px 10px;border-radius:10px;border:1px solid var(--border);}
  .toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%) translateY(20px);
    opacity:0;background:var(--card);border:2px solid var(--border);
    border-radius:16px;padding:18px 24px;font-weight:900;font-size:22px;
    box-shadow:0 8px 30px rgba(0,0,0,.15);transition:all .2s ease;pointer-events:none;
    z-index:100;text-align:center;}
  .toast.show{opacity:1;transform:translateX(-50%) translateY(0);}
  .toast.ok{color:var(--ok);} .toast.err{color:var(--err);}
  .segment{display:flex;gap:14px;justify-content:center;margin:20px 0;}
  .segment button{flex:1;max-width:300px;border:2px solid #d1d5db;border-radius:16px;font-weight:900;
    font-size:42px;min-height:96px;cursor:pointer;background:#f8fafc;}
  .segment button.active#actIn{background:linear-gradient(180deg,#16a34a 0%,#15803d 100%);
    color:#fff;border-color:#16a34a;}
  .segment button.active#actOut{background:linear-gradient(180deg,#dc2626 0%,#991b1b 100%);
    color:#fff;border-color:#dc2626;}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:18px;}
  .card{border:1px solid var(--border);border-radius:14px;background:var(--card);padding:16px;}
  .card h2{text-align:center;margin-top:0;}
  input[type=password],input[type=search]{width:100%;padding:18px 20px;font-size:22px;
    border:1.5px solid var(--border);border-radius:12px;background:var(--card);color:var(--text);}
  .list{display:grid;gap:12px;max-height:460px;overflow:auto;margin-top:14px;}
  .sectionHdr{text-align:center;font-weight:900;font-size:15px;letter-spacing:.12em;color:var(--muted);}
  .row{display:grid;grid-template-columns:1fr auto;align-items:center;gap:10px;
    border:1px solid var(--border);border-radius:12px;padding:14px 16px;}
  .name{font-weight:800;font-size:20px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
  .actionBtn{background:linear-gradient(180deg,#2563eb 0%,#1e40af 100%);color:#fff;font-size:20px;
    padding:14px 18px;border-radius:12px;border:none;font-weight:900;cursor:pointer;}
  @media(max-width:900px){.grid{grid-template-columns:1fr;}}
</style>
</head>
<body>
<div class="wrap">
  <div id="netBadge" class="badge">Online</div>
  <h1>Guard Booth Attendance Kiosk</h1>
  <p class="muted">Select <b>IN</b> or <b>OUT</b>, then tap a card or search by name.</p>

  <div class="segment">
    <button id="actIn" class="active">IN</button>
    <button id="actOut">OUT</button>
  </div>

  <div class="grid">
    <div class="card">
      <h2>Card Input</h2>
      <input id="pin" type="password" inputmode="numeric" placeholder="Tap or swipe card…">
    </div>
    <div class="card">
      <h2>Lookup by Name</h2>
      <input id="q" type="search" placeholder="Search faculty or students">
      <div id="results" class="list"></div>
    </div>
  </div>

  <div id="toast" class="toast"></div>
</div>

<script>
const ENDPOINT='https://script.google.com/macros/s/AKfycbzF4Hy0W2ZBbB6dOPRcT3PIKsEZekW2HtHuPAAp99jwUpasH7Iq1mMYCtQ35WEPfkiQQw/exec';
const VC_BASE='https://checkin.veracross.com/frisch/kiosk/entrance?legacy=';

const pinEl=document.querySelector('#pin'),qEl=document.querySelector('#q'),toastEl=document.querySelector('#toast');
const btnIn=document.querySelector('#actIn'),btnOut=document.querySelector('#actOut');
const netBadge=document.querySelector('#netBadge');
function updateNet(){netBadge.textContent=navigator.onLine?'Online':'Offline';netBadge.style.background=navigator.onLine?'var(--card)':'#fee2e2';netBadge.style.color=navigator.onLine?'var(--text)':'#991b1b';}
window.addEventListener('online',updateNet);window.addEventListener('offline',updateNet);updateNet();
function setAction(a){btnIn.classList.toggle('active',a==='in');btnOut.classList.toggle('active',a==='out');pinEl.focus();}
btnIn.onclick=()=>setAction('in');btnOut.onclick=()=>setAction('out');

/* Toast + chime */
let ctx;function tone(f,t){if(!ctx){ctx=new(window.AudioContext||window.webkitAudioContext)();}
const osc=ctx.createOscillator(),g=ctx.createGain();osc.connect(g);g.connect(ctx.destination);
osc.type='sine';osc.frequency.value=f;g.gain.setValueAtTime(0,ctx.currentTime);
g.gain.linearRampToValueAtTime(0.9,ctx.currentTime+.01);
g.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+t);
osc.start(ctx.currentTime);osc.stop(ctx.currentTime+t+.02);}
function chimeOk(){tone(660,0.15);setTimeout(()=>tone(880,0.15),120);setTimeout(()=>tone(1046,0.18),240);}
function chimeFail(){tone(440,0.18);setTimeout(()=>tone(392,0.18),120);}
let toastTimer;function showToast(msg,ok=true){toastEl.textContent=msg;toastEl.classList.toggle('ok',ok);toastEl.classList.toggle('err',!ok);toastEl.classList.add('show');clearTimeout(toastTimer);toastTimer=setTimeout(()=>toastEl.classList.remove('show'),2400);}

/* submit */
const lastSeen=new Map();const DEDUPE_MS=5000;
async function submitPinOrId({pin,personId}){
  const act=btnIn.classList.contains('active')?'in':'out';
  const key=pin?'p:'+pin:'id:'+personId;
  const now=Date.now();if(lastSeen.has(key)&&now-lastSeen.get(key)<DEDUPE_MS){showToast('Duplicate scan ignored (5s)',false);return;}
  lastSeen.set(key,now);
  showToast(act==='in'?'Signing IN…':'Signing OUT…');
  const body=new URLSearchParams({action:act,...(pin?{pin}:{personId})});
  try{
    const res=await fetch(ENDPOINT,{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body});
    const text=await res.text();let data;try{data=JSON.parse(text);}catch{}
    if(!res.ok||(data&&data.error)){
      let msg=(data&&data.error)||('Error '+res.status);
      if(/not\s*found/i.test(msg))msg='Cougar Card not found';
      showToast(msg,false);chimeFail();return;
    }
    if(data.status==='student_in'&&data.legacyId){
      const legacy=data.legacyId,name=data.student||'Student';
      window.open(VC_BASE+encodeURIComponent(legacy),'_blank','width=480,height=820');
      showToast(`${name} — sent to Veracross`);chimeOk();return;
    }
    const{status,firstName,lastName,time}=data||{};
    const verb=status==='in'?'IN':status==='out'?'OUT':(status||'').toUpperCase();
    showToast(`${firstName||''} ${lastName||''} signed ${verb} — ${time||''}`);chimeOk();
  }catch{showToast('Network error',false);chimeFail();}
}

/* card auto submit */
pinEl.addEventListener('input',()=>{
  const v=pinEl.value.replace(/\D+/g,'');
  if(v.length>=10){const ten=v.slice(-10);pinEl.value='';submitPinOrId({pin:ten});}
});

/* search */
let sTimer=null,sAbort=null,sToken=0;
qEl.addEventListener('input',()=>{
  clearTimeout(sTimer);const q=qEl.value.trim();const box=document.querySelector('#results');
  if(!q){box.innerHTML='';return;}sTimer=setTimeout(()=>doSearch(q),150);
});
function sectionHeader(t){const d=document.createElement('div');d.className='sectionHdr';d.textContent=t;return d;}
function resultRow(name,btn,onClick){const r=document.createElement('div');r.className='row';const n=document.createElement('div');n.className='name';n.textContent=name;const b=document.createElement('button');b.className='actionBtn';b.textContent=btn;b.onclick=onClick;r.append(n,b);return r;}
async function doSearch(q){
  try{sAbort?.abort();}catch{};sAbort=new AbortController();const sig=sAbort.signal;const my=++sToken;
  const box=document.querySelector('#results');box.innerHTML='<div class="sectionHdr">Searching…</div>';
  try{
    const [f,s]=await Promise.allSettled([
      fetch(`${ENDPOINT}?action=search&q=${encodeURIComponent(q)}`,{signal:sig}).then(r=>r.json()),
      fetch(`${ENDPOINT}?action=studentSearch&q=${encodeURIComponent(q)}`,{signal:sig}).then(r=>r.json())
    ]);
    if(my!==sToken)return;
    const fac=f.status==='fulfilled'?f.value:[],stu=s.status==='fulfilled'?s.value:[];
    const frag=document.createDocumentFragment();
    if(fac.length){frag.append(sectionHeader('FACULTY'));fac.forEach(v=>frag.append(resultRow(`${v.firstName} ${v.lastName}`,'Submit',()=>submitPinOrId({personId:v.personId}))));}
    if(stu.length){frag.append(sectionHeader('STUDENTS'));stu.forEach(v=>{const full=v.fullName;const flip=/^([^,]+),\s*(.+)$/.exec(full);const lbl=flip?`${flip[2]} ${flip[1]}`:full;frag.append(resultRow(lbl,'Sign IN',()=>{window.open(VC_BASE+encodeURIComponent(v.legacyId),'_blank','width=480,height=820');showToast(`${lbl} — sent to Veracross`);chimeOk();}));});}
    box.innerHTML='';box.append(frag);
  }catch(e){if(e.name!=='AbortError')document.querySelector('#results').innerHTML='<div class="sectionHdr">Search failed</div>';}
}
</script>
</body>
</html>
