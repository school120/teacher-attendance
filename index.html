<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Teacher Attendance ‚Äî Guard Console</title>
<meta name="description" content="Guard console for IN/OUT with 10-digit Quick Pin or name lookup. Web NFC on Android; keyboard-wedge readers everywhere." />
<meta name="color-scheme" content="light dark">
<meta id="meta-theme" name="theme-color" content="#ffffff">
<style>
  /* ================= Design Tokens ================= */
  :root {
    --bg: #f6f7fb;
    --card: #ffffff;
    --text: #0f172a;
    --subtext: #475467;
    --muted: #667085;
    --border: #e5e7eb;

    --primary:#111827;
    --in:#16a34a;
    --out:#dc2626;
    --blue:#2563eb; /* static blue for search Submit */

    --ok-bg: #dcfce7; --ok-text:#166534; --ok-border:#bbf7d0;
    --warn-bg: #fee2e2; --warn-text:#991b1b; --warn-border:#fecaca;
    --nfc-bg:#e0e7ff; --nfc-text:#3730a3; --nfc-border:#c7d2fe;

    --radius-xl: 18px; --radius-lg:14px; --radius-md:12px; --radius-sm:10px; --radius-pill:999px;
    --shadow-1: 0 10px 30px rgba(0,0,0,.08);
    --shadow-2: 0 14px 40px rgba(0,0,0,.18);
    --ring: 0 0 0 6px rgba(59,130,246,.16);
  }
  body.dark {
    --bg:#0b1020;
    --card:#0f172a;
    --text:#e5e7eb;
    --subtext:#cbd5e1;
    --muted:#94a3b8;
    --border:#1f2937;
    --primary:#e5e7eb;
    --shadow-1: 0 10px 30px rgba(0,0,0,.5);
    --shadow-2: 0 14px 40px rgba(0,0,0,.6);
  }

  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  html, body { height:100%; }
  body { display:flex; min-height:100svh; margin:0; background:var(--bg); color:var(--text); font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }

  /* ================= Layout ================= */
  .wrap { margin:auto; width:min(1100px,96%); background:var(--card); padding:28px; border-radius:var(--radius-xl); box-shadow:var(--shadow-1); position:relative; outline: none; }
  h1 { margin:0 0 6px; font-weight:800; font-size:28px; letter-spacing:.2px; }
  .sub { color:var(--subtext); margin-bottom:12px; font-size:16px; }
  .grid { display:grid; grid-template-columns: 1fr 1fr; gap:18px; align-items:start; }

  .card { border:1px solid var(--border); border-radius:var(--radius-lg); padding:16px; background:var(--card); }
  .card h2 { margin:0 0 10px; font-size:20px; }

  /* Inputs */
  input[type="password"], input[type="search"], input[type="text"] {
    padding:18px 20px; font-size:24px; border:1.5px solid #d0d5dd; border-radius:var(--radius-md); width:100%; background:transparent; color:var(--text);
    outline: none; transition: box-shadow .2s ease, border-color .2s ease, transform .06s ease;
  }
  body.dark input[type="password"], body.dark input[type="search"], body.dark input[type="text"] { border-color:#334155; }
  input:focus-visible { border-color:#3b82f6; box-shadow: var(--ring); }
  input:active { transform: scale(.999); }

  .muted { color:var(--muted); }
  .list { display:grid; gap:12px; max-height:460px; overflow:auto; margin-top:14px; }
  .row { display:flex; justify-content:space-between; align-items:center; gap:16px; padding:14px 16px; border:1px solid var(--border); border-radius:var(--radius-md); background: color-mix(in oklab, var(--card) 92%, #fff 8%); }
  @supports not (background: color-mix(in oklab, #000 0%, #fff 0%)) { .row{ background: rgba(127,127,127,.06); } }
  .name { font-weight:800; font-size:20px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

  .btn { padding:14px 18px; border:0; border-radius:var(--radius-lg); font-size:18px; cursor:pointer; font-weight:800; line-height:1; transition: transform .06s ease, box-shadow .2s ease, opacity .2s ease; background:var(--card); color:var(--text); border:1px solid var(--border); box-shadow: 0 2px 10px rgba(0,0,0,.06); }
  .btn:active { transform: scale(.992); }
  .btn.primary { background:var(--primary); color:#fff; border-color: transparent; }

  /* ================= Action Segment (IN/OUT) ================= */
  .segment { display:flex; gap:14px; width:100%; }
  .segment.segment-xl button {
    flex:1 1 0;
    border:2px solid #d1d5db; background:linear-gradient(180deg, #f8fafc 0%, #eef2f7 100%);
    border-radius:16px; font-weight:900; font-size:42px; line-height:1.1; min-height:96px; padding:22px 24px;
    cursor:pointer; color:#111; box-shadow:0 4px 10px rgba(0,0,0,.05);
    transition: transform .06s ease, box-shadow .2s ease, background .2s ease, color .2s ease, border-color .2s ease;
    touch-action: manipulation; user-select:none;
  }
  body.dark .segment.segment-xl button { border-color:#334155; background:linear-gradient(180deg, #111827 0%, #0b1220 100%); color:var(--text); }
  .segment.segment-xl button:focus-visible { outline: none; box-shadow: var(--ring); border-color:#3b82f6; }
  .segment.segment-xl button:active { transform: translateY(1px); }
  .segment.segment-xl button.active#actIn {
    background:linear-gradient(180deg, color-mix(in oklab, var(--in) 94%, #fff 6%), color-mix(in oklab, var(--in) 88%, #000 12%));
    color:#fff; border-color:var(--in); box-shadow:0 0 0 4px rgba(22,163,74,.25);
    animation: pulse 350ms ease-out;
  }
  .segment.segment-xl button.active#actOut {
    background:linear-gradient(180deg, color-mix(in oklab, var(--out) 94%, #fff 6%), color-mix(in oklab, var(--out) 88%, #000 12%));
    color:#fff; border-color:var(--out); box-shadow:0 0 0 4px rgba(220,38,38,.25);
    animation: pulse 350ms ease-out;
  }
  @supports not (background: color-mix(in oklab, #000 0%, #fff 0%)){
    .segment.segment-xl button.active#actIn { background: var(--in); }
    .segment.segment-xl button.active#actOut { background: var(--out); }
  }

  /* ================= Search Submit (static blue) ================= */
  .actionBtn {
    --c: var(--blue);
    background:linear-gradient(180deg, var(--c) 0%, color-mix(in srgb, var(--c) 80%, #000 20%) 100%);
    color:#fff;
    font-size:20px;
    padding:16px 20px;
    border:2px solid var(--c);
    border-radius:14px;
    font-weight:900;
    cursor:pointer;
    transition: transform .06s ease, filter .15s ease, box-shadow .2s ease;
    box-shadow:0 6px 14px rgba(0,0,0,.12);
    position:relative;
    overflow:hidden;
  }
  .actionBtn:hover { filter:brightness(.96); transform:translateY(-1px); }
  .actionBtn:active { transform:scale(.985); box-shadow: inset 0 3px 8px rgba(0,0,0,.25); }
  .actionBtn .ripple { position:absolute; border-radius:50%; transform:scale(0); opacity:.35; background:#fff; pointer-events:none; animation:ripple .6s ease-out forwards; }
  @keyframes ripple { to { transform:scale(12); opacity:0; } }

  /* ================= Toast & Badges ================= */
  .toast { position: fixed; left: 50%; bottom: 24px; transform: translateX(-50%) translateY(20px); opacity: 0; background: var(--card); border:1px solid var(--border); box-shadow: 0 8px 30px rgba(0,0,0,.12); border-radius: 14px; padding: 16px 20px; font-weight:800; transition: all .25s ease; pointer-events:none; font-size:18px; }
  .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
  .badges { position:absolute; right:18px; top:18px; display:flex; gap:8px; align-items:center; }
  .badge { font-size:12px; font-weight:800; padding:6px 10px; border-radius:999px; border:1px solid var(--border); background:var(--card); color:var(--text); }
  .badge.offline { background:var(--warn-bg); color:var(--warn-text); border-color:var(--warn-border); }
  .badge.ok { background:var(--ok-bg); color:var(--ok-text); border-color:var(--ok-border); }
  .badge.nfc { background:var(--nfc-bg); color:var(--nfc-text); border-color:var(--nfc-border); }
  .gear { border:1px solid var(--border); background:var(--card); color:var(--text); border-radius:10px; padding:6px 10px; cursor:pointer; font-weight:800; }
  .gear:focus-visible { outline:none; box-shadow: var(--ring); }

  /* ================= Admin Drawer ================= */
  .drawer { position: fixed; right: 16px; top: 64px; width: min(520px, 92%); max-height: 80vh; border:1px solid var(--border); background:var(--card); border-radius:16px; box-shadow:var(--shadow-2); padding:16px; overflow:auto; display:none; z-index:20; color:var(--text); }
  .drawer h3 { margin:0 0 10px; font-size:18px; }
  .opt { display:flex; gap:10px; align-items:center; margin:8px 0; }
  .opt label { font-size:14px; }
  .hint { color:var(--muted); font-size:12px; margin-top:6px; }
  .live { margin-top:14px; border-top:1px dashed var(--border); padding-top:12px; }
  .kv { display:grid; grid-template-columns: 140px 1fr; gap:8px 12px; font-size:14px; }
  .kv .k { color:var(--muted); }
  .log { margin-top:10px; max-height:200px; overflow:auto; background: color-mix(in oklab, var(--card) 92%, #fff 8%); border:1px solid var(--border); border-radius:10px; padding:10px; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; }
  @supports not (background: color-mix(in oklab, #000 0%, #fff 0%)) { .log{ background: rgba(127,127,127,.06); } }
  .log .item { padding:4px 0; border-bottom:1px dashed var(--border); }
  .log .item:last-child { border-bottom:0; }

  /* NFC buttons (original purple) */
  .nfcBar { display:flex; align-items:center; gap:12px; flex-wrap:wrap; margin-top:10px; }
  .nfcBtn {
    padding:14px 18px; border-radius:12px; border:2px solid #4f46e5; color:#fff; background:#4f46e5;
    font-weight:800; cursor:pointer; font-size:18px; transition: transform .06s ease, box-shadow .2s ease;
  }
  .nfcBtn.secondary { background:transparent; color:#4f46e5; }
  .nfcBtn:focus-visible { outline:none; box-shadow: 0 0 0 6px rgba(79,70,229,.2); }

  .foot { display:flex; justify-content:space-between; align-items:center; color:var(--muted); font-size:12px; margin-top:8px; gap:12px; flex-wrap:wrap; }

  @media (prefers-reduced-motion: reduce){ .segment.segment-xl button, .btn, .actionBtn, .toast { transition: none; } @keyframes pulse { from{box-shadow:none} to{box-shadow:none} } }
  @keyframes pulse { 0%{box-shadow:0 0 0 0 rgba(0,0,0,0);} 50%{box-shadow:0 0 0 6px rgba(0,0,0,.06);} 100%{box-shadow:0 0 0 4px rgba(0,0,0,0);} }

  @media (max-width: 900px) {
    .grid { grid-template-columns: 1fr; }
    .segment.segment-xl button { font-size:36px; min-height:88px; }
    .wrap { padding:22px; }
  }
</style>
</head>
<body>
  <div class="wrap" role="application" aria-label="Teacher Attendance Guard Console" tabindex="-1">
    <div class="badges" aria-live="polite" aria-atomic="true">
      <div id="netBadge" class="badge ok">Online</div>
      <div id="nfcBadge" class="badge nfc" style="display:none;">NFC Ready</div>
      <div id="actBadge" class="badge">IN</div>
      <button id="themeBtn" class="gear" title="Toggle theme" aria-pressed="false" aria-label="Toggle dark mode">üåô Dark</button>
      <button id="adminBtn"$1 aria-label="Admin settings">‚öôÔ∏è Admin</button>
    </div>

    <h1>Teacher Attendance ‚Äî Guard Console</h1>
    <p class="sub">Choose <b>IN</b> or <b>OUT</b>, then swipe/tap a card (10-digit Quick Pin) or look up by name. Android Chrome supports Web NFC; iPhone uses a Bluetooth/USB keyboard-wedge reader or manual entry.</p>

    <div class="card" style="margin-bottom:16px;">
      <div style="display:flex;align-items:center;gap:14px;flex-wrap:wrap;">
        <div class="segment segment-xl" role="tablist" aria-label="Action">
          <button id="actIn"  class="active" role="tab" aria-selected="true"  type="button" aria-label="Set action to IN">IN</button>
          <button id="actOut" role="tab" aria-selected="false" type="button" aria-label="Set action to OUT">OUT</button>
        </div>
        <div class="muted" style="flex:1 1 100%">Action applies to both card pins and name lookup.</div>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>Quick Pin (10 digits, auto)</h2>
        <input id="pin" inputmode="numeric" autocomplete="one-time-code" pattern="\d{10}" maxlength="10"
               placeholder="Enter 10-digit code‚Ä¶" type="password" aria-label="Quick Pin" autofocus />

        <div id="nfcBar" class="nfcBar" style="display:none;">
          <button id="nfcStart" class="nfcBtn">Scan with NFC</button>
          <button id="nfcStop"  class="nfcBtn secondary">Stop</button>
        </div>
      </div>

      <div class="card">
        <h2>Lookup by Name</h2>
        <input id="q" type="text" inputmode="search" enterkeyhint="search" autocomplete="name"
               autocapitalize="words" autocorrect="off" spellcheck="false"
               placeholder="Start typing first or last name" aria-label="Search teacher by name" />
        <div id="results" class="list" role="list" aria-live="polite"></div>
      </div>
    </div>

    <div id="toast" class="toast" role="status" aria-live="polite"></div>
    <div class="foot">
      <span>¬© Yeshivat Frisch 5786</span>
    </div>
  </div>

  <!-- Admin drawer with Live Reader -->
  <div id="admin" class="drawer" role="dialog" aria-modal="false" aria-labelledby="adminTitle">
    <h3 id="adminTitle">Admin Settings</h3>

    <div style="margin-top:8px;">
      <strong>NFC mapping rule</strong>
      <div class="hint">Use a different rule if some cards don‚Äôt match. Default is HEX_LE_PAD10.</div>
      <div class="opt"><input type="radio" name="rule" value="HEX_LE_PAD10" id="r1"><label for="r1">HEX_LE_PAD10 (last 4 bytes, little-endian ‚Üí dec ‚Üí pad10)</label></div>
      <div class="opt"><input type="radio" name="rule" value="HEX_BE_PAD10" id="r2"><label for="r2">HEX_BE_PAD10 (last 4 bytes, big-endian ‚Üí dec ‚Üí pad10)</label></div>
      <div class="opt"><input type="radio" name="rule" value="LAST3_DEC_PAD10" id="r3"><label for="r3">LAST3_DEC_PAD10 (last 3 bytes, big-endian ‚Üí dec ‚Üí pad10)</label></div>
      <div class="opt"><input type="radio" name="rule" value="FULL_UID_DEC_PAD10" id="r4"><label for="r4">FULL_UID_DEC_PAD10 (full UID big-endian ‚Üí dec ‚Üí last10)</label></div>
      <div class="opt"><input type="radio" name="rule" value="PASS_THROUGH_DIGITS_PAD10" id="r5"><label for="r5">PASS_THROUGH_DIGITS_PAD10 (reader already types digits)</label></div>
    </div>

    <div style="margin-top:14px;">
      <strong>Keyboard wedge</strong>
      <div class="opt"><input type="checkbox" id="ckTrim" checked><label for="ckTrim">Trim to digits & pad to 10 (recommended)</label></div>
      <div class="opt"><input type="checkbox" id="ckIgnoreEnter" checked><label for="ckIgnoreEnter">Ignore Enter key (prevents double submit)</label></div>
    </div>

    <div style="margin-top:14px;">
      <strong>Debug</strong>
      <div class="opt"><input type="checkbox" id="ckDebug"><label for="ckDebug">Show UID ‚Üí computed 10-digit in toast</label></div>
      <div class="hint">Toggle also with Shift + D.</div>
    </div>

    <div class="live">
      <h3 style="margin-bottom:8px;">Live Reader</h3>
      <div class="kv">
        <div class="k">Rule</div><div id="liveRule">HEX_LE_PAD10</div>
        <div class="k">Last UID</div><div id="liveUid">‚Äî</div>
        <div class="k">Last 10-digit</div><div id="liveTen">‚Äî</div>
      </div>
      <div class="log" id="liveLog" aria-label="Reader log"></div>
    </div>

    <div style="margin-top:14px; display:flex; gap:8px;">
      <button id="adminClose" class="btn">Close</button>
      <button id="adminReset" class="btn">Reset to defaults</button>
      <button id="adminClearLog" class="btn">Clear Log</button>
    </div>
  </div>

<script>
  // ====== CONFIG ======
  const ENDPOINT = 'https://script.google.com/macros/s/AKfycbzF4Hy0W2ZBbB6dOPRcT3PIKsEZekW2HtHuPAAp99jwUpasH7Iq1mMYCtQ35WEPfkiQQw/exec';
  const COOLDOWN_MS = 400;
  const THEME_KEY = 'theme'; // 'light' | 'dark'
  const RULE_KEY = 'nfcRule';
  const TRIM_KEY = 'wedgeTrim';
  const IGNENTER_KEY = 'wedgeIgnoreEnter';
  const DEBUG_KEY = 'debugOn';
  const DEFAULTS = { [RULE_KEY]:'HEX_LE_PAD10', [TRIM_KEY]:'1', [IGNENTER_KEY]:'1', [DEBUG_KEY]:'0' };

  // ====== DOM ======
  const $ = sel => document.querySelector(sel);
  const pinEl = $('#pin'), qEl = $('#q'), resultsEl = $('#results'), toastEl = $('#toast');
  const btnIn = $('#actIn'), btnOut = $('#actOut');
  const netBadge = $('#netBadge'), actBadge = $('#actBadge');
  const nfcBadge = $('#nfcBadge'), nfcBar = $('#nfcBar'), nfcStartBtn = $('#nfcStart'), nfcStopBtn = $('#nfcStop');
  const adminBtn = $('#adminBtn'), admin = $('#admin'), adminClose = $('#adminClose'), adminReset = $('#adminReset'), adminClearLog = $('#adminClearLog');
  const ckTrim = $('#ckTrim'), ckIgnoreEnter = $('#ckIgnoreEnter'), ckDebug = $('#ckDebug');
  const themeBtn = $('#themeBtn');
  const metaTheme = document.querySelector('#meta-theme');
  const liveRuleEl = $('#liveRule'), liveUidEl = $('#liveUid'), liveTenEl = $('#liveTen'), liveLogEl = $('#liveLog');

  // ====== Theme ======
  function setTheme(mode){
    const dark = mode === 'dark';
    document.body.classList.toggle('dark', dark);
    themeBtn.setAttribute('aria-pressed', String(dark));
    themeBtn.textContent = dark ? '‚òÄÔ∏è Light' : 'üåô Dark';
    if (metaTheme) metaTheme.content = dark ? '#0b1020' : '#ffffff';
    localStorage.setItem(THEME_KEY, dark ? 'dark' : 'light');
  }
  function initTheme(){
    const saved = localStorage.getItem(THEME_KEY);
    if (saved) { setTheme(saved); return; }
    const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    setTheme(prefersDark ? 'dark' : 'light');
  }
  themeBtn.addEventListener('click', () => setTheme(document.body.classList.contains('dark') ? 'light' : 'dark'));

  // ====== Admin state helpers ======
  function lsGet(k, def){ const v = localStorage.getItem(k); return v==null ? def : v; }
  function lsSet(k, v){ localStorage.setItem(k, v); }
  function getSelectedNfcRule(){ return lsGet(RULE_KEY, DEFAULTS[RULE_KEY]); }
  function mountAdmin(){
    (document.querySelector(`input[name="rule"][value="${getSelectedNfcRule()}"]`) || $('#r1')).checked = true;
    ckTrim.checked = lsGet(TRIM_KEY, DEFAULTS[TRIM_KEY]) === '1';
    ckIgnoreEnter.checked = lsGet(IGNENTER_KEY, DEFAULTS[IGNENTER_KEY]) === '1';
    ckDebug.checked = lsGet(DEBUG_KEY, DEFAULTS[DEBUG_KEY]) === '1';
    liveRuleEl.textContent = getSelectedNfcRule();
  }
  function showAdmin(show=true){ admin.style.display = show ? 'block' : 'none'; }
  adminBtn.addEventListener('click', () => { mountAdmin(); showAdmin(true); admin.setAttribute('aria-modal','true'); admin.focus?.(); });
  adminClose.addEventListener('click', () => { showAdmin(false); admin.setAttribute('aria-modal','false'); });
  adminReset.addEventListener('click', () => {
    Object.entries(DEFAULTS).forEach(([k,v]) => lsSet(k,v));
    mountAdmin(); liveLogEl.innerHTML=''; liveUidEl.textContent='‚Äî'; liveTenEl.textContent='‚Äî';
    showToast('Admin reset to defaults');
  });
  adminClearLog.addEventListener('click', () => { liveLogEl.innerHTML=''; });

  document.querySelectorAll('input[name="rule"]').forEach(r => {
    r.addEventListener('change', () => {
      if (r.checked) { lsSet(RULE_KEY, r.value); liveRuleEl.textContent = r.value; showToast('Rule: ' + r.value); focusPin(); }
    });
  });
  ckTrim.addEventListener('change', () => lsSet(TRIM_KEY, ckTrim.checked ? '1' : '0'));
  ckIgnoreEnter.addEventListener('change', () => lsSet(IGNENTER_KEY, ckIgnoreEnter.checked ? '1' : '0'));
  ckDebug.addEventListener('change', () => lsSet(DEBUG_KEY, ckDebug.checked ? '1' : '0'));
  window.addEventListener('keydown', (e) => {
    if (e.shiftKey && (e.key === 'D' || e.key === 'd')) {
      const nv = lsGet(DEBUG_KEY, '0') === '1' ? '0' : '1';
      lsSet(DEBUG_KEY, nv); showToast('Debug ' + (nv==='1' ? 'ON' : 'OFF'));
    }
  });

  // ====== Focus management ======
  function focusPin(){ try { pinEl.focus(); pinEl.select && pinEl.select(); } catch(_) {} }
  function focusName(){
    try {
      qEl.focus({ preventScroll:true });
      setTimeout(()=>{ if (qEl.setSelectionRange) { const l=qEl.value.length; qEl.setSelectionRange(l,l); } },0);
    } catch(_) {}
  }
  document.addEventListener('visibilitychange', () => { if (!document.hidden) focusPin(); });
  window.addEventListener('pageshow', (e) => { if (e.persisted) focusPin(); });
  const firstTap = () => { focusPin(); window.removeEventListener('pointerdown', firstTap); };
  window.addEventListener('pointerdown', firstTap, { once:true });

  // prevent refocus while typing name
  let nameFocusHold = false;
  qEl.addEventListener('focus', () => { nameFocusHold = true; });
  qEl.addEventListener('blur',  () => { setTimeout(()=>{ nameFocusHold = false; }, 200); });
  qEl.closest('.card').addEventListener('click', (e) => { if (e.target !== qEl) focusName(); });

  // ====== Single status surface (toast only) ======
  let toastTimer = null;
  function showToast(text){ toastEl.textContent = text; toastEl.classList.add('show'); clearTimeout(toastTimer); toastTimer = setTimeout(()=>toastEl.classList.remove('show'), 2400); }
  function setMsg(text){ showToast(text); }
  function setPinMsg(text){ showToast(text); }

  // ====== Network badge ======
  function onlineChanged(){
    const on = navigator.onLine;
    netBadge.textContent = on ? 'Online' : 'Offline';
    netBadge.className = 'badge ' + (on ? 'ok' : 'offline');
  }
  window.addEventListener('online', onlineChanged);
  window.addEventListener('offline', onlineChanged);
  onlineChanged();

  // ====== Action toggle ======
  function currentAction(){ return btnIn.classList.contains('active') ? 'in' : 'out'; }
  function setAction(a){
    const inActive = (a === 'in');
    btnIn.classList.toggle('active', inActive);  btnIn.setAttribute('aria-selected', String(inActive));
    btnOut.classList.toggle('active', !inActive); btnOut.setAttribute('aria-selected', String(!inActive));
    actBadge.textContent = inActive ? 'IN' : 'OUT';
    setTimeout(() => focusPin(), 0);
  }
  btnIn.addEventListener('click', () => setAction('in'));
  btnOut.addEventListener('click', () => setAction('out'));
  window.addEventListener('keydown', (e) => {
    if (e.key === 'ArrowLeft') setAction('in');
    if (e.key === 'ArrowRight') setAction('out');
  });

  // ====== Normalize to 10 digits ======
  function normalizeToTenDigits(raw) {
    const trimOn = lsGet('wedgeTrim', '1') === '1';
    if (!trimOn) return String(raw || '');
    if (raw == null) return '';
    const digits = String(raw).replace(/\D+/g, '');
    if (!digits) return '';
    return digits.length <= 10 ? digits.padStart(10, '0') : digits.slice(-10);
  }

  // ====== UID conversion helpers ======
  function hexToBytes(hex){ const s=(hex||'').replace(/[^0-9a-f]/gi,''); const out=[]; for(let i=0;i<s.length;i+=2) out.push(parseInt(s.substr(i,2),16)); return out; }
  function bytesToNumberLE(bytes){ return bytes.reduceRight((a,b)=>(a*256+b)>>>0,0); }
  function bytesToNumberBE(bytes){ return bytes.reduce((a,b)=>(a*256+b)>>>0,0); }
  function pad10(n){ const s=String(n>>>0); return s.length>=10? s.slice(-10) : s.padStart(10,'0'); }
  function uidToTenByRule(uidHex, ruleId){
    const bytes = hexToBytes(uidHex);
    switch (ruleId) {
      case 'HEX_LE_PAD10': return pad10(bytesToNumberLE(bytes.slice(-4)));
      case 'HEX_BE_PAD10': return pad10(bytesToNumberBE(bytes.slice(-4)));
      case 'LAST3_DEC_PAD10': return pad10(bytesToNumberBE(bytes.slice(-3)));
      case 'FULL_UID_DEC_PAD10': return pad10(bytesToNumberBE(bytes));
      case 'PASS_THROUGH_DIGITS_PAD10': return normalizeToTenDigits(uidHex);
      default: return '';
    }
  }

  // ====== Submit API ======
  let lastSubmitAt = 0;
  async function submitPinOrId({ pin, personId }) {
    const act = currentAction();
    const body = new URLSearchParams({ action: act, ...(pin?{pin}:{}), ...(personId?{personId}:{}) }).toString();
    try {
      const res = await fetch(ENDPOINT, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body });
      const text = await res.text(); let data=null; try { data = JSON.parse(text); } catch {}
      if (!res.ok || (data && data.error)) {
        const msg = (data && data.error) ? String(data.error) : ('Error ' + res.status);
        const nicer = /not found/i.test(msg) ? 'Quick Pin / Person not found in Directory' : msg;
        setMsg(nicer); return;
      }
      const { status, firstName, lastName, time, paired } = data || {};
      const extra = (status === 'out' && typeof paired === 'boolean') ? (paired ? ' (paired)' : ' (no prior IN)') : '';
      const verb = (status === 'in') ? 'IN' : (status === 'out') ? 'OUT' : 'UPDATED';
      const line = `${firstName||''} ${lastName||''} signed ${verb}${extra} ‚Äî ${time||''}`.trim();
      setMsg(line || 'Done.');
      try { navigator.vibrate?.(30); } catch {}
    } catch {
      setMsg('Network error');
    } finally {
      lastSubmitAt = Date.now();
      focusPin();
    }
  }

  // ====== Auto-submit only (ignore Enter) ======
  let pinTimer = null;
  pinEl.addEventListener('input', () => {
    clearTimeout(pinTimer);
    const norm = normalizeToTenDigits(pinEl.value || '');

    if (!norm) { return; }

    if (norm.length === 10) {
      pinTimer = setTimeout(() => {
        if (Date.now() - lastSubmitAt < COOLDOWN_MS) return;
        pinEl.value = norm;
        submitPinOrId({ pin: norm });
        pinEl.value = '';
        setMsg('Submitted.');
      }, 180);
    }
  });

  pinEl.addEventListener('keydown', (e) => {
    if (lsGet(IGNENTER_KEY, '1') === '1' && e.key === 'Enter') {
      e.preventDefault(); e.stopPropagation();
    }
  });

  // ====== Name Lookup ======
  let searchTimer = null;
  qEl.addEventListener('input', () => {
    clearTimeout(searchTimer);
    const q = qEl.value.trim(); resultsEl.innerHTML = '';
    if (!q) { return; }
    searchTimer = setTimeout(() => doSearch(q), 160);
  });

  function makeRipple(e, btn){
    const r = document.createElement('span');
    r.className = 'ripple';
    const rect = btn.getBoundingClientRect();
    const d = Math.max(rect.width, rect.height);
    r.style.width = r.style.height = d + 'px';
    r.style.left = (e.clientX - rect.left - d/2) + 'px';
    r.style.top  = (e.clientY - rect.top  - d/2) + 'px';
    btn.appendChild(r);
    r.addEventListener('animationend', () => r.remove());
  }

  async function doSearch(q) {
    setMsg('Searching‚Ä¶');
    try {
      const res = await fetch(ENDPOINT + `?action=search&q=${encodeURIComponent(q)}`, { method:'GET' });
      const data = await res.json();
      if (!Array.isArray(data) || data.length === 0) {
        resultsEl.innerHTML = '<div class="muted">No matches.</div>'; setMsg('No matches'); return;
      }
      resultsEl.innerHTML = '';
      data.forEach(({ firstName, lastName, personId }) => {
        const row = document.createElement('div'); row.className = 'row'; row.setAttribute('role','listitem');
        const name = document.createElement('div'); name.className = 'name'; name.textContent = `${firstName} ${lastName}`;
        const btn = document.createElement('button'); btn.className = 'actionBtn'; btn.textContent = 'Submit';
        btn.addEventListener('click', (e) => { makeRipple(e, btn); submitPinOrId({ personId }); focusPin(); });
        row.appendChild(name); row.appendChild(btn); resultsEl.appendChild(row);
      });
      setMsg('Select a name then click Submit.');
    } catch {
      resultsEl.innerHTML = '<div class="muted">Search failed.</div>'; setMsg('Search failed');
    }
  }

  // ====== NFC (Android Chrome) ======
  function supportsWebNFC(){ return 'NDEFReader' in window; }
  function DEBUG_ON(){ return lsGet(DEBUG_KEY,'0') === '1'; }
  function nfcUidToTen(uidHex){
    const rule = getSelectedNfcRule();
    return uidToTenByRule(uidHex, rule);
  }
  function hexToShort(uid){ return (uid || '').slice(-8); }

  let ndef = null, nfcStarted = false;

  function pushLive(uidHex, ten) {
    liveUidEl.textContent = uidHex || '‚Äî';
    liveTenEl.textContent = ten || '‚Äî';
    const ts = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit'});
    const div = document.createElement('div');
    div.className = 'item';
    div.textContent = `[${ts}] UID:${hexToShort(uidHex)} ‚Üí ${ten} (${getSelectedNfcRule()})`;
    liveLogEl.appendChild(div);
    liveLogEl.scrollTop = liveLogEl.scrollHeight;
  }

  async function startNFC() {
    if (!supportsWebNFC() || nfcStarted) return;
    try {
      ndef = new NDEFReader();
      await ndef.scan(); nfcStarted = true;
      setMsg('NFC scanning started');
      nfcStartBtn.disabled = true; nfcStopBtn.disabled = false; nfcBadge.style.display = '';

      ndef.onreadingerror = () => { setMsg('NFC read error ‚Äî try again'); };
      ndef.onreading = (event) => {
        const { message, serialNumber } = event;
        const uidHex = String(serialNumber || '').toUpperCase().replace(/[^0-9A-F]/g,'');

        let ten = '';
        // Try NDEF text first
        for (const record of message.records) {
          const texty = record.recordType === 'text' || record.recordType === 'url' || record.mediaType === 'text/plain';
          if (!texty) continue;
          try {
            const td = new TextDecoder(record.encoding || 'utf-8');
            const text = record.data ? td.decode(record.data) : '';
            const maybe = normalizeToTenDigits(text);
            if (maybe) { ten = maybe; break; }
          } catch {}
        }
        if (!ten && uidHex) ten = nfcUidToTen(uidHex);

        pushLive(uidHex, ten);
        if (DEBUG_ON()) setMsg(`UID:${hexToShort(uidHex)} ‚Üí ${ten} [${getSelectedNfcRule()}]`);
        if (!ten) { setMsg('NFC must resolve to a 10-digit code.'); return; }

        if (Date.now() - lastSubmitAt >= COOLDOWN_MS) {
          submitPinOrId({ pin: ten });
          setMsg('NFC submitted.');
        }
        focusPin();
      };
    } catch {
      setMsg('NFC not permitted or unavailable');
    }
  }
  function stopNFC() {
    if (ndef) { ndef.onreading = null; ndef.onreadingerror = null; }
    nfcStarted = false;
    nfcStartBtn.disabled = false; nfcStopBtn.disabled = true; setMsg('NFC stopped.');
    focusPin();
  }
  if (supportsWebNFC()) {
    nfcBar.style.display = '';
    nfcStopBtn.disabled = true;
    nfcStartBtn.addEventListener('click', startNFC);
    nfcStopBtn.addEventListener('click', stopNFC);
    const startOnFirstGesture = () => { startNFC(); focusPin(); window.removeEventListener('pointerdown', startOnFirstGesture); };
    window.addEventListener('pointerdown', startOnFirstGesture, { once: true });
  }

  // ====== Keep focus on pin after most clicks ======
  document.addEventListener('click', (e) => {
    if (nameFocusHold || e.target === qEl || qEl.contains(e.target)) return;
    if (e.target !== pinEl && e.target !== nfcStartBtn && e.target !== nfcStopBtn && e.target !== adminBtn && !admin.contains(e.target)) {
      setTimeout(() => focusPin(), 0);
    }
  });

  // ====== Init ======
  document.addEventListener('DOMContentLoaded', () => {
    initTheme();
    setAction('in');
    mountAdmin();
    focusPin();
  });
</script>
</body>
</html>
