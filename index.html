<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
<title>Teacher Attendance â€” Guard Console</title>
<meta name="color-scheme" content="light dark">
<meta id="meta-theme" name="theme-color" content="#ffffff">
<style>
  :root{
    --bg:#f6f7fb; --card:#ffffff; --text:#0f172a; --muted:#667085; --border:#e5e7eb;
    --in:#16a34a; --out:#dc2626; --blue:#2563eb; --ink:#0b1220;
    --radius-xl:18px; --ring:0 0 0 6px rgba(59,130,246,.16);
  }
  body.dark{ --bg:#0b1020; --card:#111827; --text:#f3f4f6; --muted:#cbd5e1; --border:#374151; --ink:#f3f4f6; }
  *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
  html, body { height:100%; margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
  .wrap{ margin:auto; width:min(1100px,96%); background:var(--card); border-radius:var(--radius-xl); box-shadow:0 10px 30px rgba(0,0,0,.08); min-height:100svh; padding:28px; position:relative; }
  .hero{ text-align:center; }
  h1{ margin:0 0 8px; font-weight:800; font-size:28px; letter-spacing:.2px; }
  .muted{ color:var(--muted); }

  .badges{ position:absolute; right:18px; top:18px; display:flex; gap:8px; align-items:center; }
  .badge{ font-size:12px; font-weight:800; padding:6px 10px; border-radius:999px; border:1px solid var(--border); background:var(--card); color:var(--text); }
  .gear{ border:1px solid var(--border); background:var(--card); color:var(--text); border-radius:10px; padding:6px 10px; cursor:pointer; font-weight:800; }
  .gear:focus-visible{ outline:none; box-shadow:var(--ring); }

  .segment{ display:flex; gap:14px; width:100%; margin:20px 0; max-width:900px; margin-left:auto; margin-right:auto; }
  .segment.segment-xl button{
    flex:1 1 0; border:2px solid #d1d5db; border-radius:16px;
    font-weight:900; font-size:42px; line-height:1.1; min-height:96px;
    padding:22px 24px; cursor:pointer; color:#111;
    background:linear-gradient(180deg, #f8fafc 0%, #eef2f7 100%);
    transition:transform .06s ease, box-shadow .2s ease, background .2s ease; box-shadow:0 4px 10px rgba(0,0,0,.05);
  }
  .segment.segment-xl button.active#actIn{ background:linear-gradient(180deg, #16a34a 0%, #15803d 100%); color:#fff; border-color:#16a34a; box-shadow:0 0 0 4px rgba(22,163,74,.25); }
  .segment.segment-xl button.active#actOut{ background:linear-gradient(180deg, #dc2626 0%, #991b1b 100%); color:#fff; border-color:#dc2626; box-shadow:0 0 0 4px rgba(220,38,38,.25); }

  .grid{ display:grid; grid-template-columns:1fr 1fr; gap:18px; align-items:stretch; max-width:1000px; margin:0 auto; }
  .card{ border:1px solid var(--border); border-radius:14px; background:var(--card); padding:16px; display:flex; flex-direction:column; gap:12px; }
  .card h2{ margin:0 0 2px; font-size:20px; text-align:center; }

  input[type=text], input[type=password], input[type=search]{
    width:100%; padding:18px 20px; font-size:24px; border:1.5px solid var(--border); border-radius:12px; background:var(--card); color:var(--text);
  }
  input[type=text]:focus-visible, input[type=password]:focus-visible, input[type=search]:focus-visible{ border-color:#3b82f6; box-shadow:var(--ring); outline:none; }

  .list{ display:grid; gap:12px; max-height:460px; overflow:auto; margin-top:4px; padding-right:8px; }
  .row{ display:grid; grid-template-columns:minmax(0,1fr) auto; align-items:center; gap:12px; padding:12px 14px; border:1px solid var(--border); border-radius:12px; background: var(--card); }
  .name{ min-width:0; font-weight:800; font-size:20px; color:var(--text); overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
  .sectionTag{ font-weight:900; letter-spacing:.12em; font-size:12px; opacity:.9; color:#0b1220; background:#e6eefb; padding:6px 10px; border-radius:999px; border:1px solid #c6d3f2; margin:0 auto; }
  body.dark .sectionTag{ color:#e8eefc; background:#16243c; border-color:#2a4a7d; }
  .actionBtn{ background:#2563eb; color:#fff; font-size:20px; padding:12px 16px; border:2px solid #2563eb; border-radius:14px; font-weight:900; cursor:pointer; }

  .toast{
    position:fixed; left:50%; bottom:20px; transform:translateX(-50%) translateY(10px); opacity:0;
    min-width:min(92vw, 780px);
    padding:16px 18px; border-radius:14px; background:var(--card); color:var(--ink);
    border:1px solid var(--border); box-shadow:0 12px 34px rgba(0,0,0,.18);
    pointer-events:none; z-index:1000; display:flex; align-items:center; gap:12px; justify-content:center; text-align:center;
    font-weight:900; font-size: clamp(18px, 2.6vw, 22px);
    transition: transform .12s ease-out, opacity .12s ease-out;
  }
  .toast.show{ opacity:1; transform:translateX(-50%) translateY(0); }
  .toast.ok{ border-color:#16a34a; box-shadow:0 12px 34px rgba(22,163,74,.22); }
  .toast.fail{ border-color:#dc2626; box-shadow:0 12px 34px rgba(220,38,38,.22); }
</style>
</head>
<body>
  <div class="wrap" role="application" aria-label="Teacher Attendance Guard Console">
    <div class="badges" aria-live="polite" aria-atomic="true">
      <div id="netBadge" class="badge">Online</div>
      <button id="themeBtn" class="gear" title="Toggle theme" aria-label="Toggle dark mode">ðŸŒ™ Dark</button>
    </div>

    <div class="hero">
      <h1>Teacher Attendance â€” Guard Console</h1>
      <p class="muted">Choose <b>IN</b> or <b>OUT</b>, then <b>swipe/tap card</b> or search by name (faculty first, then students).</p>
    </div>

    <div class="segment segment-xl" role="tablist" aria-label="Action">
      <button id="actIn" class="active" role="tab" aria-selected="true" type="button">IN</button>
      <button id="actOut" role="tab" aria-selected="false" type="button">OUT</button>
    </div>

    <div class="grid">
      <div class="card">
        <h2>Cougar Card (Quick Pin / Legacy ID)</h2>
        <input id="pin" type="password" maxlength="32" inputmode="numeric" autocomplete="one-time-code"
               placeholder="Tap or swipe cardâ€¦" aria-label="Cougar Card" />
      </div>

      <div class="card">
        <h2>Lookup by Name</h2>
        <input id="q" type="search" inputmode="search" enterkeyhint="search"
               autocapitalize="words" autocorrect="off" spellcheck="false"
               placeholder="Search faculty or students" aria-label="Search name" />
        <div id="results" class="list" role="list" aria-live="polite"></div>
      </div>
    </div>

    <div id="toast" class="toast" role="status" aria-live="polite">Ready.</div>
  </div>

<script>
  const ENDPOINT = 'https://script.google.com/macros/s/AKfycbzF4Hy0W2ZBbB6dOPRcT3PIKsEZekW2HtHuPAAp99jwUpasH7Iq1mMYCtQ35WEPfkiQQw/exec';
  const VC_BASE  = 'https://checkin.veracross.com/frisch/kiosk/entrance?legacy=';

  const $ = s => document.querySelector(s);
  const pinEl = $('#pin'), qEl = $('#q'), toastEl = $('#toast');
  const btnIn = $('#actIn'), btnOut = $('#actOut');
  const netBadge = $('#netBadge'), themeBtn = $('#themeBtn'), metaTheme = $('#meta-theme');

  /* Theme */
  function setTheme(mode){
    const dark = mode === 'dark';
    document.body.classList.toggle('dark', dark);
    themeBtn.textContent = dark ? 'â˜€ï¸ Light' : 'ðŸŒ™ Dark';
    if (metaTheme) metaTheme.content = dark ? '#0b1020' : '#ffffff';
    localStorage.setItem('theme', dark ? 'dark' : 'light');
  }
  (function initTheme(){
    const saved = localStorage.getItem('theme');
    setTheme(saved || (window.matchMedia?.('(prefers-color-scheme: dark)').matches ? 'dark':'light'));
    themeBtn.addEventListener('click', () => setTheme(document.body.classList.contains('dark') ? 'light' : 'dark'));
  })();

  /* Toast + chimes */
  let toastTimer=null, audioCtx=null, master=null, readyAudio=false;
  function showToast(text, kind='info'){ toastEl.textContent=text||''; toastEl.className='toast' + (kind==='ok'?' ok':kind==='fail'?' fail':''); toastEl.classList.add('show'); clearTimeout(toastTimer); toastTimer=setTimeout(()=>toastEl.classList.remove('show'), 2000); }
  function initAudioOnce(){ if(readyAudio) return; const AC=window.AudioContext||window.webkitAudioContext; if(!AC) return; audioCtx=new AC(); master=audioCtx.createGain(); master.gain.setValueAtTime(0.95,audioCtx.currentTime); master.connect(audioCtx.destination); readyAudio=true; }
  window.addEventListener('pointerdown', ()=>{try{initAudioOnce(); audioCtx?.resume?.();}catch{}}, {once:true});
  window.addEventListener('keydown',     ()=>{try{initAudioOnce(); audioCtx?.resume?.();}catch{}}, {once:true});
  function beep(f,d,t){ if(!readyAudio) return; const o=audioCtx.createOscillator(), g=audioCtx.createGain(); o.type='sine'; o.frequency.setValueAtTime(f,t); g.gain.setValueAtTime(0,t); g.gain.linearRampToValueAtTime(1,t+.01); g.gain.exponentialRampToValueAtTime(0.0001,t+d); o.connect(g).connect(master); o.start(t); o.stop(t+d+.02); }
  function chimeOK(){ if(!readyAudio) return; const t=audioCtx.currentTime+.01; beep(880,.1,t); beep(1175,.12,t+.12); beep(1318,.12,t+.24); }
  function chimeFAIL(){ if(!readyAudio) return; const t=audioCtx.currentTime+.01; beep(440,.16,t); beep(329,.18,t+.14); }

  /* Helpers */
  const digitsOnly = s => String(s||'').replace(/\D+/g,'');
  function pin10(raw){ const d=digitsOnly(raw); return d? (d.length<=10? d.padStart(10,'0'): d.slice(-10)) : ''; }
  function currentAction(){ return btnIn.classList.contains('active') ? 'in' : 'out'; }
  function focusPin(){ try{ pinEl.focus(); pinEl.select?.(); }catch{} }
  function setAction(a){ const IN=a==='in'; btnIn.classList.toggle('active',IN); btnOut.classList.toggle('active',!IN); setTimeout(focusPin,0); }
  btnIn.addEventListener('click',()=>setAction('in'));
  btnOut.addEventListener('click',()=>setAction('out'));
  window.addEventListener('keydown',(e)=>{ if(e.key==='ArrowLeft') setAction('in'); if(e.key==='ArrowRight') setAction('out'); });

  function updateNet(){ const on=navigator.onLine; netBadge.textContent=on?'Online':'Offline'; netBadge.style.background=on?'var(--card)':'#fee2e2'; netBadge.style.color=on?'var(--text)':'#991b1b'; }
  window.addEventListener('online',updateNet); window.addEventListener('offline',updateNet); updateNet();

  /* Warm backend (build caches, avoid cold start) */
  (async function warm(){
    try { await fetch(`${ENDPOINT}?selftest=1`, { cache:'no-store' }); } catch(_) {}
  })();

  /* Fetch with 7s timeout + one retry */
  async function fetchFast(url, opt={}, timeoutMs=7000, retryOnce=true){
    const doFetch = () => {
      const ctrl = new AbortController();
      const timer = setTimeout(()=>ctrl.abort(), timeoutMs);
      return fetch(url, { ...opt, signal: ctrl.signal }).finally(()=>clearTimeout(timer));
    };
    try { return await doFetch(); }
    catch (e) {
      if (retryOnce) { await new Promise(r=>setTimeout(r,150)); return fetchFast(url,opt,timeoutMs,false); }
      throw e;
    }
  }

  /* Submit (optimistic) */
  let lastSubmitAt = 0;
  const DEDUPE_WINDOW_MS = 5000;
  const lastSeen = new Map();
  function canSendNow(key){ const now=Date.now(); const last=lastSeen.get(key)||0; if (now-last<DEDUPE_WINDOW_MS) return false; lastSeen.set(key,now); return true; }
  const makeKey = ({pin,personId}) => pin ? `pin:${pin}` : `pid:${personId}`;

  async function submitPinOrId({ pin, personId }){
    const act = currentAction();
    const key = makeKey({ pin, personId });
    if (!canSendNow(key)) { showToast('Duplicate scan ignored (5s)'); return; }

    showToast(`Signing ${act.toUpperCase()}â€¦`);
    try{
      const body = new URLSearchParams({ action: act, ...(pin?{pin}:{personId}) }).toString();
      const res = await fetchFast(ENDPOINT, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body });
      const txt = await res.text(); let data=null; try{ data = JSON.parse(txt); }catch{}

      // Student handoff
      if (data && data.status === 'student_in' && data.legacyId) {
        const label = data.student || 'Student';
        window.open(`${VC_BASE}${encodeURIComponent(String(data.legacyId))}`, '_blank', 'width=480,height=820,noopener,noreferrer');
        showToast(`${label} â€” sent to Veracross`, 'ok'); chimeOK(); return;
      }

      if (!res.ok || (data && data.error)) { showToast(data && data.error ? data.error : ('Error ' + res.status), 'fail'); chimeFAIL(); return; }

      const { status, firstName, lastName, time } = data || {};
      const verb = (status === 'in') ? 'IN' : (status === 'out') ? 'OUT' : (status||'').toUpperCase();
      showToast(`${firstName||''} ${lastName||''} â€” ${verb} @ ${time||''}`, 'ok'); chimeOK();
    } catch {
      showToast('Network/timeout', 'fail'); chimeFAIL();
    } finally {
      lastSubmitAt = Date.now();
      pinEl.value=''; focusPin();
    }
  }

  /* Ultra-fast wedge */
  let wedgeTimer=null;
  const WEDGE_QUIET_MS = 45;
  pinEl.addEventListener('input', ()=>{
    clearTimeout(wedgeTimer);
    wedgeTimer = setTimeout(()=>{
      const ten = pin10(pinEl.value);
      if (ten.length < 10) return;
      if (Date.now() - lastSubmitAt < 120) return;
      submitPinOrId({ pin: ten });
    }, WEDGE_QUIET_MS);
  });
  pinEl.addEventListener('keydown',(e)=>{ if (e.key === 'Enter') { e.preventDefault(); e.stopPropagation(); } });

  /* Search (faculty first, then students) */
  let searchTimer=null, searchAbort=null, searchToken=0;
  function sectionHeader(text){ const row=document.createElement('div'); row.className='row'; const tag=document.createElement('span'); tag.className='sectionTag'; tag.textContent=text; row.appendChild(tag); row.appendChild(document.createElement('div')); return row; }
  function resultRow(label, btnText, onClick){ const row=document.createElement('div'); row.className='row'; const name=document.createElement('div'); name.className='name'; name.textContent=label; const btn=document.createElement('button'); btn.className='actionBtn'; btn.textContent=btnText; btn.addEventListener('click', onClick); row.appendChild(name); row.appendChild(btn); return row; }

  qEl.addEventListener('input', ()=>{
    clearTimeout(searchTimer);
    const q = qEl.value.trim();
    const box = $('#results');
    if (!q) { try{searchAbort?.abort();}catch{} searchAbort=null; searchToken++; box.innerHTML=''; return; }
    searchTimer = setTimeout(()=>doSearch(q), 100);
  });
  qEl.addEventListener('keydown',(e)=>{
    if (e.key === 'Enter') { e.preventDefault(); const q=qEl.value.trim(); if (!q) { try{searchAbort?.abort();}catch{} searchAbort=null; searchToken++; $('#results').innerHTML=''; return; } doSearch(q); }
  });

  async function doSearch(q){
    try{ searchAbort?.abort(); }catch{}; searchAbort = new AbortController();
    const myToken = ++searchToken; const sig=searchAbort.signal; const box=$('#results'); box.innerHTML='<div class="muted">Searchingâ€¦</div>';
    try{
      const facP = fetchFast(`${ENDPOINT}?action=search&q=${encodeURIComponent(q)}`, {}, 7000).then(r=>r.json()).catch(()=>[]);
      const stuP = fetchFast(`${ENDPOINT}?action=studentSearch&q=${encodeURIComponent(q)}`, {}, 7000).then(r=>r.json()).catch(()=>[]);
      let [fac,stu] = await Promise.all([facP,stuP]);
      if (myToken !== searchToken || !qEl.value.trim()) return;

      const frag = document.createDocumentFragment();
      if (Array.isArray(fac) && fac.length) {
        frag.appendChild(sectionHeader('FACULTY'));
        fac.slice(0,30).forEach(({ firstName, lastName, personId })=>{
          frag.appendChild(resultRow(`${firstName} ${lastName}`, 'Submit', ()=> submitPinOrId({ personId })));
        });
      }
      if (Array.isArray(stu) && stu.length) {
        frag.appendChild(sectionHeader('STUDENTS'));
        stu.slice(0,30).forEach(({ fullName, legacyId })=>{
          frag.appendChild(resultRow(fullName, 'Sign IN', ()=>{
            window.open(`${VC_BASE}${encodeURIComponent(String(legacyId))}`, '_blank', 'width=480,height=820,noopener,noreferrer');
            showToast(`${fullName} â€” sent to Veracross`, 'ok'); chimeOK();
          }));
        });
      }
      box.innerHTML = '';
      if (!frag.children.length) box.innerHTML = '<div class="muted">No matches found.</div>'; else box.appendChild(frag);
    } catch (e) {
      if (e && e.name === 'AbortError') return;
      if (myToken === searchToken) $('#results').innerHTML = '<div class="muted">Search failed.</div>';
    }
  }

  /* Init */
  document.addEventListener('DOMContentLoaded', ()=>{
    setAction('in');
    showToast('Ready â€” scan card or search');
    focusPin();
  });
</script>
</body>
</html>
