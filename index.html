<!doctype html>
<html lang="en">
>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
<title>Attendance â€” Guard Console</title>
<meta id="meta-theme" name="theme-color" content="#ffffff">
<style>
:root{
  --bg:#f6f7fb;--card:#fff;--text:#0f172a;--muted:#667085;--border:#e5e7eb;
  --in:#16a34a;--out:#dc2626;--blue:#2563eb;--ring:0 0 0 6px rgba(59,130,246,.16)
}
body.dark{--bg:#0b1020;--card:#111827;--text:#f3f4f6;--muted:#cbd5e1;--border:#374151}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
.wrap{margin:auto;width:min(1100px,96%);background:var(--card);border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.08);
min-height:100svh;padding:28px;position:relative}
h1{margin:0 0 8px;font-weight:800;font-size:28px}
.muted{color:var(--muted)}
.badges{position:absolute;right:18px;top:18px;display:flex;gap:8px}
.badge{font-size:12px;font-weight:800;padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:var(--card)}
.gear{border:1px solid var(--border);background:var(--card);border-radius:10px;padding:6px 10px;cursor:pointer;font-weight:800}
.toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%) translateY(20px);opacity:0;background:var(--card);
border:1px solid var(--border);border-radius:14px;padding:16px 20px;font-weight:800;transition:all .25s ease;pointer-events:none;
font-size:18px;z-index:50}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
.segment{display:flex;gap:14px;width:100%;margin:20px 0}
.segment.segment-xl button{flex:1 1 0;border:2px solid #d1d5db;border-radius:16px;font-weight:900;font-size:42px;min-height:96px;
padding:22px 24px;cursor:pointer;color:#111;background:linear-gradient(180deg,#f8fafc 0%,#eef2f7 100%)}
.segment.segment-xl button.active#actIn{background:linear-gradient(180deg,#16a34a 0%,#15803d 100%);color:#fff;border-color:#16a34a}
.segment.segment-xl button.active#actOut{background:linear-gradient(180deg,#dc2626 0%,#991b1b 100%);color:#fff;border-color:#dc2626}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:18px}
.card{border:1px solid var(--border);border-radius:14px;background:var(--card);padding:16px;display:flex;flex-direction:column}
.card h2{margin:0 0 12px;font-size:20px}
input[type=text],input[type=password],input[type=search]{width:100%;padding:18px 20px;font-size:24px;border:1.5px solid var(--border);
border-radius:12px;background:var(--card);color:var(--text);outline:none;transition:border-color .2s ease,box-shadow .2s ease}
input:focus-visible{border-color:#3b82f6;box-shadow:var(--ring)}
.list{display:grid;gap:12px;max-height:460px;overflow:auto;margin-top:14px;background:var(--card);padding-right:16px}
.row{display:grid;grid-template-columns:minmax(0,1fr) auto;align-items:center;gap:12px;padding:14px 16px;border:1px solid var(--border);
border-radius:12px;background:var(--card)}
.name{font-weight:800;font-size:20px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.sectionTitle{font-size:13px;font-weight:900;color:var(--muted);text-transform:uppercase;letter-spacing:.08em;margin:4px 2px}
.actionBtn{--c:#2563eb;background:linear-gradient(180deg,var(--c) 0%,#1e4fb9 100%);color:#fff;font-size:20px;padding:16px 20px;
border:2px solid var(--c);border-radius:14px;font-weight:900;cursor:pointer}
@media(max-width:900px){.grid{grid-template-columns:1fr}.segment.segment-xl button{font-size:36px;min-height:88px}}
</style>
</head>
<body>
<div class="wrap">
  <div class="badges">
    <div id="netBadge" class="badge">Online</div>
    <button id="themeBtn" class="gear" aria-label="Toggle dark mode">ðŸŒ™ Dark</button>
  </div>
  <h1>Attendance â€” Guard Console</h1>
  <p class="muted">Select <b>IN</b> or <b>OUT</b>, then tap/swipe a card or search by name.</p>

  <div class="segment segment-xl">
    <button id="actIn" class="active" type="button">IN</button>
    <button id="actOut" type="button">OUT</button>
  </div>

  <div class="grid">
    <div class="card">
      <h2>Cougar Card / Quick Pin</h2>
      <input id="pin" type="password" inputmode="numeric" placeholder="Swipe or tap card" />
    </div>
    <div class="card">
      <h2>Lookup by Name</h2>
      <input id="q" type="search" placeholder="Search faculty or students" />
      <div id="results" class="list"></div>
    </div>
  </div>

  <div id="toast" class="toast"></div>
</div>

<script>
const ENDPOINT='https://script.google.com/macros/s/AKfycbzF4Hy0W2ZBbB6dOPRcT3PIKsEZekW2HtHuPAAp99jwUpasH7Iq1mMYCtQ35WEPfkiQQw/exec';   // ðŸ‘ˆ replace with your Script URL
const COOLDOWN_MS=400; const THEME_KEY='theme';
const $=s=>document.querySelector(s); const pinEl=$('#pin'),qEl=$('#q'),toastEl=$('#toast'),
btnIn=$('#actIn'),btnOut=$('#actOut'),netBadge=$('#netBadge');

function setTheme(mode){
  const dark=mode==='dark';
  document.body.classList.toggle('dark',dark);
  const btn=$('#themeBtn');
  btn.textContent=dark?'â˜€ï¸ Light':'ðŸŒ™ Dark';
  btn.setAttribute('aria-label',dark?'Switch to light mode':'Switch to dark mode');
  $('#meta-theme').content=dark?'#0b1020':'#ffffff';
  localStorage.setItem(THEME_KEY,dark?'dark':'light');
}
function initTheme(){
  const saved=localStorage.getItem(THEME_KEY);
  setTheme(saved|| (window.matchMedia?.('(prefers-color-scheme: dark)').matches?'dark':'light'));
}
$('#themeBtn').onclick=()=>setTheme(document.body.classList.contains('dark')?'light':'dark');

let toastTimer=null;
function showToast(t,tone='neutral'){
  toastEl.textContent=t;toastEl.classList.add('show');
  toastEl.style.background='var(--card)';toastEl.style.color='var(--text)';
  if(tone==='ok'){toastEl.style.background='#ecfdf5';toastEl.style.color='#065f46';}
  if(tone==='err'){toastEl.style.background='#fee2e2';toastEl.style.color='#b91c1c';}
  clearTimeout(toastTimer);toastTimer=setTimeout(()=>toastEl.classList.remove('show'),2000);
}

function updateNet(){const on=navigator.onLine;
 netBadge.textContent=on?'Online':'Offline';
 netBadge.style.background=on?'var(--card)':'#fee2e2';
 netBadge.style.color=on?'var(--text)':'#991b1b';}
window.addEventListener('online',updateNet);
window.addEventListener('offline',updateNet);updateNet();

function focusPin(){try{pinEl.focus();pinEl.select?.();}catch{}}
function setAction(a){const inA=a==='in';btnIn.classList.toggle('active',inA);btnOut.classList.toggle('active',!inA);setTimeout(focusPin,0);}
btnIn.onclick=()=>setAction('in');btnOut.onclick=()=>setAction('out');

const digitsOnly=s=>String(s||'').replace(/\D+/g,'');
const pad10=d=>d.length<=10?d.padStart(10,'0'):d.slice(-10);
const lfToFl=s=>{const m=String(s||'').match(/^\s*([^,]+)\s*,\s*(.+)\s*$/);return m?`${m[2]} ${m[1]}`.trim():String(s||'');};

async function postFaculty({pin,personId}){
 const act=btnIn.classList.contains('active')?'in':'out';
 const body=new URLSearchParams({action:act,...(pin?{pin}:{personId})});
 const r=await fetch(ENDPOINT,{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body});
 const t=await r.text();let d=null;try{d=JSON.parse(t);}catch{};return{ok:r.ok&&d&&!d.error,data:d};
}
async function getStudentByLegacy(id){const r=await fetch(`${ENDPOINT}?action=studentByLegacy&id=${id}`);try{return await r.json();}catch{return{found:false};}}
async function serverStudentSign(legacy){
 const body=new URLSearchParams({action:'student_sign',legacy});
 const r=await fetch(ENDPOINT,{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body});
 const t=await r.text();let d=null;try{d=JSON.parse(t);}catch{};return{ok:r.ok&&d&&!d.error,data:d};
}

async function submitPinOrId({pin,personId}){
 const f=await postFaculty({pin,personId});
 if(f.ok){
   const d=f.data;
   if(d.status==='in'||d.status==='out'){const v=d.status==='in'?'IN':'OUT';showToast(`${d.firstName||''} ${d.lastName||''} â€” ${v} ${d.time||''}`,'ok');return;}
   if(d.status==='student_in'&&d.legacyId){
     if(!btnIn.classList.contains('active'))return showToast('Students can only sign IN','err');
     const s=await serverStudentSign(d.legacyId);
     showToast(`${(s.data&&s.data.student)||d.student||('Student '+d.legacyId)} â€” sent to Veracross`,s.ok?'ok':'err');
     return;
   }
 }
 const msg=f.data&&f.data.error;
 if(pin&&/not\s*found|missing|invalid/i.test(msg||'')){
   const s=await getStudentByLegacy(pin);
   if(s.found){
     if(!btnIn.classList.contains('active'))return showToast('Students can only sign IN','err');
     const r=await serverStudentSign(s.legacyId);
     showToast(`${lfToFl(s.fullName||'')} â€” sent to Veracross`,r.ok?'ok':'err');return;
   }
 }
 showToast(msg||'Error','err');
}

let wedgeTimer=null;const WEDGE_QUIET_MS=120;
pinEl.addEventListener('input',()=>{
 clearTimeout(wedgeTimer);
 wedgeTimer=setTimeout(async()=>{
   const d=digitsOnly(pinEl.value);if(!d)return;
   if(d.length<10){pinEl.value='';return;}
   await submitPinOrId({pin:pad10(d)});pinEl.value='';focusPin();
 },WEDGE_QUIET_MS);
});

document.addEventListener('DOMContentLoaded',()=>{initTheme();setAction('in');focusPin();});
</script>
</body>
</html>
