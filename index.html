<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
<title>Teacher Attendance â€” Guard Console</title>
<meta name="description" content="Guard console for IN/OUT with Cougar Card swipe/tap or name lookup." />
<meta name="color-scheme" content="light dark">
<meta id="meta-theme" name="theme-color" content="#ffffff">
<style>
  :root{
    --bg:#f6f7fb; --card:#ffffff; --text:#0f172a; --muted:#667085; --border:#e5e7eb;
    --in:#16a34a; --out:#dc2626; --blue:#2563eb;
    --radius-lg:14px; --radius-xl:18px;
    --shadow-1:0 10px 30px rgba(0,0,0,.08);
    --ring:0 0 0 6px rgba(59,130,246,.16);
  }
  body.dark{ --bg:#0b1020; --card:#111827; --text:#f3f4f6; --muted:#cbd5e1; --border:#374151; }
  *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
  html, body { height:100%; margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
  html { overflow-x:hidden; }
  body{ min-height:100svh; overscroll-behavior-y:contain; overflow:auto; -webkit-overflow-scrolling:touch; }

  .wrap{
    margin:auto; width:min(1100px,96%); background:var(--card);
    border-radius:var(--radius-xl); box-shadow:var(--shadow-1); position:relative;
    min-height:100svh; padding:28px; overflow:visible; overflow-x:clip;
  }

  /* Header centered */
  .header{
    text-align:center;
    margin-bottom:8px;
  }
  h1{ margin:0 0 6px; font-weight:900; font-size:30px; letter-spacing:.2px; }
  .muted{ color:var(--muted); }

  /* Badges + Theme */
  .badges{ position:absolute; right:18px; top:18px; display:flex; gap:8px; align-items:center; }
  .badge{ font-size:12px; font-weight:800; padding:6px 10px; border-radius:999px; border:1px solid var(--border); background:var(--card); color:var(--text); }
  .gear{ border:1px solid var(--border); background:var(--card); color:var(--text); border-radius:10px; padding:6px 10px; cursor:pointer; font-weight:800; }
  .gear:focus-visible{ outline:none; box-shadow:var(--ring); }

  /* Segment buttons */
  .segment{ display:flex; gap:14px; width:100%; margin:20px 0; }
  .segment.segment-xl button{
    flex:1 1 0; border:2px solid #d1d5db; border-radius:16px;
    font-weight:900; font-size:42px; line-height:1.1; min-height:96px;
    padding:22px 24px; cursor:pointer; color:#111;
    background:linear-gradient(180deg, #f8fafc 0%, #eef2f7 100%);
    transition:transform .06s ease, box-shadow .2s ease, background .2s ease;
    box-shadow:0 4px 10px rgba(0,0,0,.05);
  }
  .segment.segment-xl button.active#actIn{
    background:linear-gradient(180deg, #16a34a 0%, #15803d 100%); color:#fff; border-color:#16a34a;
    box-shadow:0 0 0 4px rgba(22,163,74,.25);
  }
  .segment.segment-xl button.active#actOut{
    background:linear-gradient(180deg, #dc2626 0%, #991b1b 100%); color:#fff; border-color:#dc2626;
    box-shadow:0 0 0 4px rgba(220,38,38,.25);
  }

  /* Grid & cards */
  .grid{ display:grid; grid-template-columns:1fr 1fr; gap:18px; align-items:stretch; }
  .card{ border:1px solid var(--border); border-radius:14px; background:var(--card); padding:16px; display:flex; flex-direction:column; height:100%; overflow:hidden; background-clip: padding-box; }
  .card h2{ margin:0 0 12px; font-size:20px; }

  /* Inputs */
  input[type=text], input[type=password], input[type=search]{
    width:100%; padding:18px 20px; font-size:24px; border:1.5px solid var(--border); border-radius:12px; background:var(--card); color:var(--text);
  }
  input[type=text]:focus-visible, input[type=password]:focus-visible, input[type=search]:focus-visible{ border-color:#3b82f6; box-shadow:var(--ring); outline:none; }

  /* Results list */
  .list{ display:grid; gap:12px; max-height:460px; overflow:auto; margin-top:14px; background: var(--card); background-clip: padding-box; -webkit-overflow-scrolling: touch; overscroll-behavior: contain; flex:1 1 auto; padding-right:16px; scrollbar-gutter: stable both-edges; }
  .row{ display:grid; grid-template-columns:minmax(0,1fr) auto; align-items:center; gap:12px; padding:14px 16px; border:1px solid var(--border); border-radius:12px; background: var(--card); }
  .name{ min-width:0; font-weight:800; font-size:20px; color:var(--text); overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
  .sectionTitle{ font-weight:900; letter-spacing:.5px; text-transform:uppercase; opacity:.9; }

  /* Buttons */
  .actionBtn{ --c: var(--blue); background:linear-gradient(180deg, var(--c) 0%, color-mix(in srgb, var(--c) 80%, #000 20%) 100%); color:#fff; font-size:20px; padding:16px 20px; border:2px solid var(--c); border-radius:14px; font-weight:900; cursor:pointer; box-shadow:0 6px 14px rgba(0,0,0,.12); justify-self:end; }

  /* NFC bar (only if supported) */
  .nfcBar{ display:flex; align-items:center; gap:12px; flex-wrap:wrap; margin-top:10px; }
  .nfcBtn{ padding:14px 18px; border-radius:12px; border:2px solid #4f46e5; color:#fff; background:#4f46e5; font-weight:800; cursor:pointer; font-size:18px; }
  .nfcBtn.secondary{ background:transparent; color:#4f46e5; }

  /* Toast centered + bold */
  .toast{
    position:fixed; left:50%; bottom:24px; transform:translateX(-50%) translateY(20px);
    opacity:0; background:var(--card); border:1px solid var(--border);
    box-shadow:0 10px 40px rgba(0,0,0,.20);
    border-radius:16px; padding:18px 22px; font-weight:900; font-size:22px; text-align:center;
    transition:all .20s ease; pointer-events:none; z-index:50; min-width:min(560px,92%);
  }
  .toast.show{ opacity:1; transform:translateX(-50%) translateY(0); }
  .toast.good{ color:#065f46; border-color:#a7f3d0; background: #ecfdf5; }
  .toast.bad{  color:#991b1b; border-color:#fecaca; background: #fff1f2; }

  @media (max-width:900px){
    .grid{ grid-template-columns:1fr; }
    .segment.segment-xl button{ font-size:36px; min-height:88px; }
    .toast{ min-width: unset; width: calc(100% - 24px); }
  }
</style>
</head>
<body>
  <div class="wrap" role="application" aria-label="Teacher Attendance Guard Console">

    <div class="badges" aria-live="polite" aria-atomic="true">
      <div id="netBadge" class="badge">Online</div>
      <button id="themeBtn" class="gear" title="Toggle theme" aria-label="Toggle dark mode">ðŸŒ™ Dark</button>
    </div>

    <div class="header">
      <h1>Teacher Attendance â€” Guard Console</h1>
      <p class="muted">Choose <b>IN</b> or <b>OUT</b>, then swipe/tap a card or search by name.<br>Faculty are shown first; students can only sign <b>IN</b>.</p>
    </div>

    <div class="segment segment-xl" role="tablist" aria-label="Action">
      <button id="actIn" class="active" role="tab" aria-selected="true" type="button" aria-label="Set action to IN">IN</button>
      <button id="actOut" role="tab" aria-selected="false" type="button" aria-label="Set action to OUT">OUT</button>
    </div>

    <div class="grid">
      <!-- LEFT: Card -->
      <div class="card">
        <h2>Cougar Card (Quick Pin / Legacy ID)</h2>
        <input id="pin" type="password" maxlength="32" inputmode="numeric" autocomplete="one-time-code"
               placeholder="Tap or swipe cardâ€¦" aria-label="Cougar Card" />
        <div id="nfcBar" class="nfcBar" style="display:none;">
          <button id="nfcStart" class="nfcBtn">Scan with NFC</button>
          <button id="nfcStop"  class="nfcBtn secondary">Stop</button>
        </div>
        <div style="margin-top:auto;"></div>
      </div>

      <!-- RIGHT: Lookup -->
      <div class="card">
        <h2>Lookup by Name</h2>
        <input id="q" type="search" inputmode="search" enterkeyhint="search"
               autocapitalize="words" autocorrect="off" spellcheck="false"
               placeholder="Search faculty or students" aria-label="Search name" />
        <div id="results" class="list" role="list" aria-live="polite"></div>
      </div>
    </div>

    <div id="toast" class="toast" role="status" aria-live="polite">Ready.</div>
  </div>

<script>
  /* ===== Config ===== */
  const ENDPOINT = 'https://script.google.com/macros/s/AKfycbzF4Hy0W2ZBbB6dOPRcT3PIKsEZekW2HtHuPAAp99jwUpasH7Iq1mMYCtQ35WEPfkiQQw/exec';
  const VC_BASE  = 'https://checkin.veracross.com/frisch/kiosk/entrance?legacy=';

  // de-dupe window: 5s (block repeat scans)
  const DEDUPE_WINDOW_MS = 5000;
  const lastSeenMap = new Map(); // key -> time
  const makeKey = ({pin, personId}) => pin ? `pin:${pin}` : `pid:${personId}`;
  function canSendNow(key){
    const now=Date.now(); const last=lastSeenMap.get(key)||0;
    if (now - last < DEDUPE_WINDOW_MS) return false;
    lastSeenMap.set(key, now); return true;
  }

  /* ===== DOM ===== */
  const $ = s => document.querySelector(s);
  const pinEl = $('#pin'), qEl = $('#q'), resultsEl = $('#results'), toastEl = $('#toast');
  const btnIn = $('#actIn'), btnOut = $('#actOut');
  const themeBtn = $('#themeBtn'), metaTheme = $('#meta-theme');
  const netBadge = $('#netBadge');

  /* ===== Theme ===== */
  function setTheme(mode){
    const dark = mode === 'dark';
    document.body.classList.toggle('dark', dark);
    themeBtn.textContent = dark ? 'â˜€ï¸ Light' : 'ðŸŒ™ Dark';
    if (metaTheme) metaTheme.content = dark ? '#0b1020' : '#ffffff';
    localStorage.setItem('theme', dark ? 'dark' : 'light');
  }
  function initTheme(){
    const saved = localStorage.getItem('theme');
    if (saved) { setTheme(saved); return; }
    const prefersDark = window.matchMedia?.('(prefers-color-scheme: dark)').matches;
    setTheme(prefersDark ? 'dark' : 'light');
  }
  themeBtn.addEventListener('click', () => setTheme(document.body.classList.contains('dark') ? 'light' : 'dark'));

  /* ===== Toast (centered + quick feedback) ===== */
  let toastTimer=null;
  function showToast(text, kind=''){
    toastEl.textContent = text;
    toastEl.classList.remove('good','bad');
    if (kind==='good') toastEl.classList.add('good');
    if (kind==='bad')  toastEl.classList.add('bad');
    toastEl.classList.add('show');
    clearTimeout(toastTimer);
    toastTimer = setTimeout(()=>toastEl.classList.remove('show'), 2200);
  }

  /* ===== Loud, distinctive chimes (only on submissions, never while typing) ===== */
  let audioCtx=null, master=null, comp=null, dist=null, audioReady=false;
  function initAudio(){
    if (audioReady) return;
    audioReady=true;
    const AC = window.AudioContext || window.webkitAudioContext;
    audioCtx = new AC();
    comp = audioCtx.createDynamicsCompressor();
    comp.threshold.setValueAtTime(-14, audioCtx.currentTime);
    comp.knee.setValueAtTime(20, audioCtx.currentTime);
    comp.ratio.setValueAtTime(12, audioCtx.currentTime);
    comp.attack.setValueAtTime(0.003, audioCtx.currentTime);
    comp.release.setValueAtTime(0.08, audioCtx.currentTime);
    dist = audioCtx.createWaveShaper();
    dist.curve = (function makeCurve(amount=60){ const n=44100,c=new Float32Array(n),deg=Math.PI/180; for(let i=0;i<n;i++){ const x=(i*2)/n-1; c[i]=(3+amount)*x*20*deg/(Math.PI+amount*Math.abs(x)); } return c; })();
    dist.oversample='4x';
    master = audioCtx.createGain(); master.gain.setValueAtTime(0.95, audioCtx.currentTime);
    master.connect(comp).connect(audioCtx.destination);
    const kick = ()=> audioCtx.resume?.().catch(()=>{});
    window.addEventListener('pointerdown', kick, { once:true });
    window.addEventListener('keydown', kick, { once:true });
  }
  function tone({ f=880, d=0.18, t=audioCtx.currentTime, type='sine', g=0.5, toDist=false, detune=0 }){
    const o = audioCtx.createOscillator(), gn = audioCtx.createGain();
    o.type=type; o.frequency.setValueAtTime(f,t); if(detune) o.detune.setValueAtTime(detune,t);
    gn.gain.setValueAtTime(0,t); gn.gain.linearRampToValueAtTime(g, t+0.012); gn.gain.exponentialRampToValueAtTime(0.0001, t+d);
    (toDist ? o.connect(gn).connect(dist).connect(master) : o.connect(gn).connect(master));
    o.start(t); o.stop(t+d+0.02);
  }
  function chimeOk(){
    initAudio();
    const t0 = audioCtx.currentTime + 0.01;
    tone({ f:659.25, d:0.14, t:t0,      g:0.95 });
    tone({ f:830.61, d:0.14, t:t0+0.12, g:0.95 });
    tone({ f:987.77, d:0.16, t:t0+0.24, g:0.95 });
    tone({ f:1318.5, d:0.20, t:t0+0.36, g:1.00 });
  }
  function chimeFail(){
    initAudio();
    const t0 = audioCtx.currentTime + 0.01;
    tone({ f:440.00, d:0.16, t:t0,      type:'square', g:0.95, toDist:true });
    tone({ f:369.99, d:0.16, t:t0+0.12, type:'square', g:0.90, toDist:true });
    tone({ f:293.66, d:0.20, t:t0+0.24, type:'square', g:0.85, toDist:true });
  }

  /* ===== Online badge ===== */
  function updateNet(){
    const on = navigator.onLine;
    netBadge.textContent = on ? 'Online' : 'Offline';
    netBadge.style.background = on ? 'var(--card)' : '#fee2e2';
    netBadge.style.color = on ? 'var(--text)' : '#991b1b';
  }
  window.addEventListener('online', updateNet);
  window.addEventListener('offline', updateNet);
  updateNet();

  /* ===== Focus helpers ===== */
  function focusPin(){ try{ pinEl.focus(); pinEl.select?.(); }catch{} }
  function focusPinSafely(){ if (document.activeElement !== qEl) focusPin(); }
  document.addEventListener('visibilitychange', () => { if (!document.hidden) focusPinSafely(); });
  window.addEventListener('pageshow', (e) => { if (e.persisted) focusPinSafely(); });

  /* ===== Action toggle ===== */
  function setAction(a){
    const inActive = a === 'in';
    btnIn.classList.toggle('active', inActive);
    btnOut.classList.toggle('active', !inActive);
    setTimeout(focusPinSafely, 0);
  }
  btnIn.addEventListener('click', () => setAction('in'));
  btnOut.addEventListener('click', () => setAction('out'));
  window.addEventListener('keydown', (e)=>{ if(e.key==='ArrowLeft') setAction('in'); if(e.key==='ArrowRight') setAction('out'); });

  /* ===== Helper utils ===== */
  const digitsOnly = s => String(s||'').replace(/\D+/g,'');
  function normalizeTen(raw){
    const d = digitsOnly(raw); if (!d) return '';
    return d.length <= 10 ? d.padStart(10,'0') : d.slice(-10);
  }
  const isInSelected = () => btnIn.classList.contains('active');

  /* ===== Submit API (Faculty) & Student handoff ===== */
  async function submitPinOrId({ pin, personId }) {
    const action = isInSelected() ? 'in' : 'out';
    const key = makeKey({ pin, personId });

    // de-dupe 5s
    if (!canSendNow(key)) {
      showToast('Duplicate scan ignored (5s)', 'bad');
      return;
    }

    // Show immediate visual feedback while awaiting server
    showToast('Submittingâ€¦');

    const body = new URLSearchParams({ action, ...(pin?{pin}:{personId}) }).toString();
    try{
      const res = await fetch(ENDPOINT, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body });
      const data = await res.json().catch(()=>null);

      if (!res.ok || !data) {
        showToast('Network error', 'bad'); chimeFail(); return;
      }
      if (data.error) {
        showToast(data.error, 'bad'); chimeFail(); return;
      }

      // Student IN path
      if (data.status === 'student_in' && data.legacyId) {
        const name = data.student || 'Student';
        const url  = VC_BASE + encodeURIComponent(data.legacyId);
        // open kiosk in a new tab (GitHub Pages canâ€™t script the other origin)
        window.open(url, '_blank', 'width=480,height=820,noopener,noreferrer');
        showToast(`${name} â€” sent to Veracross`, 'good'); chimeOk();
        return;
      }

      // Faculty success
      const verb = data.status==='in' ? 'IN' : 'OUT';
      const line = `${(data.firstName||'') + ' ' + (data.lastName||'')}`.trim() + ` signed ${verb} â€” ${data.time||''}`;
      showToast(line, 'good'); chimeOk();
    } catch {
      showToast('Network error', 'bad'); chimeFail();
    } finally {
      focusPinSafely();
    }
  }

  /* ===== USB/Wedge auto-submit (quiet-timer) ===== */
  let wedgeTimer=null; const WEDGE_QUIET_MS=120;
  pinEl.addEventListener('input', ()=>{
    clearTimeout(wedgeTimer);
    wedgeTimer = setTimeout(()=>{
      const nowDigits = digitsOnly(pinEl.value);
      if (nowDigits.length < 10) return;
      const ten = nowDigits.slice(-10);
      submitPinOrId({ pin: ten });
      pinEl.value = '';
      focusPinSafely();
    }, WEDGE_QUIET_MS);
  });
  pinEl.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ e.preventDefault(); e.stopPropagation(); }});

  /* ===== Search: FACULTY first, then STUDENTS (clears immediately on empty) ===== */
  let searchTimer=null, searchToken=0, searchAbort=null;
  function sectionHeader(text){
    const row=document.createElement('div'); row.className='row';
    const name=document.createElement('div'); name.className='name sectionTitle'; name.textContent=text;
    const spacer=document.createElement('div'); row.appendChild(name); row.appendChild(spacer); return row;
  }
  function addRow(label, btnText, onClick){
    const row=document.createElement('div'); row.className='row';
    const name=document.createElement('div'); name.className='name'; name.textContent=label;
    const btn=document.createElement('button'); btn.className='actionBtn'; btn.textContent=btnText;
    btn.addEventListener('click', onClick);
    row.appendChild(name); row.appendChild(btn); return row;
  }

  qEl.addEventListener('input', ()=>{
    clearTimeout(searchTimer);
    const q=qEl.value.trim();
    if(!q){
      try{ searchAbort?.abort(); }catch{}
      searchAbort=null; searchToken++; resultsEl.innerHTML=''; return;
    }
    searchTimer=setTimeout(()=>doSearch(q), 140);
  });
  qEl.addEventListener('keydown', (e)=>{
    if(e.key==='Enter'){
      e.preventDefault();
      clearTimeout(searchTimer);
      const q=qEl.value.trim();
      if(!q){ try{searchAbort?.abort();}catch{}; searchAbort=null; searchToken++; resultsEl.innerHTML=''; return; }
      doSearch(q);
    }
  });

  function norm(s){ return String(s||'').toLowerCase().normalize('NFKD').replace(/[\u0300-\u036f]/g,''); }
  function flipLF(full){ const m=String(full||'').match(/^\s*([^,]+)\s*,\s*(.+)\s*$/); return m ? (m[2].trim()+' '+m[1].trim()) : String(full||'').trim(); }

  async function doSearch(q){
    try{ searchAbort?.abort(); }catch{}
    const controller = new AbortController(); searchAbort=controller;
    const myToken = ++searchToken;

    resultsEl.innerHTML='<div class="muted">Searchingâ€¦</div>';

    try{
      const facP = fetch(`${ENDPOINT}?action=search&q=${encodeURIComponent(q)}`, {signal:controller.signal}).then(r=>r.json());
      const stuP = fetch(`${ENDPOINT}?action=studentSearch&q=${encodeURIComponent(q)}`, {signal:controller.signal}).then(r=>r.json());
      let [facRes,stuRes] = await Promise.allSettled([facP,stuP]);

      if (myToken !== searchToken || !qEl.value.trim()) return;

      facRes = facRes.status==='fulfilled' && Array.isArray(facRes.value) ? facRes.value : [];
      stuRes = stuRes.status==='fulfilled' && Array.isArray(stuRes.value) ? stuRes.value : [];

      // de-dupe + simple score (client)
      const facMap=new Map();
      facRes.forEach(r=>{
        const k=String(r.personId||''); if(!k) return;
        const s=norm(`${r.firstName||''} ${r.lastName||''}`); // rough score by start match
        const score = s.startsWith(norm(q)) ? 100 : 10;
        const cur=facMap.get(k);
        if(!cur || score>cur._score) facMap.set(k, {...r, _score:score});
      });
      const facSorted = Array.from(facMap.values()).sort((a,b)=>b._score-a._score).slice(0,40);

      const stuMap=new Map();
      stuRes.forEach(r=>{
        const legacy=String(r.legacyId||''); if(!legacy) return;
        const full = String(r.fullName||''); const flip=flipLF(full);
        const sName = norm(flip).startsWith(norm(q)) || norm(full).startsWith(norm(q)) ? 100 : 10;
        const cur=stuMap.get(legacy);
        if(!cur || sName>cur._score) stuMap.set(legacy, {...r, label:flip || full, _score:sName});
      });
      const stuSorted = Array.from(stuMap.values()).sort((a,b)=>b._score-a._score).slice(0,40);

      if (myToken !== searchToken || !qEl.value.trim()) return;

      const frag=document.createDocumentFragment();
      if (facSorted.length){
        frag.appendChild(sectionHeader('FACULTY'));
        facSorted.forEach(({firstName,lastName,personId})=>{
          frag.appendChild(addRow(`${firstName} ${lastName}`,'Submit',()=>submitPinOrId({ personId })));
        });
      }
      if (stuSorted.length){
        frag.appendChild(sectionHeader('STUDENTS'));
        stuSorted.forEach(({label, legacyId})=>{
          frag.appendChild(addRow(label,'Sign IN',()=>{
            if (!isInSelected()){ showToast('Students can only sign IN', 'bad'); chimeFail(); return; }
            const url = VC_BASE + encodeURIComponent(legacyId);
            window.open(url, '_blank', 'width=480,height=820,noopener,noreferrer');
            showToast(`${label} â€” sent to Veracross`, 'good'); chimeOk();
          }));
        });
      }

      resultsEl.innerHTML='';
      if (!facSorted.length && !stuSorted.length){
        resultsEl.innerHTML='<div class="muted">No matches found.</div>';
      } else {
        resultsEl.appendChild(frag);
      }
    } catch (e){
      if (e && e.name === 'AbortError') return;
      resultsEl.innerHTML='<div class="muted">Search failed.</div>';
    }
  }

  /* ===== Optional Web NFC (Android Chrome) ===== */
  function supportsWebNFC(){ return 'NDEFReader' in window; }
  if (supportsWebNFC()){
    const nfcBar = document.getElementById('nfcBar');
    const nfcStartBtn = document.getElementById('nfcStart');
    const nfcStopBtn  = document.getElementById('nfcStop');
    let ndef=null, nfcStarted=false;
    nfcBar.style.display='';

    nfcStartBtn.addEventListener('click', async ()=>{
      if (nfcStarted) return;
      try{
        ndef = new NDEFReader();
        await ndef.scan(); nfcStarted=true;
        showToast('NFC scanning started');
        nfcStartBtn.disabled=true; nfcStopBtn.disabled=false;

        ndef.onreadingerror = ()=> showToast('NFC read error â€” try again','bad');
        ndef.onreading = (event)=>{
          const { serialNumber } = event;
          const ten = normalizeTen(serialNumber);
          if (!ten || ten.length !== 10) { showToast('Card must resolve to 10 digits','bad'); chimeFail(); return; }
          submitPinOrId({ pin: ten });
        };
      }catch{
        showToast('NFC not permitted or unavailable','bad'); chimeFail();
      }
    });
    nfcStopBtn.addEventListener('click', ()=>{
      if (ndef){ ndef.onreading=null; ndef.onreadingerror=null; }
      nfcStarted=false; nfcStartBtn.disabled=false; nfcStopBtn.disabled=true;
      showToast('NFC stopped');
    });
  }

  /* ===== Init ===== */
  document.addEventListener('DOMContentLoaded', ()=>{
    initTheme();
    setAction('in');
    focusPin();
  });

  /* ===== Online status updates ===== */
  updateNet();
</script>
</body>
</html>
